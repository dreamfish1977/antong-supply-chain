<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®‰é€šä¾›åº”é“¾ç®¡ç†åå°</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Vue 3 (Global Build) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  
  <!-- SheetJS (XLSX) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  
  <style>
    body {
      background-color: #f3f4f6;
    }
    .menu-item {
      transition: all 0.2s;
    }
    .menu-item:hover {
      background-color: #f9fafb;
    }
    .menu-item.active {
      background-color: #fef3c7;
      border-left: 4px solid #f59e0b;
    }
    
    /* æ‰“å°æ ·å¼ */
    @media print {
      /* éšè—æ‰€æœ‰æ— å…³å…ƒç´  */
      body * {
        visibility: hidden;
      }
      
      /* åªæ˜¾ç¤ºæ‰“å°åŒºåŸŸåŠå…¶å­å…ƒç´  */
      #print-area, #print-area * {
        visibility: visible;
      }
      
      /* è°ƒæ•´æ‰“å°åŒºåŸŸä½ç½® */
      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 0;
        background: white;
      }
      
      /* éšè—å·¦ä¾§åˆ—è¡¨ã€ä¸Šä¼ åŒºã€æ“ä½œæŒ‰é’® */
      .sidebar, .top-bar, .action-buttons, .no-print,
      aside, header, nav {
        display: none !important;
        visibility: hidden !important;
      }
      
      /* éšè—æ‰“å°æŒ‰é’®å’Œæ“ä½œåŒºåŸŸ */
      .print\\:hidden, .no-print {
        display: none !important;
        visibility: hidden !important;
      }
      
      /* é¡µé¢åˆ†é¡µ */
      .print\\:page-break-before-always {
        page-break-before: always !important;
      }
      .print\\:break-before-page {
        break-before: page !important;
      }
      .a4-page {
        page-break-after: always;
      }
      
      /* ç¡®ä¿æ‰“å°åŒºåŸŸèƒŒæ™¯ä¸ºç™½è‰² */
      body {
        background-color: white;
        margin: 0;
        padding: 0;
      }
      
      /* ç¡®ä¿è¡¨æ ¼å’Œå†…å®¹æ­£å¸¸æ˜¾ç¤º */
      table {
        border-collapse: collapse;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="flex h-screen">
      <!-- å·¦ä¾§ä¾§è¾¹æ  -->
      <aside class="sidebar w-64 flex flex-col bg-white border-r border-gray-200">
        <!-- Logo åŒºåŸŸ -->
        <div class="p-6 border-b border-gray-200">
          <div class="text-xl font-bold text-orange-500">å®‰é€šä¾›åº”é“¾</div>
          <div class="text-sm text-gray-500 mt-1">ç®¡ç†åå°</div>
        </div>
        
        <!-- å¯¼èˆªèœå• -->
        <nav class="flex-1 py-4 overflow-y-auto">
          <div 
            v-for="(item, index) in filteredMenuItems" 
            :key="index"
            :class="['menu-item px-6 py-3 cursor-pointer', { active: currentMenu === item.id }]"
            @click="switchMenu(item.id)"
          >
            <div class="flex items-center gap-2">
              <span class="text-lg">{{ item.icon }}</span>
              <span class="text-sm">{{ item.name }}</span>
            </div>
          </div>
        </nav>
        
        <!-- å½“å‰è§’è‰²æ˜¾ç¤º -->
        <div class="p-4 border-t border-gray-200 text-sm text-gray-700">
          <div class="text-xs text-gray-500 mb-1">å½“å‰è§’è‰²</div>
          <div class="font-semibold text-gray-800">{{ getRoleName(currentUser.role) }}</div>
        </div>
      </aside>
      
      <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
      <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
        <!-- é¡¶éƒ¨æ  -->
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between shadow-sm">
          <h1 class="text-xl font-semibold text-gray-800">{{ currentMenuName }}</h1>
          <div class="flex items-center gap-4" @click.self="showRoleDropdown = false">
            <div class="flex items-center gap-2 relative" @click.stop>
              <div class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white text-sm font-semibold">
                {{ currentUser.name.charAt(0) }}
              </div>
              <div class="flex items-center gap-1 cursor-pointer" @click="showRoleDropdown = !showRoleDropdown">
                <span class="text-sm text-gray-600">{{ currentUser.name }}</span>
                <span class="text-xs text-gray-400">â–¼</span>
              </div>
              <!-- è§’è‰²åˆ‡æ¢ä¸‹æ‹‰èœå• -->
              <div
                v-if="showRoleDropdown"
                class="absolute top-full right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-50"
                @click.stop
              >
                <div class="py-1">
                  <div
                    @click="switchRole('admin')"
                    class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm text-gray-700"
                  >
                    åˆ‡æ¢ä¸ºï¼šç®¡ç†å‘˜
                  </div>
                  <div
                    @click="switchRole('role_a')"
                    class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm text-gray-700"
                  >
                    åˆ‡æ¢ä¸ºï¼šç”Ÿäº§ä¸“å‘˜ (A)
                  </div>
                  <div
                    @click="switchRole('role_b')"
                    class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm text-gray-700"
                  >
                    åˆ‡æ¢ä¸ºï¼šGEç‰©æµ (B)
                  </div>
                  <div
                    @click="switchRole('role_c')"
                    class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm text-gray-700"
                  >
                    åˆ‡æ¢ä¸ºï¼šç»¼åˆè´¢åŠ¡ (C)
                  </div>
                  <div
                    @click="switchRole('role_d')"
                    class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm text-gray-700"
                  >
                    åˆ‡æ¢ä¸ºï¼šæ”¶è´§å‘˜ (D)
                  </div>
                </div>
              </div>
            </div>
            <button 
              @click="logout"
              class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm transition text-gray-700"
            >
              é€€å‡ºç™»å½•
            </button>
          </div>
        </header>
        
        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="flex-1 overflow-auto p-6">
          <!-- ç»è¥æŠ¥è¡¨ -->
          <div v-if="currentMenu === 'dashboard'" class="h-full overflow-auto">
            <div class="p-6 space-y-6">
              <!-- KPI æ ¸å¿ƒæŒ‡æ ‡å¡ -->
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white rounded-xl border border-gray-200 shadow-md p-6 hover:shadow-lg transition">
                  <div class="text-sm text-gray-500 mb-2">å½“æœˆäº§é‡</div>
                  <div class="text-3xl font-bold text-gray-900">{{ formatNumber(biData.kpi.monthlyProduction) }}</div>
                  <div class="text-xs text-gray-400 mt-2">è¾ƒä¸Šæœˆ â†‘ 12.5%</div>
                </div>
                <div class="bg-white rounded-xl border border-gray-200 shadow-md p-6 hover:shadow-lg transition">
                  <div class="text-sm text-gray-500 mb-2">å¹³å‡ DPMO</div>
                  <div class="text-3xl font-bold text-blue-600">{{ biData.kpi.avgDPMO }}</div>
                  <div class="text-xs text-gray-400 mt-2">ç›®æ ‡å€¼: 80</div>
                </div>
                <div class="bg-white rounded-xl border border-gray-200 shadow-md p-6 hover:shadow-lg transition">
                  <div class="text-sm text-gray-500 mb-2">æ”¶è´§å‡†æ—¶ç‡</div>
                  <div class="text-3xl font-bold text-green-600">{{ biData.kpi.receivingOnTimeRate }}%</div>
                  <div class="text-xs text-gray-400 mt-2">è¾ƒä¸Šæœˆ â†‘ 0.3%</div>
                </div>
                <div class="bg-white rounded-xl border border-gray-200 shadow-md p-6 hover:shadow-lg transition">
                  <div class="text-sm text-gray-500 mb-2">æœ¬æœˆä¾›åº”å•†å¼‚å¸¸æ•°</div>
                  <div class="text-3xl font-bold text-orange-600">{{ biData.kpi.supplierIssues }}</div>
                  <div class="text-xs text-gray-400 mt-2">è¾ƒä¸Šæœˆ â†“ 8</div>
                </div>
              </div>

              <!-- å›¾è¡¨åŒºåŸŸ -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- å·¦ä¾§ï¼šäº§é‡è¶‹åŠ¿æŸ±çŠ¶å›¾ -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-md p-6">
                  <h3 class="text-lg font-semibold text-gray-800 mb-4">äº§é‡è¶‹åŠ¿å›¾</h3>
                  <div ref="chart1" style="width: 100%; height: 320px;"></div>
                </div>
                
                <!-- å³ä¾§ï¼šé—®é¢˜åˆ†å¸ƒé¥¼å›¾ -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-md p-6">
                  <h3 class="text-lg font-semibold text-gray-800 mb-4">ä¾›åº”å•†é—®é¢˜åˆ†å¸ƒ</h3>
                  <div ref="chart2" style="width: 100%; height: 320px;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- ç”Ÿäº§è®¡åˆ’ -->
          <div v-if="currentMenu === 'plan'" class="h-full">
            <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
              <div class="flex flex-col gap-4 mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div class="flex flex-col gap-1">
                    <h2 class="text-lg font-semibold text-gray-800">ç”Ÿäº§è®¡åˆ’åˆ—è¡¨</h2>
                    <div class="text-xs text-gray-500">
                      å…± {{ filteredProductionPlan.length }} æ¡è®°å½•
                    </div>
                  </div>
                  <div class="flex flex-col md:flex-row gap-3 md:items-center">
                    <!-- æŸ¥è¯¢ç­›é€‰ -->
                    <div class="flex gap-2">
                      <input
                        type="date"
                        v-model="planSearchDate"
                        class="bg-white border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded-lg px-3 py-2 text-sm text-gray-800 outline-none"
                        placeholder="é€‰æ‹©æ—¥æœŸ"
                      />
                      <input
                        type="text"
                        v-model="planSearchKeyword"
                        placeholder="æœå·¥å•å·/äº§å“/äº§çº¿"
                        class="bg-white border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded-lg px-4 py-2 text-sm text-gray-800 placeholder-gray-400 outline-none w-48"
                      />
                    </div>
                    <button 
                      @click="triggerPlanFileUpload"
                      class="px-4 py-2 bg-white border border-green-500 text-green-600 hover:bg-green-50 rounded-lg text-sm font-semibold transition whitespace-nowrap"
                    >
                      ğŸ“¤ å¯¼å…¥ Excel
                    </button>
                    <input
                      type="file"
                      ref="planFileInput"
                      accept=".xlsx,.xls"
                      @change="handlePlanFileUpload"
                      style="display: none;"
                    />
                    <button 
                      @click="refreshPlanData"
                      class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition text-white whitespace-nowrap"
                    >
                      åˆ·æ–°
                    </button>
                  </div>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-100 sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">åˆ°è¾¾æ—¥æœŸ</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">åˆ°è¾¾æ—¶é—´</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">è½¦æ¬¡</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å·¥å•å·</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">OP</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">äº§çº¿</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">äº§å“æè¿°</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">åŠ å·¥åºåˆ—å·</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">æ›´æ–°æ—¶é—´</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="filteredProductionPlan.length === 0" class="border-b border-gray-200">
                      <td colspan="9" class="px-4 py-8 text-center text-gray-500">æš‚æ— æ•°æ®ï¼Œè¯·ä¸Šä¼  Excel æ–‡ä»¶</td>
                    </tr>
                    <tr 
                      v-else
                      v-for="(item, index) in filteredProductionPlan" 
                      :key="index"
                      class="border-b border-gray-200 hover:bg-gray-50 transition"
                    >
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.arrival_date || item.åˆ°è¾¾æ—¥æœŸ || item.ä½¿ç”¨æ—¥æœŸ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ formatArrivalTime(item) }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.trip_no || item.è½¦æ¬¡ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.work_order || item.å·¥å•å· || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.op || item.å·¥åº || item.å·¥åºå· || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.line || item.äº§çº¿ || item.äº§çº¿åç§° || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.description || item.äº§å“æè¿° || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.seq_no || item.åŠ å·¥åºåˆ—å· || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.update_time || item.æ›´æ–°æ—¶é—´ || '--' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- å·¥å•ç®¡ç† -->
          <div v-if="currentMenu === 'work_order'" class="h-full">
            <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
              <h2 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“‹ å·¥å•ç®¡ç†</h2>
              <p class="text-gray-500">åŠŸèƒ½å¼€å‘ä¸­...</p>
            </div>
          </div>

          <!-- ä¾›åº”å•†æ”¶è´§ç›‘æ§ -->
          <div v-if="currentMenu === 'supplier_monitor'" class="h-full overflow-auto">
            <div class="p-6 space-y-4">
              <!-- é¡¶éƒ¨æ“ä½œæ  -->
              <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">ä¾›åº”å•†æ”¶è´§ç›‘æ§</h2>
                
                <!-- åŒè¡¨ä¸Šä¼ æ§åˆ¶åŒº -->
                <div class="flex flex-wrap items-center gap-3 bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4">
                  <div class="text-sm font-bold text-blue-800">ç³»ç»Ÿæ•°æ®å¯¹è´¦ï¼š</div>
                  
                  <button
                    @click="triggerTransactionLogUpload"
                    class="flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm"
                    :class="transactionLogFile ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'"
                  >
                    <span v-if="transactionLogFile">âœ… å·²é€‰: æµæ°´è¡¨</span>
                    <span v-else>ğŸ“„ 1. ä¸Šä¼ æ”¶è´§æµæ°´è¡¨</span>
                  </button>

                  <button
                    @click="triggerMappingTableUpload"
                    class="flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm"
                    :class="mappingTableFile ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'"
                  >
                    <span v-if="mappingTableFile">âœ… å·²é€‰: å…³ç³»è¡¨</span>
                    <span v-else>ğŸ”— 2. ä¸Šä¼ ç‰©æ–™å…³ç³»è¡¨</span>
                  </button>

                  <button
                    @click="startMatching"
                    class="flex items-center px-6 py-2 rounded-lg text-sm font-bold text-white transition-all shadow-md"
                    :disabled="!transactionLogFile || !mappingTableFile"
                    :class="(!transactionLogFile || !mappingTableFile) ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 hover:scale-105'"
                  >
                    ğŸš€ å¼€å§‹åŒ¹é…è®¡ç®—
                  </button>
                  
                  <input type="file" ref="transactionLogFileInput" accept=".xlsx,.xls" @change="handleTransactionLogUpload" class="hidden" />
                  <input type="file" ref="mappingTableFileInput" accept=".xlsx,.xls" @change="handleMappingTableUpload" class="hidden" />
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="flex items-center gap-3">
                  <input
                    type="text"
                    v-model="receivingSearchKeyword"
                    placeholder="ğŸ” æœç´¢ä¾›åº”å•†åç§°..."
                    class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-sm"
                  />
                  <div class="text-xs text-gray-500 px-2">
                    ğŸ’¡ æ•°æ®æ¥æºï¼šåˆ°è´§ç™»è®°æ¨¡å—
                  </div>
                  <button
                    @click="showHolidayModal = true"
                    class="px-4 py-2 bg-white border border-purple-600 text-purple-600 hover:bg-purple-50 rounded-lg text-sm font-medium"
                  >
                    ğŸ“… è®¾ç½®å‡æœŸ
                  </button>
                  <button
                    @click="exportSupplierReceivingToExcel"
                    class="px-4 py-2 bg-white border border-green-600 text-green-600 hover:bg-green-50 rounded-lg text-sm font-medium"
                  >
                    ğŸ“¤ å¯¼å‡º
                  </button>
                </div>
              </div>

              <!-- çŠ¶æ€ Tabs -->
              <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                <button
                  class="px-3 py-1.5 rounded-md text-sm font-medium transition-all"
                  :class="activeReceivingTab === 'ongoing' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                  @click="changeReceivingTab('ongoing')"
                >
                  è¿›è¡Œä¸­ / æœ‰ç§¯å‹
                </button>
                <button
                  class="px-3 py-1.5 rounded-md text-sm font-medium transition-all"
                  :class="activeReceivingTab === 'all' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                  @click="changeReceivingTab('all')"
                >
                  å…¨éƒ¨å†å²
                </button>
              </div>

              <!-- å¡ç‰‡åˆ—è¡¨ -->
              <div class="space-y-4">
                <div v-if="pagedReceivingTasks.length === 0" class="bg-white rounded-lg border border-gray-200 p-12 text-center text-gray-400">
                  æš‚æ— æ•°æ®
                </div>
                <div
                  v-for="(task, index) in pagedReceivingTasks"
                  :key="index"
                  class="bg-white border border-gray-200 rounded-xl shadow-sm p-5 hover:shadow-md transition-shadow"
                >
                  <div class="flex flex-col md:flex-row gap-6 items-center">
                    <div class="flex-1 w-full">
                      <h3 class="text-lg font-bold text-gray-900">{{ task.supplier_cn || task.ä¾›åº”å•†åç§° || 'æœªçŸ¥ä¾›åº”å•†' }}</h3>
                      <div v-if="task.supplier_en" class="px-2 py-0.5 bg-gray-100 text-gray-500 text-xs rounded mt-1 inline-block">{{ task.supplier_en }}</div>
                      <div class="mt-2 flex items-center gap-4 text-sm text-gray-600">
                        <span class="flex items-center gap-1 bg-orange-50 text-orange-700 px-2 py-1 rounded border border-orange-100">
                          ğŸ“¦ å®ç‰©: <strong>{{ task.physical_qty || task.å®ç‰©æ•°é‡ || 0 }}</strong> {{ task.unit || 'ä»¶' }}
                        </span>
                        <span class="text-gray-300">|</span>
                        <span>ğŸ“… {{ task.åˆ°è´§æ—¥æœŸ || task.date || '--' }}</span>
                      </div>
                    </div>
                    <div class="flex-1 w-full">
                      <div class="flex justify-between items-end mb-2">
                        <span class="text-sm font-medium text-gray-500">ç³»ç»Ÿæ•°æ®æ ¸å¯¹</span>
                        <!-- æœªç»“æ¡ˆï¼šæ˜¾ç¤ºç´¯è®¡æ•°ï¼ˆç®€æ´æ˜¾ç¤ºï¼‰ -->
                        <template v-if="!task.is_closed">
                          <span v-if="(task.system_data && task.system_data.total > 0) || (task.system_lines && task.system_lines > 0)" class="text-base font-bold text-blue-600">
                            å½“å‰ç³»ç»Ÿç´¯è®¡ï¼š{{ (task.system_data && task.system_data.total) || task.system_lines || 0 }} æ¡
                        </span>
                        <span v-else class="text-xs text-red-400 bg-red-50 px-2 py-1 rounded">
                            â³ ç­‰å¾…ç³»ç»Ÿæ•°æ®å¯¼å…¥...
                        </span>
                        </template>
                      </div>
                      <!-- æœªç»“æ¡ˆï¼šä¸æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œä¿æŒç®€æ´ -->
                      <!-- å·²ç»“æ¡ˆï¼šæ˜¾ç¤ºè¯¦ç»†çš„æ—¶æ•ˆåˆ†å¸ƒè¡¨æ ¼ -->
                      <template v-if="task.is_closed">
                        <!-- å¦‚æœ total > 0ï¼šæ˜¾ç¤ºçºµå‘ N/N+1 åˆ†å¸ƒè¡¨ -->
                        <div v-if="task.system_data && task.system_data.total > 0 && task.system_data.logs && task.system_data.logs.length > 0" class="w-full mt-2">
                          <table class="w-full text-xs border border-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                              <tr>
                                <th class="px-2 py-1.5 text-left font-semibold text-gray-700 border-b border-gray-200">æ”¶è´§æ—¥æœŸ</th>
                                <th class="px-2 py-1.5 text-left font-semibold text-gray-700 border-b border-gray-200">æ—¶æ•ˆåˆ†ç±»</th>
                                <th class="px-2 py-1.5 text-right font-semibold text-gray-700 border-b border-gray-200">æ”¶è´§æ¡æ•°</th>
                                <th class="px-2 py-1.5 text-right font-semibold text-gray-700 border-b border-gray-200">å æ¯”</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr 
                                v-for="(log, logIndex) in getSortedLogs(task)" 
                                :key="logIndex"
                                class="border-b border-gray-100 hover:bg-gray-50"
                              >
                                <td class="px-2 py-1.5 text-gray-800">{{ log.date === 'æœªçŸ¥æ—¥æœŸ' ? 'æœªçŸ¥æ—¥æœŸ' : log.date }}</td>
                                <td class="px-2 py-1.5">
                                  <span 
                                    class="px-2 py-0.5 rounded text-xs font-medium"
                                    :class="getTimelinessClass(log, task)"
                                  >
                                    {{ getTimelinessLabel(log, task) }}
                                  </span>
                                </td>
                                <td class="px-2 py-1.5 text-right text-gray-800 font-medium">{{ log.count }}</td>
                                <td class="px-2 py-1.5 text-right text-gray-600">
                                  {{ getLogPercentage(log, task) }}%
                                </td>
                              </tr>
                            </tbody>
                          </table>
                      </div>
                        <!-- å¦‚æœ total === 0ï¼šæ˜¾ç¤ºçº¢è‰²æ–‡å­—æç¤º -->
                        <div v-else class="w-full mt-2 text-xs text-red-600 text-center py-2 font-medium">
                          æœªåŒ¹é…åˆ°ç³»ç»Ÿæ•°æ®ï¼Œè¯·æ£€æŸ¥æ—¥æœŸæˆ–ä¾›åº”å•†åç§°
                        </div>
                      </template>
                    </div>
                    <div class="flex flex-row md:flex-col items-center md:items-end justify-between w-full md:w-auto gap-2">
                      <!-- ç»“æ¡ˆæŒ‰é’®ï¼ˆä»…æœªç»“æ¡ˆæ—¶æ˜¾ç¤ºï¼‰ -->
                      <button
                        v-if="!task.is_closed"
                        @click="closeReceivingTask(task)"
                        class="px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm font-medium transition-colors"
                      >
                        ğŸ ç»“æ¡ˆ
                      </button>
                      <!-- çŠ¶æ€æ˜¾ç¤º -->
                      <div v-if="task.status === 'è¶…æ—¶' || task.is_overdue" class="text-right">
                        <div class="text-red-600 font-bold">å·²è¶…æ—¶</div>
                        <div class="text-xs text-red-400">SLA 48h</div>
                      </div>
                      <div v-else-if="task.is_closed" class="px-3 py-1 bg-gray-200 text-gray-600 rounded-full text-xs font-bold">
                        å·²ç»“æ¡ˆ
                      </div>
                      <div v-else-if="(task.system_data && task.system_data.total > 0) || (task.system_lines && task.system_lines > 0)" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-bold">
                        æ­£å¸¸è¿›è¡Œä¸­
                      </div>
                      <div v-else class="px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">
                        å¾…å¯¹è´¦
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- åˆ†é¡µ -->
              <div v-if="receivingTotalPages > 1" class="flex justify-center items-center gap-2">
                <button
                  @click="receivingPage = Math.max(1, receivingPage - 1)"
                  :disabled="receivingPage === 1"
                  class="px-3 py-1 border border-gray-300 rounded text-sm"
                  :class="receivingPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'"
                >
                  ä¸Šä¸€é¡µ
                </button>
                <span class="text-sm text-gray-600">ç¬¬ {{ receivingPage }} / {{ receivingTotalPages }} é¡µ</span>
                <button
                  @click="receivingPage = Math.min(receivingTotalPages, receivingPage + 1)"
                  :disabled="receivingPage === receivingTotalPages"
                  class="px-3 py-1 border border-gray-300 rounded text-sm"
                  :class="receivingPage === receivingTotalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'"
                >
                  ä¸‹ä¸€é¡µ
                </button>
              </div>
            </div>

            <!-- ç™»è®°å®ç‰©å¼¹çª— -->
            <div v-if="showNewReceivingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="closeNewReceivingModal">
              <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ç™»è®°å®ç‰©</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¾›åº”å•†åç§° *</label>
                    <input
                      type="text"
                      v-model="newReceivingTask.ä¾›åº”å•†åç§°"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      placeholder="ä¾‹å¦‚: GEå·¥å‚"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åˆ°è´§æ—¥æœŸ *</label>
                    <input
                      type="datetime-local"
                      v-model="newReceivingTask.åˆ°è´§æ—¥æœŸ"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                    />
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">å®ç‰©æ•°é‡ *</label>
                      <input
                        type="number"
                        v-model.number="newReceivingTask.physical_qty"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">å•ä½</label>
                      <select v-model="newReceivingTask.unit" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="æ‰˜">æ‰˜</option>
                        <option value="ç®±">ç®±</option>
                        <option value="ä»¶">ä»¶</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
                    <textarea
                      v-model="newReceivingTask.å¤‡æ³¨"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      rows="2"
                    ></textarea>
                  </div>
                  <div class="flex justify-end gap-3 pt-4">
                    <button @click="closeNewReceivingModal" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">å–æ¶ˆ</button>
                    <button @click="saveReceivingTask" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm">ä¿å­˜</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- æœªçŸ¥ä¾›åº”å•†å¼¹çª— -->
            <div v-if="showUnknownSupplierModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showUnknownSupplierModal = false">
              <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">å…³è”ä¾›åº”å•†ä¸­æ–‡å</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è‹±æ–‡åç§°</label>
                    <input
                      type="text"
                      :value="currentAssociation ? currentAssociation.supplierEn : ''"
                      disabled
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-gray-100"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸­æ–‡åç§° *</label>
                    <div class="relative">
                      <input
                        type="text"
                        v-model="associationCnName"
                        list="supplierOptions"
                        @keyup.enter="saveUnknownSupplierMapping"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                        placeholder="è¯·é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥ä¸­æ–‡åç§°"
                      />
                      <datalist id="supplierOptions">
                        <option v-for="supplier in availableSuppliersForMapping" :key="supplier" :value="supplier">
                          {{ supplier }}
                        </option>
                      </datalist>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                      ğŸ’¡ æç¤ºï¼šå¯ç›´æ¥è¾“å…¥ä¸­æ–‡åï¼Œå¦‚æœç³»ç»Ÿä¸­ä¸å­˜åœ¨ï¼Œå°†è‡ªåŠ¨åˆ›å»ºåˆ°è´§ç™»è®°è®°å½•
                    </p>
                  </div>
                  <div class="flex justify-end gap-3 pt-4">
                    <button @click="showUnknownSupplierModal = false" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">è·³è¿‡</button>
                    <button @click="saveUnknownSupplierMapping" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">ä¿å­˜</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- å‡æœŸç®¡ç†å¼¹çª— -->
            <div v-if="showHolidayModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showHolidayModal = false">
              <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“… å‡æœŸç®¡ç†</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ·»åŠ å‡æœŸæ—¥æœŸ</label>
                    <input
                      type="date"
                      v-model="newHolidayDate"
                      @keyup.enter="addHoliday"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                    />
                    <button
                      @click="addHoliday"
                      class="mt-2 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm"
                    >
                      æ·»åŠ 
                    </button>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å·²è®¾ç½®çš„å‡æœŸ</label>
                    <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-2">
                      <div
                        v-if="holidays.length === 0"
                        class="text-sm text-gray-400 text-center py-4"
                      >
                        æš‚æ— å‡æœŸè®¾ç½®
                      </div>
                      <div
                        v-for="(holiday, index) in holidays"
                        :key="index"
                        class="flex items-center justify-between py-2 px-3 hover:bg-gray-50 rounded"
                      >
                        <span class="text-sm text-gray-700">{{ holiday }}</span>
                        <button
                          @click="removeHoliday(index)"
                          class="text-red-500 hover:text-red-700 text-sm"
                        >
                          åˆ é™¤
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="flex justify-end gap-3 pt-4">
                    <button @click="showHolidayModal = false" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">å…³é—­</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- åˆ°è´§å¼‚å¸¸ç®¡ç† -->
          <div v-if="currentMenu === 'inbound_error'" class="h-full">
            <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <h2 class="text-lg font-semibold text-gray-800">åˆ°è´§å¼‚å¸¸ç®¡ç†</h2>
                <div class="flex flex-col md:flex-row gap-3 md:items-center">
                  <div class="relative">
                    <input
                      type="text"
                      v-model="discrepancySearchKeyword"
                      placeholder="æœç´¢ä¾›åº”å•†/PO/ç‰©æ–™/åˆ†ç±»"
                      class="bg-white border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded-lg px-10 py-2 text-sm text-gray-800 placeholder-gray-400 outline-none w-64"
                    />
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">ğŸ”</span>
                  </div>
                  <button 
                    @click="openDiscrepancyModal"
                    class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-semibold text-white transition whitespace-nowrap"
                  >
                    + ç™»è®°å¼‚å¸¸
                  </button>
                  <button 
                    @click="triggerDiscrepancyImport"
                    class="px-4 py-2 bg-white border border-green-500 text-green-600 hover:bg-green-50 rounded-lg text-sm font-semibold transition whitespace-nowrap"
                  >
                    ğŸ“¥ å¯¼å…¥ Excel
                  </button>
                  <button 
                    @click="exportDiscrepancyToExcel"
                    class="px-4 py-2 bg-white border border-green-500 text-green-600 hover:bg-green-50 rounded-lg text-sm font-semibold transition whitespace-nowrap"
                  >
                    ğŸ“¤ å¯¼å‡º Excel
                  </button>
                  <input
                    type="file"
                    ref="discrepancyFileInput"
                    accept=".xlsx,.xls"
                    @change="handleDiscrepancyImport"
                    style="display: none;"
                  />
                  <button 
                    @click="refreshDiscrepancyData"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition text-white"
                  >
                    åˆ·æ–°
                  </button>
                </div>
              </div>

              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-100 sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">ç¼–å·</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">æ—¥æœŸ</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">ä¾›åº”å•†</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">ç‰©æ–™/æ•°é‡</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">è¡Œå·</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å¼‚å¸¸åˆ†ç±»</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">æè¿°</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">ä¿ç¨</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">çŠ¶æ€</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å¤„ç†æ—¶é•¿</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 whitespace-nowrap">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="filteredDiscrepancyList.length === 0" class="border-b border-gray-200">
                      <td colspan="11" class="px-4 py-8 text-center text-gray-500">æš‚æ— æ•°æ®</td>
                    </tr>
                    <tr 
                      v-else
                      v-for="(item, index) in filteredDiscrepancyList" 
                      :key="index"
                      class="border-b border-gray-200 hover:bg-gray-50 transition"
                    >
                      <td class="px-4 py-3 text-sm text-gray-800 max-w-[120px]">
                        <div class="truncate">{{ item.report_id || '--' }}</div>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.date || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.supplier || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">
                        <div class="flex flex-col">
                          <span>{{ item.material || '--' }}</span>
                          <span class="text-xs text-gray-500">æ•°é‡ï¼š{{ item.qty || 0 }}</span>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.line_no || '--' }}</td>
                      <td class="px-4 py-3 whitespace-nowrap">
                        <span class="status-badge px-2 py-1 rounded text-xs bg-blue-50 text-blue-700">{{ item.category || '--' }}</span>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">
                        <div class="max-w-xs truncate" :title="item.description || ''">
                          {{ item.description || '--' }}
                        </div>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.is_bonded ? 'æ˜¯' : 'å¦' }}</td>
                      <td class="px-4 py-3 whitespace-nowrap">
                        <span 
                          :class="[
                            'status-badge px-2 py-1 rounded text-xs',
                            item.status === 'å¾…å¤„ç†' ? 'bg-yellow-200 text-yellow-700' :
                            item.status === 'å¤„ç†ä¸­' ? 'bg-blue-200 text-blue-700' : 'bg-green-200 text-green-700'
                          ]"
                        >
                          {{ item.status || '--' }}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ getDiscrepancyDuration(item) }} å¤©</td>
                      <td class="px-4 py-3 text-center whitespace-nowrap">
                        <button 
                          v-if="item.status === 'å·²é—­ç¯'"
                          @click="viewDiscrepancyDetail(item)"
                          class="px-3 py-1 bg-gray-500 hover:bg-gray-600 rounded text-xs transition text-white whitespace-nowrap"
                        >
                          ğŸ“„ è¯¦æƒ…
                        </button>
                        <button 
                          v-else
                          @click="handleDiscrepancy(item, index)"
                          class="px-3 py-1 bg-blue-700 hover:bg-blue-800 rounded text-xs transition text-white whitespace-nowrap"
                        >
                          âš¡ å¤„ç†
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="mt-4 text-sm text-gray-500">
                å…± {{ filteredDiscrepancyList.length }} / {{ discrepancyList.length }} æ¡è®°å½•
              </div>
            </div>

            <!-- ç™»è®°å¼‚å¸¸å¼¹çª— -->
            <div v-if="showDiscrepancyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="closeDiscrepancyModal">
              <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ç™»è®°å¼‚å¸¸</h3>
                <div class="space-y-4">
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ *</label>
                      <input
                        type="date"
                        v-model="newDiscrepancy.date"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ä¾›åº”å•† *</label>
                      <input
                        type="text"
                        v-model="newDiscrepancy.supplier"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">POå· *</label>
                      <input
                        type="text"
                        v-model="newDiscrepancy.po"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">è¡Œå·</label>
                      <input
                        type="text"
                        v-model="newDiscrepancy.line_no"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ç‰©æ–™å· *</label>
                      <input
                        type="text"
                        v-model="newDiscrepancy.material"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">æ•°é‡ *</label>
                      <input
                        type="number"
                        v-model.number="newDiscrepancy.qty"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¼‚å¸¸åˆ†ç±» *</label>
                    <select v-model="newDiscrepancy.category" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                      <option value="ç³»ç»Ÿé—®é¢˜">ç³»ç»Ÿé—®é¢˜</option>
                      <option value="å•æ®é—®é¢˜">å•æ®é—®é¢˜</option>
                      <option value="å®ç‰©ç ´æŸ">å®ç‰©ç ´æŸ</option>
                      <option value="æ•°é‡å·®å¼‚">æ•°é‡å·®å¼‚</option>
                      <option value="æ ‡ç­¾é”™è¯¯">æ ‡ç­¾é”™è¯¯</option>
                      <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ˜¯å¦ä¿ç¨</label>
                    <select v-model="newDiscrepancy.is_bonded" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                      <option :value="false">å¦</option>
                      <option :value="true">æ˜¯</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æè¿° *</label>
                    <textarea
                      v-model="newDiscrepancy.description"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      rows="3"
                      placeholder="è¯¦ç»†æè¿°å¼‚å¸¸æƒ…å†µ"
                    ></textarea>
                  </div>
                  <div class="flex justify-end gap-3 pt-4">
                    <button @click="closeDiscrepancyModal" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">å–æ¶ˆ</button>
                    <button @click="saveDiscrepancy" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm">ä¿å­˜</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- å¤„ç†å¼‚å¸¸å¼¹çª— -->
            <div v-if="showDiscrepancyDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="closeDiscrepancyDetailModal">
              <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">å¤„ç†å¼‚å¸¸</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¤„ç†ç»“æœ *</label>
                    <textarea
                      v-model="discrepancyHandleResult"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      rows="4"
                      placeholder="è¯·è¾“å…¥å¤„ç†ç»“æœ"
                    ></textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¤„ç†çŠ¶æ€ *</label>
                    <select v-model="discrepancyHandleStatus" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                      <option value="å¤„ç†ä¸­">å¤„ç†ä¸­</option>
                      <option value="å·²é—­ç¯">å·²é—­ç¯</option>
                    </select>
                  </div>
                  <div class="flex justify-end gap-3 pt-4">
                    <button @click="closeDiscrepancyDetailModal" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">å–æ¶ˆ</button>
                    <button @click="saveDiscrepancyHandle" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">ä¿å­˜</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- è½¦æ¬¡ç®¡ç† -->
          <div v-if="currentMenu === 'vehicle'" class="h-full">
            <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <h2 class="text-lg font-semibold text-gray-800">è½¦æ¬¡ç®¡ç†åˆ—è¡¨</h2>
                <div class="flex flex-col md:flex-row gap-3 md:items-center">
                  <div class="relative">
                    <input
                      type="text"
                      v-model="vehicleSearchKeyword"
                      placeholder="æœç´¢å®¢æˆ·/å¸æœº/è½¦å‹"
                      class="bg-white border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded-lg px-10 py-2 text-sm text-gray-800 placeholder-gray-400 outline-none w-64"
                    />
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">ğŸ”</span>
                  </div>
                  <button 
                    @click="openVehicleModal"
                    class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-semibold text-white transition whitespace-nowrap"
                  >
                    + ç™»è®°è½¦æ¬¡
                  </button>
                  <button 
                    @click="triggerVehicleImport"
                    class="px-4 py-2 bg-white border border-green-500 text-green-600 hover:bg-green-50 rounded-lg text-sm font-semibold transition whitespace-nowrap"
                  >
                    ğŸ“¥ å¯¼å…¥ Excel
                  </button>
                  <button 
                    @click="exportVehicleLogToExcel"
                    class="px-4 py-2 bg-white border border-green-500 text-green-600 hover:bg-green-50 rounded-lg text-sm font-semibold transition whitespace-nowrap"
                  >
                    ğŸ“¤ å¯¼å‡º Excel
                  </button>
                  <input
                    type="file"
                    ref="vehicleLogFileInput"
                    accept=".xlsx,.xls"
                    @change="handleVehicleImport"
                    style="display: none;"
                  />
                  <button 
                    @click="refreshVehicleData"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition text-white"
                  >
                    åˆ·æ–°
                  </button>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-100 sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">æ—¥æœŸ</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">æ—¶é—´</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">è½¦å‹</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å¸æœºå§“å</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å®¢æˆ·åç§°</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å®¢æˆ·ç­¾æ”¶äºº</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å†…å®¹</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å¤‡æ³¨</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 whitespace-nowrap">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="filteredVehicleLog.length === 0" class="border-b border-gray-200">
                      <td colspan="9" class="px-4 py-8 text-center text-gray-500">æš‚æ— æ•°æ®</td>
                    </tr>
                    <tr 
                      v-else
                      v-for="(item, index) in filteredVehicleLog" 
                      :key="index"
                      class="border-b border-gray-200 hover:bg-gray-50 transition"
                    >
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.æ—¥æœŸ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.æ—¶é—´ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.è½¦å‹ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.å¸æœºå§“å || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.å®¢æˆ·åç§° || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.å®¢æˆ·ç­¾æ”¶äºº || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.å†…å®¹ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.å¤‡æ³¨ || '--' }}</td>
                      <td class="px-4 py-3 text-center whitespace-nowrap">
                        <button 
                          @click="deleteVehicleRecord(index)"
                          class="px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-xs transition text-white"
                        >
                          åˆ é™¤
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="mt-4 text-sm text-gray-500">
                å…± {{ filteredVehicleLog.length }} / {{ vehicleLog.length }} æ¡è®°å½•
              </div>
            </div>

            <!-- ç™»è®°è½¦æ¬¡å¼¹çª— -->
            <div v-if="showVehicleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="closeVehicleModal">
              <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ç™»è®°è½¦æ¬¡</h3>
                <div class="space-y-4">
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ *</label>
                      <input
                        type="date"
                        v-model="newVehicleLog.æ—¥æœŸ"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">æ—¶é—´ *</label>
                      <input
                        type="time"
                        v-model="newVehicleLog.æ—¶é—´"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">è½¦å‹ *</label>
                      <input
                        type="text"
                        v-model="newVehicleLog.è½¦å‹"
                        list="vehicleTypeOptions"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                        placeholder="é€‰æ‹©æˆ–è¾“å…¥è½¦å‹"
                      />
                      <datalist id="vehicleTypeOptions">
                        <option value="SUV">SUV</option>
                        <option value="9.6æ¿è½¦">9.6æ¿è½¦</option>
                        <option value="9.6ç®±è´§">9.6ç®±è´§</option>
                        <option value="4.2ç®±è´§">4.2ç®±è´§</option>
                      </datalist>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">å¸æœºå§“å *</label>
                      <input
                        type="text"
                        v-model="newVehicleLog.å¸æœºå§“å"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ·åç§° *</label>
                      <input
                        type="text"
                        v-model="newVehicleLog.å®¢æˆ·åç§°"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ·ç­¾æ”¶äºº</label>
                      <input
                        type="text"
                        v-model="newVehicleLog.å®¢æˆ·ç­¾æ”¶äºº"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å†…å®¹ *</label>
                    <input
                      type="text"
                      v-model="newVehicleLog.å†…å®¹"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      placeholder="ä¾‹å¦‚: é€è´§"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
                    <textarea
                      v-model="newVehicleLog.å¤‡æ³¨"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      rows="2"
                    ></textarea>
                  </div>
                  <div class="flex justify-end gap-3 pt-4">
                    <button @click="closeVehicleModal" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">å–æ¶ˆ</button>
                    <button @click="saveVehicleLog" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm">ä¿å­˜</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- å·¥å•é…æ–™ -->
          <div v-if="currentMenu === 'kitting'" class="h-full overflow-auto">
            <div class="p-6 space-y-6">
              <!-- é¡¶éƒ¨æ“ä½œåŒº -->
              <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                  <!-- ä¸Šä¼ ç”Ÿäº§è®¡åˆ’è¡¨ -->
                  <div class="flex-1 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-orange-500 transition cursor-pointer bg-gray-50">
                    <input
                      type="file"
                      ref="planFileInputKitting"
                      accept=".xlsx,.xls"
                      @change="handlePlanFileUploadKitting"
                      class="hidden"
                    />
                    <div @click="triggerPlanFileUploadKitting" class="cursor-pointer">
                      <div class="text-2xl mb-2">ğŸ“¤</div>
                      <div class="text-sm font-semibold text-gray-700 mb-1">ä¸Šä¼ ç”Ÿäº§è®¡åˆ’è¡¨</div>
                      <div class="text-xs text-gray-500">å·¥å•å·, å·¥åº, åˆ°è¾¾æ—¶é—´</div>
                      <div v-if="planData.length > 0" class="text-xs text-green-600 mt-2">
                        âœ… å·²åŠ è½½ {{ planData.length }} æ¡è®°å½•
                      </div>
                    </div>
                  </div>
                  
                  <!-- ä¸Šä¼  GE BOMæºè¡¨ -->
                  <div class="flex-1 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition cursor-pointer bg-gray-50">
                    <input
                      type="file"
                      ref="bomFileInput"
                      accept=".xlsx,.xls"
                      @change="handleBomFileUpload"
                      class="hidden"
                    />
                    <div @click="triggerBomFileUpload" class="cursor-pointer">
                      <div class="text-2xl mb-2">ğŸ“¤</div>
                      <div class="text-sm font-semibold text-gray-700 mb-1">ä¸Šä¼  GE BOMæºè¡¨</div>
                      <div class="text-xs text-gray-500">Job, OP, Component, å™¨å…·, å®é™…æ•°é‡</div>
                      <div v-if="bomData.length > 0" class="text-xs text-green-600 mt-2">
                        âœ… å·²åŠ è½½ {{ bomData.length }} æ¡è®°å½•
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- çŠ¶æ€æç¤º -->
                <div class="mt-4 text-center">
                  <div v-if="planData.length === 0 && bomData.length === 0" class="text-sm text-gray-500">
                    ç­‰å¾…ä¸Šä¼ ...
                  </div>
                  <div v-else-if="matchedWorkOrders.length > 0" class="text-sm text-green-600 font-semibold">
                    âœ… å·²åŒ¹é… {{ matchedWorkOrders.length }} ä¸ªå·¥å•
                  </div>
                  <div v-else class="text-sm text-orange-600">
                    âš ï¸ è¯·ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶ä»¥è¿›è¡ŒåŒ¹é…
                  </div>
                </div>
              </div>

              <!-- æ ¸å¿ƒäº¤äº’åŒº -->
              <div v-if="matchedWorkOrders.length > 0" class="flex gap-6">
                <!-- å·¦ä¾§ï¼šå·¥å•åˆ—è¡¨ (30%) -->
                <div class="w-[30%] bg-white rounded-lg border border-gray-200 shadow-sm">
                  <div class="p-4 border-b border-gray-200">
                    <div class="space-y-3">
                      <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-gray-800">å·¥å•åˆ—è¡¨</h3>
                        <span class="text-xs text-gray-500">æ€»è®¡ï¼š{{ groupedWorkOrderList.length }} æ¡</span>
                      </div>
                      <!-- æŒ‰æ—¥æœŸç­›é€‰ -->
                      <div class="flex items-center gap-2">
                        <label class="text-xs text-gray-600 whitespace-nowrap">ä½¿ç”¨æ—¥æœŸï¼š</label>
                        <input
                          type="date"
                          v-model="pickingSearchDate"
                          class="flex-1 border border-gray-300 rounded-md px-2 py-1 text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-blue-500"
                        />
                        <button
                          type="button"
                          class="px-2 py-1 text-[11px] border border-gray-300 rounded-md text-gray-600 hover:bg-gray-50"
                          @click="pickingSearchDate = ''"
                        >
                          æ¸…ç©º
                        </button>
                      </div>
                      <!-- é¡¹ç›®ç±»å‹ç­›é€‰ -->
                      <div class="flex items-center gap-2">
                        <label class="text-xs text-gray-600 whitespace-nowrap">é¡¹ç›®ç±»å‹ï¼š</label>
                        <select
                          v-model="pickingProjectType"
                          class="flex-1 border border-gray-300 rounded-md px-2 py-1 text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-blue-500"
                        >
                          <option value="å…¨éƒ¨é¡¹ç›®">å…¨éƒ¨é¡¹ç›®</option>
                          <option value="Pitch">Pitch</option>
                          <option value="SA14">SA14</option>
                          <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="max-h-[calc(100vh-300px)] overflow-y-auto">
                    <div
                      v-for="(group, index) in groupedWorkOrderList"
                      :key="index"
                      @click="selectWorkOrder(index)"
                      :class="[
                        'p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition',
                        selectedWorkOrderIndex === index ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''
                      ]"
                    >
                      <!-- æ—¶é—´ç»„å¡ç‰‡ (Pitch) -->
                      <template v-if="group.type === 'time_group'">
                        <div class="flex items-center gap-2">
                          <span class="text-lg">ğŸ•’</span>
                          <div class="flex-1">
                            <div class="text-sm font-semibold text-blue-600">
                              {{ group.displayTitle }}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                              {{ group.displayDesc }}
                            </div>
                            <div 
                              class="text-xs mt-1"
                              :class="(group.matchedBomCount || 0) === 0 ? 'text-red-500 font-semibold' : 'text-gray-500'"
                            >
                              åŒ¹é…: {{ group.matchedBomCount || 0 }} æ¡
                            </div>
                          </div>
                        </div>
                      </template>
                      
                      <!-- å™¨å…·ç»„å¡ç‰‡ (SA14) -->
                      <template v-else-if="group.type === 'tool_group'">
                        <div class="flex items-center gap-2">
                          <span class="text-lg">ğŸ”§</span>
                          <div class="flex-1">
                            <div class="text-sm font-semibold text-gray-900">
                              {{ group.displayTitle }}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                              {{ group.displayDesc }}
                            </div>
                            <div 
                              class="text-xs mt-1"
                              :class="(group.matchedBomCount || 0) === 0 ? 'text-red-500 font-semibold' : 'text-gray-500'"
                            >
                              åŒ¹é…: {{ group.matchedBomCount || 0 }} æ¡
                            </div>
                          </div>
                        </div>
                      </template>
                      
                      <!-- å·¥å•ç»„å¡ç‰‡ (å…¶ä»–) -->
                      <template v-else-if="group.type === 'work_order_group'">
                        <div class="flex items-center gap-2">
                          <span class="text-lg">ğŸ“„</span>
                          <div class="flex-1">
                            <div class="text-sm font-semibold text-gray-900">
                              {{ group.displayTitle }}
                            </div>
                            <div class="text-xs text-gray-600 mt-1">
                              {{ group.displayDesc }}
                            </div>
                            <div 
                              class="text-xs mt-1"
                              :class="(group.matchedBomCount || 0) === 0 ? 'text-red-500 font-semibold' : 'text-gray-500'"
                            >
                              åŒ¹é…: {{ group.matchedBomCount || 0 }} æ¡
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                  <!-- æ‰¹é‡æ‰“å°å’Œå¯¼å‡ºæŒ‰é’® -->
                  <div class="p-4 border-t border-gray-200 space-y-2">
                    <button
                      @click="generateBatchPrint"
                      :disabled="groupedWorkOrderList.length === 0"
                      class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg text-sm font-semibold transition"
                    >
                      ğŸ–¨ï¸ æ‰¹é‡æ‰“å°ç­›é€‰ç»“æœ ({{ groupedWorkOrderList.length }})
                    </button>
                    <button
                      @click="exportToExcel"
                      :disabled="groupedWorkOrderList.length === 0"
                      class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg text-sm font-semibold transition"
                    >
                      ğŸ“¥ å¯¼å‡ºç­›é€‰ç»“æœ ({{ groupedWorkOrderList.length }})
                    </button>
                  </div>
                </div>

                <!-- å³ä¾§ï¼šè¯¦æƒ…/æ‰“å°åŒº (70%) -->
                <div class="flex-1 bg-white rounded-lg border border-gray-200 shadow-sm p-6">
                  <!-- æ‰¹é‡æ‰“å°é¢„è§ˆåŒºåŸŸ -->
                  <div v-if="batchPrintPages.length > 0" id="print-area" class="print-area batch-print-area">
                    <!-- æ‰“å°æŒ‰é’® -->
                    <div class="flex justify-end mb-4 print:hidden">
                      <button
                        @click="printBatchWorkOrders"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold transition"
                      >
                        ğŸ–¨ï¸ æ‰“å°å…¨éƒ¨ ({{ batchPrintPages.length }} é¡µ)
                      </button>
                    </div>
                    
                    <!-- A4 å•æ®æ ·å¼ - æ‰¹é‡æ‰“å°æ¨¡æ¿ -->
                    <div
                      v-for="(page, pageIdx) in batchPrintPages"
                      :key="pageIdx"
                      class="a4-page bg-white shadow-lg p-8"
                      :style="getBatchPrintPageStyle(page, pageIdx)"
                    >
                      <!-- ç»Ÿä¸€å¤´éƒ¨ï¼šä¸»æ ‡é¢˜ï¼ˆç‰¹å¤§å·ï¼Œå±…ä¸­ï¼‰ -->
                      <h1 class="text-4xl font-bold text-center text-gray-900 mb-4">{{ page.title }}</h1>
                      
                      <!-- å‰¯æ ‡é¢˜ï¼šå·¥åºï¼ˆä»…æ™®é€šäº§å“æ˜¾ç¤ºï¼‰ -->
                      <h2 v-if="page.info.op" class="text-2xl font-semibold text-center text-gray-700 mb-6">å·¥åº: {{ page.info.op }}</h2>
                      
                      <!-- ç»Ÿä¸€å¤´éƒ¨ï¼šæ‰“å°æ—¶é—´ -->
                      <div class="info-row mb-6">
                        <div class="space-y-1 text-sm text-gray-700">
                          <div><span class="font-semibold">æ‰“å°æ—¶é—´ï¼š</span>{{ printTime || '--' }}</div>
                        </div>
                      </div>
                      
                        <!-- ECO è­¦ç¤ºè¯­ -->
                      <div v-if="page.info.hasEco" class="mb-4 p-3 bg-red-50 border-l-4 border-red-500 rounded">
                          <div class="flex items-center text-red-700 font-semibold">
                            <span class="text-lg mr-2">âš ï¸</span>
                            <span>æ³¨æ„ï¼šæœ¬å•åŒ…å« ECO å˜æ›´ï¼Œè¯·æ ¸å¯¹ç‰©æ–™ï¼</span>
                          </div>
                        </div>
                      
                      <!-- ç»Ÿä¸€è¡¨æ ¼æ ·å¼ -->
                            <table class="w-full border-collapse border border-gray-300 text-sm">
                              <thead>
                                <tr class="bg-gray-100">
                                  <th class="border border-gray-300 px-3 py-2 text-left font-semibold">åºå·</th>
                                  <th class="border border-gray-300 px-3 py-2 text-left font-semibold">äº§å“</th>
                                  <th class="border border-gray-300 px-3 py-2 text-left font-semibold">å°å¥—</th>
                                  <th class="border border-gray-300 px-3 py-2 text-left font-semibold">å·¥åº(OP)</th>
                                  <th class="border border-gray-300 px-3 py-2 text-left font-semibold">ç‰©æ–™å·</th>
                                  <th class="border border-gray-300 px-3 py-2 text-left font-semibold">åº“ä½</th>
                                  <th class="border border-gray-300 px-3 py-2 text-left font-semibold">æ•°é‡</th>
                                  <th class="border border-gray-300 px-3 py-2 text-left font-semibold">å™¨å…·</th>
                                  <th class="border border-gray-300 px-3 py-2 text-left font-semibold">ECOå˜æ›´</th>
                                  <th class="border border-gray-300 px-3 py-2 text-left font-semibold">å¤‡æ³¨</th>
                                </tr>
                              </thead>
                              <tbody>
                          <tr v-if="!page.materials || page.materials.length === 0">
                            <td colspan="10" class="border border-gray-300 px-3 py-4 text-center text-gray-500">
                              æš‚æ— ç‰©æ–™æ˜ç»†
                            </td>
                          </tr>
                                <tr
                            v-else
                            v-for="(material, idx) in page.materials"
                                  :key="idx"
                                  :class="material.ecoInfo && material.ecoInfo.ecoNo ? 'bg-red-50' : ''"
                                >
                                  <td class="border border-gray-300 px-3 py-2">{{ idx + 1 }}</td>
                                  <td class="border border-gray-300 px-3 py-2">{{ material._description || '--' }}</td>
                                  <td class="border border-gray-300 px-3 py-2">{{ (material._seq_no || '').toString().slice(-4) || '--' }}</td>
                                  <td class="border border-gray-300 px-3 py-2">{{ material._op || '--' }}</td>
                                  <td class="border border-gray-300 px-3 py-2 font-semibold">{{ material.Component || material['Component'] || '--' }}</td>
                                  <td class="border border-gray-300 px-3 py-2">{{ material.PENDING_LOCATOR || material['PENDING_LOCATOR'] || '--' }}</td>
                                  <td class="border border-gray-300 px-3 py-2">{{ material.Required || material['Required'] || '--' }}</td>
                            <td class="border border-gray-300 px-3 py-2">{{ material.tool_type || material['tool_type'] || '--' }}</td>
                                  <td class="border border-gray-300 px-3 py-2">
                                    <div v-if="material.ecoInfo && material.ecoInfo.ecoNo" class="text-red-600 font-bold">
                                      ECO-{{ material.ecoInfo.ecoNo }}
                                      <div v-if="material.ecoInfo.changeDetails" class="text-xs mt-1 font-normal">
                                        {{ material.ecoInfo.changeDetails }}
                                      </div>
                                    </div>
                                    <span v-else class="text-gray-400">--</span>
                                  </td>
                                  <td class="border border-gray-300 px-3 py-2">{{ material.remark || material['å¤‡æ³¨'] || '--' }}</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                  </div>
                  
                  <!-- å•ä¸ªå·¥å•è¯¦æƒ…é¢„è§ˆ -->
                  <div v-else-if="selectedWorkOrder" id="print-area" class="print-area">
                    <!-- æ‰“å°æŒ‰é’® -->
                    <div class="flex justify-end mb-4 print:hidden">
                      <button
                        @click="printWorkOrder"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold transition"
                      >
                        ğŸ–¨ï¸ æ‰“å°å½“å‰å•æ®
                      </button>
                          </div>
                    
                    <!-- A4 å•æ®æ ·å¼ - ç»Ÿä¸€æ‰“å°æ¨¡æ¿ -->
                    <template v-if="printPages.length > 0">
                      <div
                        v-for="(page, pageIdx) in printPages"
                        :key="pageIdx"
                        class="a4-page bg-white shadow-lg p-8"
                        :style="pageIdx > 0 ? 'page-break-before: always;' : ''"
                      >
                        <!-- ç»Ÿä¸€å¤´éƒ¨ï¼šä¸»æ ‡é¢˜ï¼ˆç‰¹å¤§å·ï¼Œå±…ä¸­ï¼‰ -->
                        <h1 class="text-4xl font-bold text-center text-gray-900 mb-4">{{ page.title }}</h1>
                        
                        <!-- å‰¯æ ‡é¢˜ï¼šå·¥åºï¼ˆä»…æ™®é€šäº§å“æ˜¾ç¤ºï¼‰ -->
                        <h2 v-if="page.info.op" class="text-2xl font-semibold text-center text-gray-700 mb-6">å·¥åº: {{ page.info.op }}</h2>
                        
                        <!-- ç»Ÿä¸€å¤´éƒ¨ï¼šæ‰“å°æ—¶é—´ -->
                        <div class="info-row mb-6">
                          <div class="space-y-1 text-sm text-gray-700">
                            <div><span class="font-semibold">æ‰“å°æ—¶é—´ï¼š</span>{{ printTime || '--' }}</div>
                          </div>
                        </div>
                        
                        <!-- ECO è­¦ç¤ºè¯­ -->
                        <div v-if="page.info.hasEco" class="mb-4 p-3 bg-red-50 border-l-4 border-red-500 rounded">
                          <div class="flex items-center text-red-700 font-semibold">
                            <span class="text-lg mr-2">âš ï¸</span>
                            <span>æ³¨æ„ï¼šæœ¬å•åŒ…å« ECO å˜æ›´ï¼Œè¯·æ ¸å¯¹ç‰©æ–™ï¼</span>
                          </div>
                        </div>
                        
                        <!-- ç»Ÿä¸€è¡¨æ ¼æ ·å¼ -->
                        <table class="w-full border-collapse border border-gray-300 text-sm">
                          <thead>
                            <tr class="bg-gray-100">
                              <th class="border border-gray-300 px-3 py-2 text-left font-semibold">åºå·</th>
                              <th class="border border-gray-300 px-3 py-2 text-left font-semibold">äº§å“</th>
                              <th class="border border-gray-300 px-3 py-2 text-left font-semibold">å°å¥—</th>
                              <th class="border border-gray-300 px-3 py-2 text-left font-semibold">å·¥åº(OP)</th>
                              <th class="border border-gray-300 px-3 py-2 text-left font-semibold">ç‰©æ–™å·</th>
                              <th class="border border-gray-300 px-3 py-2 text-left font-semibold">åº“ä½</th>
                              <th class="border border-gray-300 px-3 py-2 text-left font-semibold">æ•°é‡</th>
                              <th class="border border-gray-300 px-3 py-2 text-left font-semibold">å™¨å…·</th>
                              <th class="border border-gray-300 px-3 py-2 text-left font-semibold">ECOå˜æ›´</th>
                              <th class="border border-gray-300 px-3 py-2 text-left font-semibold">å¤‡æ³¨</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr v-if="!page.materials || page.materials.length === 0">
                              <td colspan="10" class="border border-gray-300 px-3 py-4 text-center text-gray-500">
                                æš‚æ— ç‰©æ–™æ˜ç»†
                              </td>
                            </tr>
                            <tr
                              v-else
                              v-for="(material, idx) in page.materials"
                              :key="idx"
                              :class="material.ecoInfo && material.ecoInfo.ecoNo ? 'bg-red-50' : ''"
                            >
                              <td class="border border-gray-300 px-3 py-2">{{ idx + 1 }}</td>
                              <td class="border border-gray-300 px-3 py-2">{{ material._description || '--' }}</td>
                              <td class="border border-gray-300 px-3 py-2">{{ (material._seq_no || '').toString().slice(-4) || '--' }}</td>
                              <td class="border border-gray-300 px-3 py-2">{{ material._op || '--' }}</td>
                              <td class="border border-gray-300 px-3 py-2 font-semibold">{{ material.Component || material['Component'] || '--' }}</td>
                              <td class="border border-gray-300 px-3 py-2">{{ material.PENDING_LOCATOR || material['PENDING_LOCATOR'] || '--' }}</td>
                              <td class="border border-gray-300 px-3 py-2">{{ material.Required || material['Required'] || '--' }}</td>
                              <td class="border border-gray-300 px-3 py-2">{{ material.tool_type || material['tool_type'] || '--' }}</td>
                              <td class="border border-gray-300 px-3 py-2">
                                <div v-if="material.ecoInfo && material.ecoInfo.ecoNo" class="text-red-600 font-bold">
                                  ECO-{{ material.ecoInfo.ecoNo }}
                                  <div v-if="material.ecoInfo.changeDetails" class="text-xs mt-1 font-normal">
                                    {{ material.ecoInfo.changeDetails }}
                                  </div>
                                </div>
                                <span v-else class="text-gray-400">--</span>
                              </td>
                              <td class="border border-gray-300 px-3 py-2">{{ material.remark || material['å¤‡æ³¨'] || '--' }}</td>
                            </tr>
                          </tbody>
                        </table>
                          </div>
                      </template>
                    <div v-else class="a4-page bg-white shadow-lg p-8">
                      <div class="text-center text-gray-500 py-12">
                        æš‚æ— æ‰“å°æ•°æ®
                    </div>
                  </div>
                          </div>
                  
                  <div v-else-if="!selectedWorkOrder" class="text-center text-gray-500 py-12">
                    è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå·¥å•æŸ¥çœ‹è¯¦æƒ…
                  </div>
                </div>
              </div>

              <!-- ç©ºçŠ¶æ€ -->
              <div v-else class="bg-white rounded-lg border border-gray-200 p-12 text-center">
                <div class="text-gray-400 text-lg mb-2">ğŸ“‹</div>
                <div class="text-gray-600">è¯·ä¸Šä¼ ç”Ÿäº§è®¡åˆ’è¡¨å’Œ GE BOMæºè¡¨ä»¥å¼€å§‹åŒ¹é…</div>
              </div>
            </div>
          </div>

          <!-- ç¼ºé™·ç®¡ç† -->
          <div v-if="currentMenu === 'defects'" class="h-full">
            <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <h2 class="text-lg font-semibold text-gray-800">ç¼ºé™·ç®¡ç†åˆ—è¡¨</h2>
                <div class="flex flex-wrap gap-3 items-center">
                  <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-600 whitespace-nowrap">æœˆä»½ï¼š</label>
                    <input
                      type="month"
                      v-model="defectFilterMonth"
                      class="border border-gray-300 rounded-lg px-2 py-1 text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-blue-500"
                    />
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-600 whitespace-nowrap">ç±»å‹ï¼š</label>
                    <select
                      v-model="defectFilterType"
                      class="border border-gray-300 rounded-lg px-2 py-1 text-xs text-gray-800 bg-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                    >
                      <option value="">å…¨éƒ¨</option>
                      <option value="Bç±»">Bç±»</option>
                      <option value="Cç±»">Cç±»</option>
                    </select>
                  </div>
                  <button
                    @click="openDefectModal"
                    class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-semibold text-white transition"
                  >
                    + ç™»è®°ç¼ºé™·
                  </button>
                  <button
                    @click="triggerDefectImport"
                    class="px-4 py-2 bg-white hover:bg-gray-50 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 transition"
                  >
                    ğŸ“¥ å¯¼å…¥ Excel
                  </button>
                  <input
                    type="file"
                    ref="defectFileInput"
                    accept=".xlsx,.xls"
                    @change="handleDefectImport"
                    style="display: none;"
                  />
                  <button 
                    @click="refreshDefectData"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition text-white"
                  >
                    åˆ·æ–°
                  </button>
                </div>
              </div>
              
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-100 sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å‘ç°æ—¥æœŸ</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">ç±»å‹</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">ç§ç±»</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">æ˜¯å¦æŒ‰ç¯</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">äº§å“</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">é—®é¢˜æè¿°</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å‘ç°äºº</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">è´£ä»»äºº</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">åŸå› </th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">è§£å†³æ–¹æ¡ˆ</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">5WHYåˆ†æ</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å¤‡æ³¨</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="filteredDefectList.length === 0" class="border-b border-gray-200">
                      <td colspan="12" class="px-4 py-8 text-center text-gray-500">æš‚æ— ç¼ºé™·è®°å½•</td>
                    </tr>
                    <tr 
                      v-else
                      v-for="(item, index) in filteredDefectList" 
                      :key="index"
                      class="border-b border-gray-200 hover:bg-gray-50 transition"
                    >
                      <td 
                        class="px-4 py-3 text-sm whitespace-nowrap"
                        :class="getDefectDurationClass(item)"
                      >
                        {{ item.å‘ç°æ—¥æœŸ || '--' }}
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap">
                        <span 
                          :class="[
                            'status-badge px-2 py-1 rounded text-xs',
                            item.ç±»å‹ === 'Bç±»' ? 'bg-yellow-50 text-yellow-700 border border-yellow-200' : 'bg-blue-50 text-blue-700 border border-blue-200'
                          ]"
                        >
                          {{ item.ç±»å‹ || '--' }}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.ç§ç±» || '--' }}</td>
                      <td class="px-4 py-3 whitespace-nowrap">
                        <span v-if="item.æ˜¯å¦æŒ‰ç¯" class="text-red-600 font-medium">ğŸ’¡ æ˜¯</span>
                        <span v-else class="text-gray-400">å¦</span>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.äº§å“ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800" :title="item.é—®é¢˜æè¿°">
                        <div class="max-w-xs truncate">{{ item.é—®é¢˜æè¿° || '--' }}</div>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.å‘ç°äºº || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.è´£ä»»äºº || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800" :title="item.åŸå› ">
                        <div class="max-w-xs truncate">{{ item.åŸå›  || '--' }}</div>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800" :title="item.è§£å†³æ–¹æ¡ˆ">
                        <div class="max-w-xs truncate">{{ item.è§£å†³æ–¹æ¡ˆ || '--' }}</div>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap">
                        <a 
                          v-if="item['5WHYæ–‡ä»¶']" 
                          href="#" 
                          @click.prevent="view5WhyReport(item['5WHYæ–‡ä»¶'])"
                          class="text-blue-600 hover:text-blue-800 text-sm underline"
                        >
                          ğŸ“„ ä¸‹è½½æŠ¥å‘Š
                        </a>
                        <span 
                          v-else-if="item.æ˜¯å¦æŒ‰ç¯" 
                          @click="upload5WhyFile(item)"
                          class="text-red-600 cursor-pointer hover:underline text-sm"
                        >
                          å¾…ä¸Šä¼ 
                        </span>
                        <span v-else class="text-gray-400">--</span>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800" :title="item.å¤‡æ³¨">
                        <div class="max-w-xs truncate">{{ item.å¤‡æ³¨ || '--' }}</div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div class="mt-4 text-sm text-gray-500">
                <span>æ€»è®¡ï¼š{{ defectList.length }} æ¡</span>
                <span v-if="filteredDefectList.length !== defectList.length" class="ml-3 text-blue-600">
                  å½“å‰ç­›é€‰ï¼š{{ filteredDefectList.length }} æ¡
                </span>
              </div>
            </div>

            <!-- ç™»è®°ç¼ºé™·å¼¹çª— -->
            <div v-if="showDefectModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="closeDefectModal">
              <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ç™»è®°ç¼ºé™·</h3>
                <div class="space-y-4">
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">å‘ç°æ—¥æœŸ *</label>
                      <input
                        type="date"
                        v-model="newDefect.å‘ç°æ—¥æœŸ"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ç±»å‹ *</label>
                      <select v-model="newDefect.ç±»å‹" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="Bç±»">Bç±»</option>
                        <option value="Cç±»">Cç±»</option>
                      </select>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ç§ç±» *</label>
                      <input
                        type="text"
                        v-model="newDefect.ç§ç±»"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                        placeholder="ä¾‹å¦‚: æ¼é…"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">äº§å“ *</label>
                      <input
                        type="text"
                        v-model="newDefect.äº§å“"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                        placeholder="ä¾‹å¦‚: TB"
                      />
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ˜¯å¦æŒ‰ç¯ *</label>
                    <select v-model="newDefect.æ˜¯å¦æŒ‰ç¯" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                      <option :value="false">å¦</option>
                      <option :value="true">æ˜¯</option>
                    </select>
                  </div>
                  <div v-if="newDefect.æ˜¯å¦æŒ‰ç¯">
                    <label class="block text-sm font-medium text-gray-700 mb-1">5WHYåˆ†ææŠ¥å‘Š</label>
                    <input
                      type="file"
                      ref="fiveWhyFileInput"
                      accept=".pdf"
                      @change="handle5WhyFileUpload"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                    />
                    <div v-if="newDefect['5WHYæ–‡ä»¶']" class="mt-2 text-sm text-green-600">
                      å·²é€‰æ‹©ï¼š{{ newDefect['5WHYæ–‡ä»¶'] }}
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é—®é¢˜æè¿° *</label>
                    <textarea
                      v-model="newDefect.é—®é¢˜æè¿°"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      rows="2"
                      placeholder="è¯¦ç»†æè¿°é—®é¢˜"
                    ></textarea>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">å‘ç°äºº</label>
                      <input
                        type="text"
                        v-model="newDefect.å‘ç°äºº"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">è´£ä»»äºº</label>
                      <input
                        type="text"
                        v-model="newDefect.è´£ä»»äºº"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åŸå› </label>
                    <textarea
                      v-model="newDefect.åŸå› "
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      rows="2"
                    ></textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è§£å†³æ–¹æ¡ˆ</label>
                    <textarea
                      v-model="newDefect.è§£å†³æ–¹æ¡ˆ"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      rows="2"
                    ></textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
                    <textarea
                      v-model="newDefect.å¤‡æ³¨"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      rows="2"
                    ></textarea>
                  </div>
                  <div class="flex justify-end gap-3 pt-4">
                    <button @click="closeDefectModal" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">å–æ¶ˆ</button>
                    <button @click="saveDefect" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm">ä¿å­˜</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- å®¢æˆ·è´¹ç”¨ç»“ç®— -->
          <div v-if="currentMenu === 'billing'" class="h-full">
            <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <h2 class="text-lg font-semibold text-gray-800">å®¢æˆ·è´¹ç”¨ç»“ç®—åˆ—è¡¨</h2>
                <div class="flex flex-col md:flex-row gap-3 md:items-center">
                  <div class="relative">
                    <input
                      type="text"
                      v-model="billingSearchKeyword"
                      placeholder="æœç´¢å®¢æˆ·/è´¹ç”¨ç±»å‹"
                      class="bg-white border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded-lg px-10 py-2 text-sm text-gray-800 placeholder-gray-400 outline-none w-64"
                    />
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">ğŸ”</span>
                  </div>
                  <button 
                    @click="openBillingModal"
                    class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-semibold text-white transition whitespace-nowrap"
                  >
                    + ç™»è®°è´¹ç”¨
                  </button>
                  <button 
                    @click="triggerBillingImport"
                    class="px-4 py-2 bg-white border border-green-500 text-green-600 hover:bg-green-50 rounded-lg text-sm font-semibold transition whitespace-nowrap"
                  >
                    ğŸ“¥ å¯¼å…¥ Excel
                  </button>
                  <input
                    type="file"
                    ref="billingFileInput"
                    accept=".xlsx,.xls"
                    @change="handleBillingImport"
                    style="display: none;"
                  />
                  <button 
                    @click="exportBilling"
                    class="px-4 py-2 bg-white border border-green-500 text-green-600 hover:bg-green-50 rounded-lg text-sm font-semibold transition whitespace-nowrap"
                  >
                    ğŸ“¤ å¯¼å‡º Excel
                  </button>
                  <button 
                    @click="refreshBillingData"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition text-white"
                  >
                    åˆ·æ–°
                  </button>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-100 sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å®¢æˆ·åç§°</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">è´¹ç”¨ç±»å‹</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">é¢ç§¯ (ã¡)</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">ç»“ç®—å‘¨æœŸ</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å‘ç”Ÿæ—¥æœŸ</th>
                      <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700 whitespace-nowrap">é‡‘é¢</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">ç»“ç®—çŠ¶æ€</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">ä¸‹æ¬¡æé†’æ—¥æœŸ</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 whitespace-nowrap">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="filteredBillingRecord.length === 0" class="border-b border-gray-200">
                      <td colspan="9" class="px-4 py-8 text-center text-gray-500">æš‚æ— æ•°æ®</td>
                    </tr>
                    <tr 
                      v-else
                      v-for="(item, index) in filteredBillingRecord" 
                      :key="index"
                      class="border-b border-gray-200 hover:bg-gray-50 transition"
                    >
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.å®¢æˆ·åç§° || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.è´¹ç”¨ç±»å‹ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.é¢ç§¯ !== undefined ? item.é¢ç§¯ : '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap" :title="item.è´¹ç”¨è¯´æ˜ || ''">
                        <div class="flex flex-col">
                          <span class="font-medium">{{ item.ç»“ç®—å‘¨æœŸ || '--' }}</span>
                          <span v-if="item.è´¹ç”¨è¯´æ˜" class="text-xs text-gray-500 mt-0.5">{{ item.è´¹ç”¨è¯´æ˜ }}</span>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.å‘ç”Ÿæ—¥æœŸ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-right text-gray-800 font-medium whitespace-nowrap">
                        {{ displayBillingAmount(item.é‡‘é¢) }}
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap">
                        <span 
                          :class="[
                            'status-badge px-2 py-1 rounded text-xs',
                            item.ç»“ç®—çŠ¶æ€ === 'å¾…ç»“ç®—' ? 'bg-yellow-200 text-yellow-700' : 'bg-green-200 text-green-700'
                          ]"
                        >
                          {{ item.ç»“ç®—çŠ¶æ€ || '--' }}
                        </span>
                      </td>
                      <td 
                        class="px-4 py-3 text-sm whitespace-nowrap"
                        :class="{
                          'text-red-600 font-bold': item.ç»“ç®—çŠ¶æ€ === 'å¾…ç»“ç®—' && item.ä¸‹æ¬¡æé†’æ—¥æœŸ && checkIsDue(item.ä¸‹æ¬¡æé†’æ—¥æœŸ)
                        }"
                      >
                        <span v-if="item.ä¸‹æ¬¡æé†’æ—¥æœŸ && item.ä¸‹æ¬¡æé†’æ—¥æœŸ !== '--'">
                          <span v-if="checkIsDue(item.ä¸‹æ¬¡æé†’æ—¥æœŸ) && item.ç»“ç®—çŠ¶æ€ === 'å¾…ç»“ç®—'" class="inline-block mr-1">â°</span>
                          {{ item.ä¸‹æ¬¡æé†’æ—¥æœŸ }}
                        </span>
                        <span v-else class="text-gray-400">--</span>
                      </td>
                      <td class="px-4 py-3 text-center whitespace-nowrap">
                        <button 
                          v-if="item.ç»“ç®—çŠ¶æ€ === 'å¾…ç»“ç®—'"
                          @click="confirmBillingPayment(item, index)"
                          class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 rounded text-xs transition text-white whitespace-nowrap"
                        >
                          ğŸ’° ç¡®è®¤å›æ¬¾
                        </button>
                        <span v-else class="text-xs text-gray-400">å·²å®Œæˆ</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="mt-4 text-sm text-gray-500">
                å…± {{ filteredBillingRecord.length }} / {{ billingRecord.length }} æ¡è®°å½•
              </div>
            </div>

            <!-- ç™»è®°è´¹ç”¨å¼¹çª— -->
            <div v-if="showBillingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="closeBillingModal">
              <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ç™»è®°è´¹ç”¨</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ·åç§° *</label>
                    <input
                      type="text"
                      v-model="newBilling.å®¢æˆ·åç§°"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è´¹ç”¨ç±»å‹ *</label>
                    <select v-model="newBilling.è´¹ç”¨ç±»å‹" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                      <option value="ä»“å‚¨è´¹">ä»“å‚¨è´¹</option>
                      <option value="è¿è¾“è´¹">è¿è¾“è´¹</option>
                      <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">é¢ç§¯ (ã¡)</label>
                      <input
                        type="number"
                        v-model.number="newBilling.é¢ç§¯"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ç»“ç®—å‘¨æœŸ *</label>
                      <select v-model="newBilling.ç»“ç®—å‘¨æœŸ" @change="calculateReminder" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="å•æ¬¡">å•æ¬¡</option>
                        <option value="æœˆç»“">æœˆç»“</option>
                        <option value="å­£ç»“">å­£ç»“</option>
                        <option value="åŠå¹´ç»“">åŠå¹´ç»“</option>
                        <option value="å¹´ç»“">å¹´ç»“</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è´¹ç”¨è¯´æ˜</label>
                    <input
                      type="text"
                      v-model="newBilling.è´¹ç”¨è¯´æ˜"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                    />
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">å‘ç”Ÿæ—¥æœŸ *</label>
                      <input
                        type="date"
                        v-model="newBilling.å‘ç”Ÿæ—¥æœŸ"
                        @change="calculateReminder"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¢ *</label>
                      <input
                        type="number"
                        v-model.number="newBilling.é‡‘é¢"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                  </div>
                  <div v-if="newBilling.ä¸‹æ¬¡æé†’æ—¥æœŸ">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸‹æ¬¡æé†’æ—¥æœŸ</label>
                    <input
                      type="date"
                      v-model="newBilling.ä¸‹æ¬¡æé†’æ—¥æœŸ"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-gray-50"
                      readonly
                    />
                  </div>
                  <div class="flex justify-end gap-3 pt-4">
                    <button @click="closeBillingModal" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">å–æ¶ˆ</button>
                    <button @click="saveBilling" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm">ä¿å­˜</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ECO å˜æ›´ç®¡ç† -->
          <div v-if="currentMenu === 'eco'" class="h-full">
            <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
              <!-- é¡¶éƒ¨æ“ä½œæ  -->
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <h2 class="text-lg font-semibold text-gray-800">ECO å˜æ›´åˆ—è¡¨</h2>
                <div class="flex flex-col md:flex-row gap-3 md:items-center">
                  <!-- æœç´¢æ¡† -->
                  <div class="relative">
                    <input
                      type="text"
                      v-model="ecoSearchKeyword"
                      placeholder="æœç´¢ ECOå· / ç‰©æ–™å· / äº§å“æè¿°"
                      class="bg-white border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded-lg px-10 py-2 text-sm text-gray-800 placeholder-gray-400 outline-none w-64"
                    />
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">ğŸ”</span>
                  </div>
                  <!-- æ–°å¢æŒ‰é’® -->
                  <button
                    @click="openEcoModal"
                    class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-semibold text-white transition whitespace-nowrap"
                  >
                    + æ–°å¢ ECO
                  </button>
                  <!-- å¯¼å…¥ Excel æŒ‰é’® -->
                  <button 
                    @click="triggerEcoImport"
                    class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-lg text-sm font-semibold text-white transition whitespace-nowrap"
                  >
                    ğŸ“¥ å¯¼å…¥ Excel
                  </button>
                  <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                  <input
                    type="file"
                    ref="ecoFileInput"
                    accept=".xlsx,.xls"
                    @change="handleEcoImport"
                    style="display: none;"
                  />
                  <!-- å¯¼å‡º Excel æŒ‰é’® -->
                  <button 
                    @click="exportEcoToExcel"
                    class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-lg text-sm font-semibold text-white transition whitespace-nowrap"
                  >
                    ğŸ“¤ å¯¼å‡º Excel
                  </button>
                  <!-- åˆ·æ–°æŒ‰é’® -->
                  <button 
                    @click="refreshEcoData"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition text-white whitespace-nowrap"
                  >
                    åˆ·æ–°
                  </button>
                </div>
              </div>
              
              <!-- æ•°æ®è¡¨æ ¼ -->
              <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                  <thead class="bg-gray-100 sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap border-b border-gray-200">ECOå·</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap border-b border-gray-200">äº§å“æè¿°</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap border-b border-gray-200">å·¥åº</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap border-b border-gray-200">èµ·å§‹å°å¥—</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap border-b border-gray-200">æ¶‰åŠç‰©æ–™</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap border-b border-gray-200">ä¸‹å‘æ—¥æœŸ</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap border-b border-gray-200">ä¸‹å‘æ—¶é—´</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap border-b border-gray-200">å˜æ›´æ—¶é—´</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap border-b border-gray-200">å˜æ›´çŠ¶æ€</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 whitespace-nowrap border-b border-gray-200">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="filteredEcoList.length === 0" class="border-b border-gray-200">
                      <td colspan="10" class="px-4 py-8 text-center text-gray-500">æš‚æ— æ•°æ®</td>
                    </tr>
                    <tr 
                      v-else
                      v-for="(item, index) in filteredEcoList" 
                      :key="index"
                      class="border-b border-gray-200 hover:bg-gray-50 transition"
                    >
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.eco_no || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.description || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.op || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">ç¬¬ {{ item.start_set || '--' }} å°èµ·</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">
                        <span v-if="item.materials && Array.isArray(item.materials) && item.materials.length > 0">
                          {{ item.materials.join(', ') }}
                        </span>
                        <span v-else class="text-gray-400">--</span>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.issue_date || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.issue_time || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.update_time || '--' }}</td>
                      <td class="px-4 py-3 whitespace-nowrap">
                        <span 
                          :class="[
                            'px-2 py-1 rounded text-xs font-medium',
                            item.status === 'å·²å®Œæˆ' ? 'bg-green-200 text-green-700' : 
                            item.status === 'å·²è¿‡æœŸ' ? 'bg-gray-200 text-gray-700' : 
                            'bg-yellow-200 text-yellow-700'
                          ]"
                        >
                          {{ item.status === 'ä¸ç”¨å†™' ? 'å¾…æ‰§è¡Œ' : (item.status || 'è¿›è¡Œä¸­') }}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center whitespace-nowrap">
                        <div class="flex gap-2 justify-center">
                          <button 
                            v-if="item.status !== 'å·²å®Œæˆ'"
                            @click="executeEco(item, index)"
                            class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs transition text-white whitespace-nowrap"
                          >
                            âœ… æ‰§è¡Œ
                          </button>
                          <button 
                            @click="viewEcoDetail(item)"
                            class="px-3 py-1 bg-gray-400 hover:bg-gray-500 rounded text-xs transition text-white whitespace-nowrap"
                          >
                            è¯¦æƒ…
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- ç»Ÿè®¡ä¿¡æ¯ -->
              <div class="mt-4 text-sm text-gray-500">
                å…± {{ filteredEcoList.length }} / {{ ecoList.length }} æ¡è®°å½•
              </div>
            </div>
            
            <!-- ECO æ–°å¢/ç¼–è¾‘å¼¹çª— -->
            <div v-if="showEcoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="closeEcoModal">
              <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">æ–°å¢ ECO</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ECOå· *</label>
                    <input
                      type="text"
                      v-model="newEco.eco_no"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      placeholder="ä¾‹å¦‚: 401"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">äº§å“æè¿° *</label>
                    <input
                      type="text"
                      v-model="newEco.description"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      placeholder="ä¾‹å¦‚: HAL-X NC1"
                    />
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">å·¥åº *</label>
                      <input
                        type="text"
                        v-model="newEco.op"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                        placeholder="ä¾‹å¦‚: OP220"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">èµ·å§‹å°å¥— *</label>
                      <input
                        type="number"
                        v-model.number="newEco.start_set"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                        placeholder="ä¾‹å¦‚: 1"
                      />
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å˜æ›´è¯¦æƒ…</label>
                    <textarea
                      v-model="newEco.change_details"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      rows="2"
                      placeholder="ä¾‹å¦‚: æ›´æ¢ä¸ºV2ç‰ˆæœ¬ï¼Œæ³¨æ„å®‰è£…å­”ä½"
                    ></textarea>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ä¸‹å‘æ—¥æœŸ</label>
                      <input
                        type="date"
                        v-model="newEco.issue_date"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ä¸‹å‘æ—¶é—´</label>
                      <input
                        type="time"
                        v-model="newEco.issue_time"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                  </div>
                  
                  <!-- ç‰©æ–™åˆ—è¡¨ -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ¶‰åŠç‰©æ–™ *</label>
                    <div class="space-y-2 mb-2">
                      <div 
                        v-for="(material, idx) in newEco.materials" 
                        :key="idx"
                        class="flex items-center gap-2 p-2 bg-gray-50 rounded"
                      >
                        <span class="flex-1 text-sm">{{ material.material || material }}</span>
                        <button 
                          @click="removeEcoMaterial(idx)"
                          class="px-2 py-1 bg-red-500 text-white rounded text-xs"
                        >
                          åˆ é™¤
                        </button>
                      </div>
                    </div>
                    <div class="flex gap-2">
                      <input
                        type="text"
                        v-model="currentEcoMaterial.material"
                        @keyup.enter="addEcoMaterial"
                        class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm"
                        placeholder="è¾“å…¥ç‰©æ–™å·åæŒ‰å›è½¦æ·»åŠ "
                      />
                      <button 
                        @click="addEcoMaterial"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm"
                      >
                        æ·»åŠ ç‰©æ–™
                      </button>
                    </div>
                  </div>
                  
                  <div class="flex justify-end gap-3 pt-4">
                    <button 
                      @click="closeEcoModal"
                      class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm"
                    >
                      å–æ¶ˆ
                    </button>
                    <button 
                      @click="saveEco"
                      class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm"
                    >
                      ä¿å­˜
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- åˆ°è´§ç™»è®° -->
          <div v-if="currentMenu === 'arrival_reg'" class="h-full">
            <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <h2 class="text-lg font-semibold text-gray-800">åˆ°è´§ç™»è®°</h2>
                <div class="flex flex-col md:flex-row gap-3 md:items-center">
                  <div class="relative">
                    <input
                      type="text"
                      v-model="arrivalSearchKeyword"
                      placeholder="æœç´¢ä¾›åº”å•†/æ—¥æœŸ"
                      class="bg-white border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded-lg px-10 py-2 text-sm text-gray-800 placeholder-gray-400 outline-none w-64"
                    />
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">ğŸ”</span>
                  </div>
                  <button 
                    @click="openArrivalModal"
                    class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-semibold text-white transition whitespace-nowrap"
                  >
                    + ç™»è®°åˆ°è´§
                  </button>
                  <button 
                    @click="exportArrivalToExcel"
                    class="px-4 py-2 bg-white border border-green-500 text-green-600 hover:bg-green-50 rounded-lg text-sm font-semibold transition whitespace-nowrap"
                  >
                    ğŸ“¤ å¯¼å‡º Excel
                  </button>
                  <button 
                    @click="refreshArrivalData"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition text-white"
                  >
                    åˆ·æ–°
                  </button>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-100 sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">æ—¥æœŸ</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">æ—¶é—´</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">ä¾›åº”å•†åç§°</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å®ç‰©æ•°é‡</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å®é™…æ”¶è´§</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">çŠ¶æ€</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å•ä½</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">é€è´§å•å·</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 whitespace-nowrap">å¤‡æ³¨</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 whitespace-nowrap">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="filteredArrivalLog.length === 0" class="border-b border-gray-200">
                      <td colspan="10" class="px-4 py-8 text-center text-gray-500">æš‚æ— æ•°æ®</td>
                    </tr>
                    <tr 
                      v-else
                      v-for="(item, index) in filteredArrivalLog" 
                      :key="index"
                      class="border-b border-gray-200 hover:bg-gray-50 transition"
                    >
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.æ—¥æœŸ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.æ—¶é—´ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.ä¾›åº”å•†åç§° || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.å®ç‰©æ•°é‡ || '--' }}</td>
                      <td class="px-4 py-3 text-sm whitespace-nowrap">
                        <span 
                          v-if="item.actual_qty !== null && item.actual_qty !== undefined"
                          :class="{
                            'font-bold text-red-600': (() => {
                              const physicalQty = Number(item.å®ç‰©æ•°é‡);
                              const actualQty = Number(item.actual_qty);
                              return !isNaN(physicalQty) && !isNaN(actualQty) && physicalQty !== actualQty;
                            })(),
                            'text-gray-800': (() => {
                              const physicalQty = Number(item.å®ç‰©æ•°é‡);
                              const actualQty = Number(item.actual_qty);
                              return isNaN(physicalQty) || isNaN(actualQty) || physicalQty === actualQty;
                            })()
                          }"
                        >
                          {{ item.actual_qty }}
                        </span>
                        <span v-else class="text-gray-800">--</span>
                      </td>
                      <td class="px-4 py-3 text-sm whitespace-nowrap">
                        <span 
                          v-if="item.status === 'å¾…æ”¶è´§'"
                          class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs"
                        >
                          å¾…æ”¶è´§
                        </span>
                        <span 
                          v-else-if="item.status === 'å·²å®Œæˆ'"
                          :class="{
                            'px-2 py-1 rounded text-xs': true,
                            'bg-yellow-200 text-yellow-700': (() => {
                              if (item.actual_qty === null || item.actual_qty === undefined) return false;
                              const physicalQty = Number(item.å®ç‰©æ•°é‡);
                              const actualQty = Number(item.actual_qty);
                              return !isNaN(physicalQty) && !isNaN(actualQty) && physicalQty !== actualQty;
                            })(),
                            'bg-green-200 text-green-700': (() => {
                              if (item.actual_qty === null || item.actual_qty === undefined) return true;
                              const physicalQty = Number(item.å®ç‰©æ•°é‡);
                              const actualQty = Number(item.actual_qty);
                              return isNaN(physicalQty) || isNaN(actualQty) || physicalQty === actualQty;
                            })()
                          }"
                        >
                          {{ (() => {
                            if (item.actual_qty === null || item.actual_qty === undefined) return 'å·²å®Œæˆ';
                            const physicalQty = Number(item.å®ç‰©æ•°é‡);
                            const actualQty = Number(item.actual_qty);
                            return (!isNaN(physicalQty) && !isNaN(actualQty) && physicalQty !== actualQty) ? 'æœ‰å·®å¼‚' : 'å·²å®Œæˆ';
                          })() }}
                        </span>
                        <span 
                          v-else
                          class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs"
                        >
                          {{ item.status || 'å¾…æ”¶è´§' }}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.å•ä½ || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.é€è´§å•å· || '--' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-800 whitespace-nowrap">{{ item.å¤‡æ³¨ || '--' }}</td>
                      <td class="px-4 py-3 text-center whitespace-nowrap">
                        <div class="flex gap-2 justify-center">
                          <button 
                            v-if="!item.status || item.status === 'å¾…æ”¶è´§'"
                            @click="openArrivalFeedbackModal(index)"
                            class="px-3 py-1 bg-blue-500 hover:bg-blue-600 rounded text-xs transition text-white"
                          >
                            âœ… æ”¶è´§åé¦ˆ
                          </button>
                          <button 
                            v-else-if="item.status === 'å·²å®Œæˆ'"
                            @click="openArrivalFeedbackModal(index)"
                            class="px-3 py-1 bg-white border border-orange-500 text-orange-600 hover:bg-orange-50 rounded text-xs transition"
                          >
                            âœ ä¿®æ”¹åé¦ˆ
                          </button>
                          <button 
                            @click="deleteArrivalRecord(index)"
                            class="px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-xs transition text-white"
                          >
                            åˆ é™¤
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="mt-4 text-sm text-gray-500">
                å…± {{ filteredArrivalLog.length }} / {{ arrivalLog.length }} æ¡è®°å½•
              </div>
            </div>

            <!-- ç™»è®°åˆ°è´§å¼¹çª— -->
            <div v-if="showArrivalModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="closeArrivalModal">
              <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ç™»è®°åˆ°è´§</h3>
                <div class="space-y-4">
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ *</label>
                      <input
                        type="date"
                        v-model="newArrival.æ—¥æœŸ"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">æ—¶é—´ *</label>
                      <input
                        type="time"
                        v-model="newArrival.æ—¶é—´"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¾›åº”å•†åç§° *</label>
                    <input
                      type="text"
                      v-model="newArrival.ä¾›åº”å•†åç§°"
                      list="supplierNamesList"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      placeholder="è¾“å…¥æˆ–é€‰æ‹©ä¾›åº”å•†"
                    />
                    <datalist id="supplierNamesList">
                      <option v-for="(name, idx) in savedSupplierNames" :key="idx" :value="name"></option>
                    </datalist>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">å®ç‰©æ•°é‡ *</label>
                      <input
                        type="number"
                        v-model.number="newArrival.å®ç‰©æ•°é‡"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">å•ä½</label>
                      <select v-model="newArrival.å•ä½" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="æ‰˜">æ‰˜</option>
                        <option value="ç®±">ç®±</option>
                        <option value="ä»¶">ä»¶</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é€è´§å•å·</label>
                    <input
                      type="text"
                      v-model="newArrival.é€è´§å•å·"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
                    <textarea
                      v-model="newArrival.å¤‡æ³¨"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      rows="2"
                    ></textarea>
                  </div>
                  <div class="flex justify-end gap-3 pt-4">
                    <button @click="closeArrivalModal" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">å–æ¶ˆ</button>
                    <button @click="saveArrival" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm">ä¿å­˜</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- æ”¶è´§åé¦ˆå¼¹çª— -->
            <div v-if="showArrivalFeedbackModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="closeArrivalFeedbackModal">
              <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">æ”¶è´§åé¦ˆ</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å®é™…æ”¶è´§æ•°é‡ *</label>
                    <input
                      type="number"
                      v-model.number="arrivalFeedback.actual_qty"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      placeholder="è¯·è¾“å…¥å®é™…æ”¶è´§æ•°é‡"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åé¦ˆå¤‡æ³¨</label>
                    <textarea
                      v-model="arrivalFeedback.feedback_remark"
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                      rows="3"
                      placeholder="å¦‚æœ‰å·®å¼‚ï¼Œè¯·è¯´æ˜åŸå› "
                    ></textarea>
                  </div>
                  <div class="flex justify-end gap-3 pt-4">
                    <button @click="closeArrivalFeedbackModal" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">å–æ¶ˆ</button>
                    <button @click="saveArrivalFeedback" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">ä¿å­˜</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // æ£€æŸ¥ Vue æ˜¯å¦å·²åŠ è½½
    if (typeof Vue === 'undefined') {
      console.error('Vue æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CDN åœ°å€');
      document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>é”™è¯¯ï¼šVue.js æœªåŠ è½½</h1><p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢</p></div>';
    }

    // æ£€æŸ¥ localStorage æ˜¯å¦å¯ç”¨
    let localStorageAvailable = true;
    try {
      const test = '__localStorage_test__';
      localStorage.setItem(test, test);
      localStorage.removeItem(test);
    } catch (e) {
      localStorageAvailable = false;
      console.warn('localStorage ä¸å¯ç”¨ï¼Œæ•°æ®å°†æ— æ³•æŒä¹…åŒ–ä¿å­˜');
    }

    const { createApp } = Vue;

    // localStorage å®‰å…¨åŒ…è£…å‡½æ•°
    const safeLocalStorage = {
      getItem: (key) => {
        if (!localStorageAvailable) return null;
        try {
          return localStorage.getItem(key);
        } catch (e) {
          console.error(`è¯»å– localStorage[${key}] å¤±è´¥:`, e);
          return null;
        }
      },
      setItem: (key, value) => {
        if (!localStorageAvailable) {
          console.warn(`localStorage ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜ ${key}`);
          return false;
        }
        try {
          localStorage.setItem(key, value);
          return true;
        } catch (e) {
          console.error(`ä¿å­˜ localStorage[${key}] å¤±è´¥:`, e);
          return false;
        }
      },
      removeItem: (key) => {
        if (!localStorageAvailable) return;
        try {
          localStorage.removeItem(key);
        } catch (e) {
          console.error(`åˆ é™¤ localStorage[${key}] å¤±è´¥:`, e);
        }
      }
    };

    const app = createApp({
      data() {
        return {
          // 1. å…¨å±€å½“å‰ç”¨æˆ·çŠ¶æ€
          currentUser: {
            name: 'ç®¡ç†å‘˜',
            role: 'admin' // å¯é€‰å€¼: admin, role_a, role_b, role_c, role_d
          },
          
          // 2. è§’è‰²æƒé™å®šä¹‰ (RBAC)
          roles: {
            admin: {
              name: 'ç®¡ç†å‘˜',
              menus: ['all'] // è¶…çº§ç®¡ç†å‘˜ï¼Œæ‰€æœ‰èœå•å¯è§
            },
            role_a: {
              name: 'ç”Ÿäº§ä¸“å‘˜',
              menus: ['dashboard', 'plan', 'work_order', 'kitting', 'defects', 'eco']
            },
            role_b: {
              name: 'GEç‰©æµ',
              menus: ['plan', 'work_order', 'supplier_monitor', 'inbound_error', 'arrival_reg']
            },
            role_c: {
              name: 'ç»¼åˆè´¢åŠ¡',
              menus: ['plan', 'work_order', 'defects', 'billing', 'vehicle']
            },
            role_d: {
              name: 'æ”¶è´§å‘˜',
              menus: ['arrival_reg'] // æ”¶è´§å‘˜åªèƒ½è®¿é—®åˆ°è´§ç™»è®°æ¨¡å—
            }
          },

          // 3. èœå•é¡¹å®šä¹‰ (å·²æŒ‰æœ€æ–°ä¸šåŠ¡é€»è¾‘æ’åº)
          menuItems: [
            // --- å…¬å…±æŸ¥è¯¢åŒº ---
            { id: 'dashboard', name: 'ç»è¥æŠ¥è¡¨', icon: 'ğŸ“Š' },
            { id: 'plan', name: 'ç”Ÿäº§è®¡åˆ’', icon: 'ğŸ“…' },
            { id: 'work_order', name: 'å·¥å•ç®¡ç†', icon: 'ğŸ“‹' },
            
            // --- ç‰©æµä¸ä¾›åº”é“¾ (Role B) ---
            { id: 'supplier_monitor', name: 'ä¾›åº”å•†æ”¶è´§ç›‘æ§', icon: 'ğŸšš' },
            { id: 'inbound_error', name: 'åˆ°è´§å¼‚å¸¸ç®¡ç†', icon: 'âš ï¸' },
            { id: 'vehicle', name: 'è½¦æ¬¡ç®¡ç†', icon: 'ğŸš›' },

            // --- ç”Ÿäº§ä¸æ‰§è¡Œ (Role A) ---
            { id: 'kitting', name: 'å·¥å•é…æ–™', icon: 'ğŸ­' },
            { id: 'defects', name: 'ç¼ºé™·ç®¡ç†', icon: 'ğŸ› ï¸' },

            // --- è´¢åŠ¡ä¸å˜æ›´ (Role C / Common) ---
            { id: 'billing', name: 'å®¢æˆ·è´¹ç”¨ç»“ç®—', icon: 'ğŸ’°' },
            { id: 'eco', name: 'ECO å˜æ›´ç®¡ç†', icon: 'ğŸ”„' },
            
            // --- å…¶ä»– ---
            { id: 'arrival_reg', name: 'åˆ°è´§ç™»è®°', icon: 'ğŸ“' }
          ],

          // 4. å½“å‰é€‰ä¸­çš„èœå•
          currentMenu: 'dashboard',
          
          // 5. UI çŠ¶æ€æ§åˆ¶
          showRoleDropdown: false,

          // 6. å„ä¸ªæ¨¡å—çš„æ•°æ®æº (å ä½ï¼Œé˜²æ­¢æŠ¥é”™)
          productionPlanData: [],
          vehicleLog: [],
          ecoList: [],
          supplierMap: {},
          arrivalLog: [],
          billingRecord: [],
          discrepancyList: [],
          receivingTasks: [],
          defectList: [],
          planData: [],
          bomData: [],
          matchedWorkOrders: [],
          
          // 6.1. å‡æœŸç®¡ç†ï¼ˆä¾›åº”å•†æ”¶è´§ç›‘æ§æ¨¡å—ï¼‰
          holidays: [], // å­˜å‚¨æ—¥æœŸå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¦‚ ['2025-01-01', '2025-01-02']
          showHolidayModal: false,
          newHolidayDate: '',
          
          // 7. ç»è¥æŠ¥è¡¨ç›¸å…³æ•°æ®
          biData: {
            kpi: {
              monthlyProduction: 25320,
              avgDPMO: 76.3,
              receivingOnTimeRate: 99.8,
              supplierIssues: 45
            },
            productionTrend: {
              months: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
              production: [18500, 21200, 19800, 22800, 24500, 23800, 25200, 26800, 25320, 24100, 23500, 24800]
            },
            issueDistribution: [
              { name: 'ç³»ç»Ÿé—®é¢˜', value: 70 },
              { name: 'å•æ®é—®é¢˜', value: 27 },
              { name: 'å®ç‰©é—®é¢˜', value: 3 }
            ]
          },
          chartInstances: {
            chart1: null,
            chart2: null
          },
          
          // 8. ç”Ÿäº§è®¡åˆ’ç›¸å…³çŠ¶æ€
          planSearchDate: '',
          planSearchKeyword: '',
          planFileInput: null,
          
          // 9. ECO å˜æ›´ç®¡ç†ç›¸å…³çŠ¶æ€
          ecoSearchKeyword: '',
          showEcoModal: false,
          newEco: {
            eco_no: '',
            description: '',
            op: '',
            start_set: '',
            change_details: '',
            materials: [],
            status: 'è¿›è¡Œä¸­'
          },
          currentEcoMaterial: {
            material: '',
            start_set: '',
            change_details: ''
          },
          ecoFileInput: null,
          
          // 10. å·¥å•é…æ–™ç›¸å…³çŠ¶æ€
          planData: [],
          bomData: [],
          matchedWorkOrders: [],
          selectedWorkOrderIndex: -1,
          _selectedWorkOrder: null, // å†…éƒ¨å˜é‡ï¼Œç”¨äºå­˜å‚¨é€‰ä¸­çš„å·¥å•ï¼ˆæ”¯æŒæ—¶é—´ç»„åˆå¹¶ï¼‰
          pickingSearchDate: '',
          pickingProjectType: 'å…¨éƒ¨é¡¹ç›®', // é¡¹ç›®ç±»å‹ç­›é€‰ï¼šå…¨éƒ¨é¡¹ç›®, Pitch, SA14, å…¶ä»–
          batchPrintPages: [], // æ‰¹é‡æ‰“å°é¡µé¢æ•°ç»„
          printTime: '',
          planFileInputKitting: null,
          bomFileInput: null,
          
          // 11. ä¾›åº”å•†æ”¶è´§ç›‘æ§ç›¸å…³çŠ¶æ€
          transactionLogFile: null,
          mappingTableFile: null,
          transactionLogData: null,
          mappingTableData: null,
          itemToSupplierMap: {},
          unknownSupplierCount: 0,
          showUnknownSupplierModal: false,
          unknownSuppliersQueue: [],
          currentUnknownSupplier: null,
          currentUnknownSupplierDates: [], // è®°å½•å½“å‰æœªçŸ¥ä¾›åº”å•†å¯¹åº”çš„ Excel æ—¥æœŸåˆ—è¡¨
          unknownSupplierCnInput: '',
          
          // é˜Ÿåˆ—ç³»ç»Ÿï¼šå…³è”ä¾›åº”å•†å¤„ç†
          pendingAssociations: [], // å­˜å‚¨æ‰€æœ‰å¾…å…³è”çš„æœªçŸ¥ä¾›åº”å•†åˆ—è¡¨ [{ supplierEn, dates, excelData }]
          currentAssociation: null, // å½“å‰æ­£åœ¨å¤„ç†çš„å…³è”é¡¹
          associationCnName: '', // å½“å‰å…³è”çš„ä¸­æ–‡åè¾“å…¥
          showNewReceivingModal: false,
          newReceivingTask: {
            ä¾›åº”å•†åç§°: '',
            supplier_en: '',
            supplier_cn: '',
            åˆ°è´§æ—¥æœŸ: '',
            æ€»è¡Œæ•°: 0,
            physical_qty: '',
            unit: 'æ‰˜',
            data_source: 'pending',
            å¤‡æ³¨: ''
          },
          receivingSearchKeyword: '',
          activeReceivingTab: 'ongoing',
          receivingPage: 1,
          receivingPageSize: 10,
          
          // 12. åˆ°è´§ç™»è®°ç›¸å…³çŠ¶æ€
          arrivalSearchKeyword: '',
          showArrivalModal: false,
          newArrival: {
            æ—¥æœŸ: '',
            æ—¶é—´: '',
            ä¾›åº”å•†åç§°: '',
            å®ç‰©æ•°é‡: '',
            å•ä½: 'æ‰˜',
            é€è´§å•å·: '',
            å¤‡æ³¨: '',
            status: 'å¾…æ”¶è´§',
            actual_qty: null
          },
          showArrivalFeedbackModal: false,
          currentArrivalFeedbackIndex: -1,
          arrivalFeedback: {
            actual_qty: '',
            feedback_remark: ''
          },
          savedSupplierNames: [],
          
          // 13. å®¢æˆ·è´¹ç”¨ç»“ç®—ç›¸å…³çŠ¶æ€
          billingSearchKeyword: '',
          showBillingModal: false,
          newBilling: {
            å®¢æˆ·åç§°: '',
            è´¹ç”¨ç±»å‹: '',
            é¢ç§¯: '',
            ç»“ç®—å‘¨æœŸ: '',
            è´¹ç”¨è¯´æ˜: '',
            å‘ç”Ÿæ—¥æœŸ: '',
            é‡‘é¢: '',
            ç»“ç®—çŠ¶æ€: 'å¾…ç»“ç®—',
            ä¸‹æ¬¡æé†’æ—¥æœŸ: ''
          },
          billingFileInput: null,
          
          // 14. ç¼ºé™·ç®¡ç†ç›¸å…³çŠ¶æ€
          defectSearchKeyword: '',
          defectFilterMonth: '',
          defectFilterType: '',
          showDefectModal: false,
          newDefect: {
            å‘ç°æ—¥æœŸ: '',
            ç±»å‹: '',
            ç§ç±»: '',
            æ˜¯å¦æŒ‰ç¯: false,
            äº§å“: '',
            é—®é¢˜æè¿°: '',
            å‘ç°äºº: '',
            è´£ä»»äºº: '',
            åŸå› : '',
            è§£å†³æ–¹æ¡ˆ: '',
            '5WHYæ–‡ä»¶': '',
            å¤‡æ³¨: ''
          },
          defectFileInput: null,
          
          // 15. è½¦æ¬¡ç®¡ç†ç›¸å…³çŠ¶æ€
          vehicleSearchKeyword: '',
          showVehicleModal: false,
          newVehicleLog: {
            æ—¥æœŸ: '',
            æ—¶é—´: '',
            è½¦å‹: '',
            å¸æœºå§“å: '',
            å®¢æˆ·åç§°: '',
            å®¢æˆ·ç­¾æ”¶äºº: '',
            å†…å®¹: '',
            å¤‡æ³¨: ''
          },
          vehicleLogFileInput: null,
          
          // 16. åˆ°è´§å¼‚å¸¸ç®¡ç†ç›¸å…³çŠ¶æ€
          discrepancySearchKeyword: '',
          showDiscrepancyModal: false,
          showDiscrepancyDetailModal: false,
          currentDiscrepancyItem: null,
          discrepancyHandleResult: '',
          discrepancyHandleStatus: 'å¤„ç†ä¸­',
          newDiscrepancy: {
            supplier: '',
            date: '',
            po: '',
            material: '',
            line_no: '',
            qty: '',
            is_bonded: false,
            category: 'ç³»ç»Ÿé—®é¢˜',
            description: '',
            photos: [],
            status: 'å¾…å¤„ç†',
            result: ''
          },
          discrepancyFileInput: null
        };
      },

      computed: {
        // æ ¹æ®å½“å‰è§’è‰²è¿‡æ»¤å¯è§èœå•
        filteredMenuItems() {
          const roleConfig = this.roles[this.currentUser.role];
          if (!roleConfig) return [];
          
          // ç®¡ç†å‘˜ï¼šæ˜¾ç¤ºæ‰€æœ‰èœå•
          if (roleConfig.menus.includes('all')) {
            return this.menuItems;
          }
          
          // å…¶ä»–è§’è‰²ï¼šæ ¹æ®æƒé™è¿‡æ»¤
          const allowedMenus = roleConfig.menus || [];
          return this.menuItems.filter(item => allowedMenus.includes(item.id));
        },

        // å½“å‰èœå•åç§°
        currentMenuName() {
          const menu = this.menuItems.find(m => m.id === this.currentMenu);
          return menu ? menu.name : 'ç®¡ç†åå°';
        },

        // ç”Ÿäº§è®¡åˆ’ï¼šè¿‡æ»¤åçš„æ•°æ®
        filteredProductionPlan() {
          let result = this.productionPlanData || [];
          
          // æ—¥æœŸç­›é€‰
          if (this.planSearchDate) {
            const searchDate = this.planSearchDate;
            result = result.filter(item => {
              const itemDate = String(item.arrival_date || item.åˆ°è¾¾æ—¥æœŸ || item.ä½¿ç”¨æ—¥æœŸ || '').trim();
              const normalizedItemDate = itemDate.replace(/\//g, '-').substring(0, 10);
              return normalizedItemDate === searchDate || normalizedItemDate.includes(searchDate);
            });
          }
          
          // å…³é”®è¯æœç´¢
          const keyword = (this.planSearchKeyword || '').trim().toLowerCase();
          if (keyword) {
            result = result.filter(item => {
              const workOrder = String(item.work_order || item.å·¥å•å· || '').toLowerCase();
              const product = String(item.description || item.äº§å“æè¿° || '').toLowerCase();
              const line = String(item.line || item.äº§çº¿ || item.äº§çº¿åç§° || '').toLowerCase();
              return workOrder.includes(keyword) || product.includes(keyword) || line.includes(keyword);
            });
          }
          
          return result;
        },

        // ECOï¼šè¿‡æ»¤åçš„åˆ—è¡¨
        filteredEcoList() {
          const kw = (this.ecoSearchKeyword || '').trim().toLowerCase();
          if (!kw) return this.ecoList || [];
          return (this.ecoList || []).filter(item => {
            const ecoNo = String(item.eco_no || '').toLowerCase();
            const desc = String(item.description || '').toLowerCase();
            const materials = item.materials || [];
            const materialMatch = materials.some(mat => {
              const matStr = typeof mat === 'string' ? mat : String(mat.material || '');
              return matStr.toLowerCase().includes(kw);
            });
            return ecoNo.includes(kw) || desc.includes(kw) || materialMatch;
          });
        },

        // å·¥å•é…æ–™ï¼šè¿‡æ»¤å’Œæ’åºåçš„å·¥å•åˆ—è¡¨
        pickingFilteredAndSortedWorkOrders() {
          let list = this.matchedWorkOrders ? [...this.matchedWorkOrders] : [];

          // å»é‡ï¼šæŒ‰ work_order + op ç»„åˆå»é‡
          const seenKeys = new Set();
          list = list.filter(item => {
            const workOrder = String(item.work_order || item['å·¥å•å·'] || '').trim();
            const op = String(item.op || item['OP'] || '').trim();
            if (!workOrder || !op) return false;
            const uniqueKey = `${workOrder}|${op}`;
            if (seenKeys.has(uniqueKey)) return false;
            seenKeys.add(uniqueKey);
            return true;
          });

          // æ—¥æœŸç­›é€‰ï¼šç­›é€‰ arrival_date (åˆ°è¾¾æ—¥æœŸ)
          if (this.pickingSearchDate) {
            const searchDate = this.pickingSearchDate;
            list = list.filter(item => {
              const itemDate = String(item.arrival_date || item['åˆ°è¾¾æ—¥æœŸ'] || '').trim();
              const normalizedItemDate = itemDate.replace(/\//g, '-').substring(0, 10);
              return normalizedItemDate === searchDate || normalizedItemDate.includes(searchDate);
            });
          }

          // é¡¹ç›®ç±»å‹ç­›é€‰
          if (this.pickingProjectType && this.pickingProjectType !== 'å…¨éƒ¨é¡¹ç›®') {
            list = list.filter(item => {
              const desc = String(item.description || item['äº§å“æè¿°'] || '').trim().toLowerCase();
              if (this.pickingProjectType === 'Pitch') {
                return desc.includes('pitch');
              } else if (this.pickingProjectType === 'SA14') {
                return desc.includes('sa14');
              } else if (this.pickingProjectType === 'å…¶ä»–') {
                return !desc.includes('pitch') && !desc.includes('sa14');
              }
              return true;
            });
          }

          // æ’åºï¼šPitch äº§å“ç½®é¡¶ï¼Œç„¶åæŒ‰ arrival_time æ’åº
          list.sort((a, b) => {
            const descA = String(a.description || a['äº§å“æè¿°'] || '').trim().toLowerCase();
            const descB = String(b.description || b['äº§å“æè¿°'] || '').trim().toLowerCase();
            
            const isPitchA = descA.includes('pitch');
            const isPitchB = descB.includes('pitch');
            
            // Pitch äº§å“ç½®é¡¶
            if (isPitchA && !isPitchB) return -1;
            if (!isPitchA && isPitchB) return 1;
            
            // å¦‚æœéƒ½æ˜¯ Pitch äº§å“ï¼ŒæŒ‰ arrival_time_formatted å‡åºæ’åº
            if (isPitchA && isPitchB) {
              const timeA = String(a.arrival_time_formatted || a['åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ–'] || a.arrival_time || a['åˆ°è¾¾æ—¶é—´'] || '').trim();
              const timeB = String(b.arrival_time_formatted || b['åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ–'] || b.arrival_time || b['åˆ°è¾¾æ—¶é—´'] || '').trim();
              // å¦‚æœåŒ…å«æ—¥æœŸæ—¶é—´æ ¼å¼ (YYYY-MM-DD HH:mm)ï¼ŒæŒ‰æ—¥æœŸæ—¶é—´æ’åº
              if (timeA.includes('-') && timeA.includes(' ') && timeB.includes('-') && timeB.includes(' ')) {
                return timeA.localeCompare(timeB, 'zh-CN');
              }
              // å¦åˆ™æŒ‰æ—¶é—´æ’åº
              const parseTime = (timeStr) => {
                if (!timeStr) return Number.MAX_SAFE_INTEGER;
                const parts = timeStr.split(':');
                if (parts.length >= 2) {
                  const hours = parseInt(parts[0], 10) || 0;
                  const minutes = parseInt(parts[1], 10) || 0;
                  return hours * 60 + minutes;
                }
                return Number.MAX_SAFE_INTEGER;
              };
              const timeAVal = parseTime(timeA);
              const timeBVal = parseTime(timeB);
              if (timeAVal !== timeBVal) return timeAVal - timeBVal;
            }
            
            // é Pitch äº§å“æˆ–æ—¶é—´ç›¸åŒæ—¶ï¼ŒæŒ‰äº§å“æè¿°æ’åº
            const cmpDesc = descA.localeCompare(descB, 'zh-CN');
            if (cmpDesc !== 0) return cmpDesc;

            const opA = String(a.op || a['OP'] || '').trim();
            const opB = String(b.op || b['OP'] || '').trim();
            const numA = parseInt(opA.replace(/^OP/i, ''), 10);
            const numB = parseInt(opB.replace(/^OP/i, ''), 10);
            const finalNumA = isNaN(numA) ? Number.MAX_SAFE_INTEGER : numA;
            const finalNumB = isNaN(numB) ? Number.MAX_SAFE_INTEGER : numB;
            if (finalNumA !== finalNumB) return finalNumA - finalNumB;

            const jobA = String(a.work_order || a['å·¥å•å·'] || '').trim();
            const jobB = String(b.work_order || b['å·¥å•å·'] || '').trim();
            return jobA.localeCompare(jobB, 'zh-CN');
          });

          return list;
        },

        // å·¥å•é…æ–™ï¼šåˆ†ç»„åçš„å·¥å•åˆ—è¡¨ï¼ˆæ··åˆåˆ†ç»„ç­–ç•¥ï¼‰
        // ã€æ•°æ®æ¥æºè¯´æ˜ã€‘
        // baseList (pickingFilteredAndSortedWorkOrders) åŸºäº matchedWorkOrders
        // matchedWorkOrders é€šè¿‡ matchWorkOrders() æ–¹æ³•ç”Ÿæˆï¼š
        //   1. ä» planData (Production Plan ç”Ÿäº§è®¡åˆ’) åˆ›å»ºå·¥å•ï¼Œæ¯ä¸ªå·¥å•å¯¹åº”ä¸€ä¸ª work_order + op ç»„åˆ
        //   2. ä» bomData (BOM Data) åŒ¹é…ç‰©æ–™åˆ°å·¥å•ï¼Œæ¯ä¸ªå·¥å•åŒ…å«ä¸€ä¸ª materials æ•°ç»„
        // å› æ­¤ï¼ŒbaseList ä¸­çš„æ¯ä¸ªå…ƒç´ ä»£è¡¨ Production Plan ä¸­çš„ä¸€è¡Œï¼ˆä¸€ä¸ªå·¥åºï¼‰ï¼Œè€Œä¸æ˜¯ BOM Data ä¸­çš„ä¸€è¡Œï¼ˆä¸€ä¸ªç‰©æ–™ï¼‰
        groupedWorkOrderList() {
          const baseList = this.pickingFilteredAndSortedWorkOrders || [];
          
          // å¦‚æœæ˜¯"Pitch"ç­›é€‰æ¨¡å¼ï¼ŒæŒ‰æ—¶é—´åˆ†ç»„
          if (this.pickingProjectType === 'Pitch') {
            const pitchGroups = {}; // æŒ‰æ—¶é—´åˆ†ç»„çš„Pitchæ•°æ®
            
            baseList.forEach(item => {
              // ä½¿ç”¨ arrival_time_formatted è¿›è¡Œåˆ†ç»„ï¼ˆä¼˜å…ˆä½¿ç”¨æ ¼å¼åŒ–åçš„æ—¶é—´ï¼‰
              let timeKey = '--';
              
              // ä¼˜å…ˆä½¿ç”¨ arrival_time_formattedï¼ˆæ ¼å¼ï¼šHH:mm æˆ– YYYY-MM-DD HH:mmï¼‰
              const arrivalTimeFormatted = item.arrival_time_formatted || item['åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ–'] || '';
              if (arrivalTimeFormatted) {
                if (typeof arrivalTimeFormatted === 'string') {
                  // å¦‚æœåŒ…å«æ—¥æœŸæ—¶é—´æ ¼å¼ï¼Œæå–æ—¶é—´éƒ¨åˆ†
                  if (arrivalTimeFormatted.includes(' ') && arrivalTimeFormatted.includes(':')) {
                    const timePart = arrivalTimeFormatted.split(' ')[1] || arrivalTimeFormatted.split(' ')[0];
                    const timeMatch = timePart.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                      timeKey = `${String(parseInt(timeMatch[1], 10)).padStart(2, '0')}:${timeMatch[2]}`;
                    } else {
                      timeKey = timePart.substring(0, 5);
                    }
                  } else if (arrivalTimeFormatted.match(/\d{1,2}:\d{2}/)) {
                    // çº¯æ—¶é—´æ ¼å¼ HH:mm
                    timeKey = arrivalTimeFormatted.substring(0, 5);
                  }
                }
              }
              
              // å¦‚æœä»æœªè·å–åˆ°æ—¶é—´ï¼Œå°è¯•ä½¿ç”¨ arrival_time
              if (timeKey === '--') {
                const arrivalTime = item.arrival_time || item['åˆ°è¾¾æ—¶é—´'] || '';
              if (arrivalTime) {
                if (typeof arrivalTime === 'string') {
                  if (arrivalTime.includes(' ') && arrivalTime.includes(':')) {
                    const timePart = arrivalTime.split(' ')[1] || arrivalTime.split(' ')[0];
                    const timeMatch = timePart.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                      timeKey = `${String(parseInt(timeMatch[1], 10)).padStart(2, '0')}:${timeMatch[2]}`;
                    } else {
                      timeKey = timePart.substring(0, 5);
                    }
                  } else if (arrivalTime.match(/\d{1,2}:\d{2}/)) {
                    timeKey = arrivalTime.substring(0, 5);
                  }
                  }
                }
              }

              if (!pitchGroups[timeKey]) {
                pitchGroups[timeKey] = [];
              }
              pitchGroups[timeKey].push(item);
            });

            // ç”ŸæˆPitchæ—¶é—´ç»„ï¼ˆæŒ‰æ—¶é—´å‡åºï¼‰
            return Object.keys(pitchGroups)
              .sort((a, b) => {
                if (a === '--') return 1;
                if (b === '--') return -1;
                return a.localeCompare(b, 'zh-CN');
              })
              .map(timeKey => {
                const workOrders = pitchGroups[timeKey];
                const matchedBomCount = this.calculateMatchedBomCount(workOrders);
                
                return {
                  type: 'time_group',
                  timeKey: timeKey,
                  label: timeKey, // ç”¨äºæ˜¾ç¤º
                  workOrders: workOrders,
                  items: workOrders, // å…¼å®¹å­—æ®µ
                  displayTitle: timeKey,
                  displayDesc: `${workOrders.length} ä¸ªå·¥å•`,
                  matchedBomCount: matchedBomCount // å®é™…åŒ¹é…åˆ°çš„ç‰©æ–™æ€»è¡Œæ•°
                };
              })
              .filter(group => (group.matchedBomCount || 0) > 0);
          }
          
          // å¦‚æœæ˜¯"SA14"ç­›é€‰æ¨¡å¼ï¼ŒæŒ‰å™¨å…·åˆ†ç»„
          if (this.pickingProjectType === 'SA14') {
            // æ”¶é›†æ‰€æœ‰SA14å·¥å•çš„ç‰©æ–™
            const allMaterials = [];
            const allWorkOrders = [];
            
            baseList.forEach(item => {
              if (item.materials && item.materials.length > 0) {
                allWorkOrders.push(item);
                item.materials.forEach(material => {
                  allMaterials.push({
                    ...material,
                    _work_order: item.work_order || item['å·¥å•å·'] || '',
                    _op: item.op || item['OP'] || ''
                  });
                });
              }
            });

            // æŒ‰tool_typeåˆ†ç»„
            const toolGroups = {};
            allMaterials.forEach(material => {
              const toolType = String(material.tool_type || material['tool_type'] || 'æœªåˆ†ç±»').trim();
              if (!toolGroups[toolType]) {
                toolGroups[toolType] = {
                  materials: [],
                  workOrders: []
                };
              }
              toolGroups[toolType].materials.push(material);
            });

            // ä¸ºæ¯ä¸ªå™¨å…·ç»„æ·»åŠ å…³è”çš„å·¥å•
            Object.keys(toolGroups).forEach(toolType => {
              const materials = toolGroups[toolType].materials;
              const workOrderSet = new Set();
              materials.forEach(mat => {
                if (mat._work_order) {
                  workOrderSet.add(mat._work_order);
                }
              });
              toolGroups[toolType].workOrders = Array.from(workOrderSet).map(wo => {
                return allWorkOrders.find(item => (item.work_order || item['å·¥å•å·']) === wo);
              }).filter(Boolean);
            });

            // ç”Ÿæˆå™¨å…·ç»„åˆ—è¡¨
            return Object.keys(toolGroups).map(toolType => {
              const workOrders = toolGroups[toolType].workOrders;
              const matchedBomCount = this.calculateMatchedBomCount(workOrders);
              
              return {
                type: 'tool_group',
                toolType: toolType,
                workOrders: workOrders,
                materials: toolGroups[toolType].materials,
                items: workOrders, // å…¼å®¹å­—æ®µ
                displayTitle: toolType,
                displayDesc: '1æ¡',
                matchedBomCount: matchedBomCount // å®é™…åŒ¹é…åˆ°çš„ç‰©æ–™æ€»è¡Œæ•°
              };
            })
            .filter(group => (group.matchedBomCount || 0) > 0);
          }
          
          // å¦‚æœæ˜¯"å…¶ä»–"ç­›é€‰æ¨¡å¼ï¼ŒæŒ‰å·¥å•å·åˆ†ç»„
          // ã€ç»Ÿè®¡é€»è¾‘è¯´æ˜ã€‘
          // workOrderMap[workOrder] æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ä»£è¡¨ Production Plan (ç”Ÿäº§è®¡åˆ’) ä¸­çš„ä¸€è¡Œ
          // æ¯ä¸€è¡Œå¯¹åº”ä¸€ä¸ª work_order + op ç»„åˆï¼ˆå³ä¸€ä¸ªå·¥åºï¼‰
          // å› æ­¤ï¼Œgroup.workOrders.length ç»Ÿè®¡çš„æ˜¯ï¼šè¯¥å·¥å•å·ä¸‹åœ¨ Production Plan ä¸­çš„å·¥åºè¡Œæ•°
          // æ³¨æ„ï¼šè¿™ä¸æ˜¯ BOM Data ä¸­çš„ç‰©æ–™è¡Œæ•°ï¼Œè€Œæ˜¯ Production Plan ä¸­çš„å·¥åºè¡Œæ•°
          if (this.pickingProjectType === 'å…¶ä»–') {
            const workOrderMap = {};
            baseList.forEach(item => {
              const workOrder = item.work_order || item['å·¥å•å·'] || '';
              if (!workOrderMap[workOrder]) {
                workOrderMap[workOrder] = [];
              }
              workOrderMap[workOrder].push(item);
            });

            return Object.keys(workOrderMap).map(workOrder => {
              const workOrders = workOrderMap[workOrder];
              const matchedBomCount = this.calculateMatchedBomCount(workOrders);
              
              return {
                type: 'work_order_group',
                workOrder: workOrders[0], // ä½¿ç”¨ç¬¬ä¸€ä¸ªä½œä¸ºä»£è¡¨
                workOrders: workOrders,
                items: workOrders, // å…¼å®¹å­—æ®µ
                displayTitle: workOrder,
                displayDesc: workOrders[0].description || workOrders[0]['äº§å“æè¿°'] || '',
                matchedBomCount: matchedBomCount // å®é™…åŒ¹é…åˆ°çš„ç‰©æ–™æ€»è¡Œæ•°
              };
            })
            .filter(group => (group.matchedBomCount || 0) > 0);
          }

          // "å…¨éƒ¨é¡¹ç›®"æ¨¡å¼ï¼šæ‰§è¡Œæ··åˆåˆ†ç»„ç­–ç•¥
          const pitchGroups = {}; // æŒ‰æ—¶é—´åˆ†ç»„çš„Pitchæ•°æ®
          const sa14List = []; // SA14æ•°æ®
          const otherList = []; // å…¶ä»–æ•°æ®

          // ç¬¬ä¸€æ­¥ï¼šæå–Pitchæ•°æ®å¹¶æŒ‰æ—¶é—´åˆ†ç»„
          baseList.forEach(item => {
            const desc = String(item.description || item['äº§å“æè¿°'] || '').trim().toLowerCase();
            if (desc.includes('pitch')) {
              // ä½¿ç”¨ arrival_time_formatted è¿›è¡Œåˆ†ç»„
              let timeKey = '--';
              
              // ä¼˜å…ˆä½¿ç”¨ arrival_time_formatted
              const arrivalTimeFormatted = item.arrival_time_formatted || item['åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ–'] || '';
              if (arrivalTimeFormatted) {
                if (typeof arrivalTimeFormatted === 'string') {
                  if (arrivalTimeFormatted.includes(' ') && arrivalTimeFormatted.includes(':')) {
                    const timePart = arrivalTimeFormatted.split(' ')[1] || arrivalTimeFormatted.split(' ')[0];
                    const timeMatch = timePart.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                      timeKey = `${String(parseInt(timeMatch[1], 10)).padStart(2, '0')}:${timeMatch[2]}`;
                    } else {
                      timeKey = timePart.substring(0, 5);
                    }
                  } else if (arrivalTimeFormatted.match(/\d{1,2}:\d{2}/)) {
                    timeKey = arrivalTimeFormatted.substring(0, 5);
                  }
                }
              }
              
              // å¦‚æœä»æœªè·å–åˆ°æ—¶é—´ï¼Œå°è¯•ä½¿ç”¨ arrival_time
              if (timeKey === '--') {
                const arrivalTime = item.arrival_time || item['åˆ°è¾¾æ—¶é—´'] || '';
              if (arrivalTime) {
                if (typeof arrivalTime === 'string') {
                  if (arrivalTime.includes(' ') && arrivalTime.includes(':')) {
                    const timePart = arrivalTime.split(' ')[1] || arrivalTime.split(' ')[0];
                    const timeMatch = timePart.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                      timeKey = `${String(parseInt(timeMatch[1], 10)).padStart(2, '0')}:${timeMatch[2]}`;
                    } else {
                      timeKey = timePart.substring(0, 5);
                    }
                  } else if (arrivalTime.match(/\d{1,2}:\d{2}/)) {
                    timeKey = arrivalTime.substring(0, 5);
                  }
                  }
                }
              }

              if (!pitchGroups[timeKey]) {
                pitchGroups[timeKey] = [];
              }
              pitchGroups[timeKey].push(item);
            } else if (desc.includes('sa14')) {
              // ç¬¬äºŒæ­¥ï¼šæå–SA14æ•°æ®
              sa14List.push(item);
            } else {
              // ç¬¬ä¸‰æ­¥ï¼šæå–å…¶ä»–æ•°æ®
              otherList.push(item);
            }
          });

          // ç”ŸæˆPitchæ—¶é—´ç»„ï¼ˆæŒ‰æ—¶é—´å‡åºï¼‰
          const pitchTimeGroups = Object.keys(pitchGroups)
            .sort((a, b) => {
              if (a === '--') return 1;
              if (b === '--') return -1;
              return a.localeCompare(b, 'zh-CN');
            })
            .map(timeKey => {
              const workOrders = pitchGroups[timeKey];
              const matchedBomCount = this.calculateMatchedBomCount(workOrders);
              
              return {
                type: 'time_group',
                timeKey: timeKey,
                label: timeKey,
                workOrders: workOrders,
                items: workOrders,
                displayTitle: timeKey,
                displayDesc: `${workOrders.length} ä¸ªå·¥å•`,
                matchedBomCount: matchedBomCount // å®é™…åŒ¹é…åˆ°çš„ç‰©æ–™æ€»è¡Œæ•°
              };
            })
            .filter(group => (group.matchedBomCount || 0) > 0);

          // ç”ŸæˆSA14å™¨å…·ç»„ï¼ˆæŒ‰tool_typeåˆ†ç»„ï¼‰
          const sa14ToolGroups = {};
          sa14List.forEach(item => {
            if (item.materials && item.materials.length > 0) {
              item.materials.forEach(material => {
                const toolType = String(material.tool_type || material['tool_type'] || 'æœªåˆ†ç±»').trim();
                if (!sa14ToolGroups[toolType]) {
                  sa14ToolGroups[toolType] = {
                    materials: [],
                    workOrders: []
                  };
                }
                sa14ToolGroups[toolType].materials.push({
                  ...material,
                  _work_order: item.work_order || item['å·¥å•å·'] || '',
                  _op: item.op || item['OP'] || ''
                });
                // æ·»åŠ å·¥å•åˆ°ç»„ä¸­ï¼ˆå»é‡ï¼‰
                const existingWO = sa14ToolGroups[toolType].workOrders.find(wo => 
                  (wo.work_order || wo['å·¥å•å·']) === (item.work_order || item['å·¥å•å·'])
                );
                if (!existingWO) {
                  sa14ToolGroups[toolType].workOrders.push(item);
                }
              });
            }
          });

          const sa14Groups = Object.keys(sa14ToolGroups).map(toolType => {
            const workOrders = sa14ToolGroups[toolType].workOrders;
            const matchedBomCount = this.calculateMatchedBomCount(workOrders);
            
            return {
              type: 'tool_group',
              toolType: toolType,
              workOrders: workOrders,
              materials: sa14ToolGroups[toolType].materials,
              items: workOrders, // å…¼å®¹å­—æ®µ
              displayTitle: toolType,
              displayDesc: '1æ¡',
              matchedBomCount: matchedBomCount // å®é™…åŒ¹é…åˆ°çš„ç‰©æ–™æ€»è¡Œæ•°
            };
          })
          .filter(group => (group.matchedBomCount || 0) > 0);

          // ç”Ÿæˆå…¶ä»–å·¥å•ç»„ï¼ˆæŒ‰å·¥å•å·å»é‡å¹¶åˆ†ç»„ï¼‰
          // ã€ç»Ÿè®¡é€»è¾‘è¯´æ˜ã€‘
          // workOrderMap[workOrder] æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ä»£è¡¨ Production Plan (ç”Ÿäº§è®¡åˆ’) ä¸­çš„ä¸€è¡Œ
          // æ¯ä¸€è¡Œå¯¹åº”ä¸€ä¸ª work_order + op ç»„åˆï¼ˆå³ä¸€ä¸ªå·¥åºï¼‰
          // å› æ­¤ï¼Œgroup.workOrders.length ç»Ÿè®¡çš„æ˜¯ï¼šè¯¥å·¥å•å·ä¸‹åœ¨ Production Plan ä¸­çš„å·¥åºè¡Œæ•°
          // æ³¨æ„ï¼šè¿™ä¸æ˜¯ BOM Data ä¸­çš„ç‰©æ–™è¡Œæ•°ï¼Œè€Œæ˜¯ Production Plan ä¸­çš„å·¥åºè¡Œæ•°
          const workOrderMap = {};
          otherList.forEach(item => {
            const workOrder = item.work_order || item['å·¥å•å·'] || '';
            if (!workOrderMap[workOrder]) {
              workOrderMap[workOrder] = [];
            }
            workOrderMap[workOrder].push(item);
          });

          const workOrderGroups = Object.keys(workOrderMap).map(workOrder => {
            const workOrders = workOrderMap[workOrder];
            const matchedBomCount = this.calculateMatchedBomCount(workOrders);
            
            return {
              type: 'work_order_group',
              workOrder: workOrders[0], // ä½¿ç”¨ç¬¬ä¸€ä¸ªä½œä¸ºä»£è¡¨
              workOrders: workOrders,
              items: workOrders, // å…¼å®¹å­—æ®µ
              displayTitle: workOrder,
              displayDesc: workOrders[0].description || workOrders[0]['äº§å“æè¿°'] || '',
              matchedBomCount: matchedBomCount // å®é™…åŒ¹é…åˆ°çš„ç‰©æ–™æ€»è¡Œæ•°
            };
          })
          .filter(group => (group.matchedBomCount || 0) > 0);

          // ç¬¬ä¸‰æ­¥ï¼šåˆå¹¶ï¼ˆPitchç»„ç½®é¡¶ï¼Œç„¶åæ˜¯SA14å™¨å…·ç»„ï¼Œæœ€åæ˜¯å…¶ä»–å·¥å•ç»„ï¼‰
          return [...pitchTimeGroups, ...sa14Groups, ...workOrderGroups];
        },

        // å·¥å•é…æ–™ï¼šé€‰ä¸­çš„å·¥å•ï¼ˆæˆ–å·¥å•ç»„ï¼‰
        selectedWorkOrder() {
          // å¦‚æœå·²ç»é€šè¿‡ selectWorkOrder è®¾ç½®äº† selectedWorkOrderï¼Œç›´æ¥è¿”å›
          if (this._selectedWorkOrder) {
            return this._selectedWorkOrder;
          }
          
          const list = this.groupedWorkOrderList || [];
          if (this.selectedWorkOrderIndex >= 0 && this.selectedWorkOrderIndex < list.length) {
            const selectedItem = list[this.selectedWorkOrderIndex];
            // å¦‚æœæ˜¯æ—¶é—´ç»„ï¼Œåˆ›å»ºåˆå¹¶çš„å·¥å•å¯¹è±¡
            if (selectedItem.type === 'time_group' && selectedItem.workOrders && selectedItem.workOrders.length > 0) {
              const mergedWorkOrder = {
                type: 'time_group',
                timeKey: selectedItem.timeKey,
                workOrders: selectedItem.workOrders,
                description: 'Pitch Axis- FFF',
                'äº§å“æè¿°': 'Pitch Axis- FFF',
                arrival_time: selectedItem.timeKey,
                'åˆ°è¾¾æ—¶é—´': selectedItem.timeKey,
                arrival_time_formatted: selectedItem.timeKey,
                'åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ–': selectedItem.timeKey,
                materials: [],
                hasEco: false
              };
              
              // åˆå¹¶æ‰€æœ‰å·¥å•çš„ç‰©æ–™
              selectedItem.workOrders.forEach(wo => {
                if (wo.materials && wo.materials.length > 0) {
                  wo.materials.forEach(material => {
                    mergedWorkOrder.materials.push({
                      ...material,
                      _work_order: wo.work_order || wo['å·¥å•å·'] || '',
                      _op: wo.op || wo['OP'] || ''
                    });
                  });
                  
                  if (wo.hasEco) {
                    mergedWorkOrder.hasEco = true;
                  }
                }
              });
              
              return mergedWorkOrder;
            }
            // å¦‚æœæ˜¯å™¨å…·ç»„ï¼Œè¿”å›åˆå¹¶åçš„å·¥å•ï¼ˆåŒ…å«è¯¥å™¨å…·ä¸‹æ‰€æœ‰SA14å·¥å•çš„ç‰©æ–™ï¼‰
            if (selectedItem.type === 'tool_group' && selectedItem.materials && selectedItem.materials.length > 0) {
              // æ£€æŸ¥æ˜¯å¦æœ‰ECO
              let hasEco = false;
              selectedItem.materials.forEach(material => {
                if (material.ecoInfo && material.ecoInfo.ecoNo) {
                  hasEco = true;
                }
              });
              selectedItem.workOrders.forEach(wo => {
                if (wo.hasEco) {
                  hasEco = true;
                }
              });
              
              // è¿”å›åˆå¹¶åçš„å·¥å•å¯¹è±¡
              return {
                work_order: selectedItem.workOrders[0]?.work_order || selectedItem.workOrders[0]?.['å·¥å•å·'] || '',
                description: selectedItem.workOrders[0]?.description || selectedItem.workOrders[0]?.['äº§å“æè¿°'] || '',
                op: selectedItem.workOrders[0]?.op || selectedItem.workOrders[0]?.['OP'] || '',
                materials: selectedItem.materials,
                hasEco: hasEco,
                _isToolGroup: true,
                _toolType: selectedItem.toolType,
                _allWorkOrders: selectedItem.workOrders
              };
            }
            // å¦‚æœæ˜¯å·¥å•ç»„ï¼Œè¿”å›åˆå¹¶åçš„å·¥å•ï¼ˆåŒ…å«æ‰€æœ‰OPçš„ç‰©æ–™ï¼‰
            if (selectedItem.type === 'work_order_group' && selectedItem.workOrders && selectedItem.workOrders.length > 0) {
              // åˆå¹¶æ‰€æœ‰OPçš„ç‰©æ–™
              const mergedMaterials = [];
              let hasEco = false;
              selectedItem.workOrders.forEach(wo => {
                if (wo.materials && wo.materials.length > 0) {
                  wo.materials.forEach(material => {
                    mergedMaterials.push({
                      ...material,
                      _work_order: wo.work_order || wo['å·¥å•å·'] || '',
                      _op: wo.op || wo['OP'] || ''
                    });
                    if (material.ecoInfo && material.ecoInfo.ecoNo) {
                      hasEco = true;
                    }
                  });
                }
                if (wo.hasEco) {
                  hasEco = true;
                }
              });
              
              // è¿”å›åˆå¹¶åçš„å·¥å•å¯¹è±¡
              return {
                ...selectedItem.workOrder,
                materials: mergedMaterials,
                hasEco: hasEco,
                _isMergedGroup: true,
                _allWorkOrders: selectedItem.workOrders
              };
            }
          }
          return null;
        },

        // å·¥å•é…æ–™ï¼šæŒ‰ tool_type åˆ†ç»„åçš„ç‰©æ–™
        groupedMaterialsByToolType() {
          const workOrder = this.selectedWorkOrder;
          if (!workOrder || !workOrder.materials || workOrder.materials.length === 0) {
            return [];
          }
          
          const isPitch = this.isPitchProduct(workOrder);
          const isSA14 = this.isSA14Product(workOrder);
          
          if (!isPitch && !isSA14) {
            return [];
          }
          
          const groups = {};
          workOrder.materials.forEach(material => {
            const toolType = String(material.tool_type || material['tool_type'] || 'æœªåˆ†ç±»').trim();
            if (!groups[toolType]) {
              groups[toolType] = [];
            }
            groups[toolType].push(material);
          });
          
          return Object.keys(groups).map(toolType => ({
            toolType: toolType,
            materials: groups[toolType].sort((a, b) => {
              const locA = String(a.PENDING_LOCATOR || a['PENDING_LOCATOR'] || '').trim();
              const locB = String(b.PENDING_LOCATOR || b['PENDING_LOCATOR'] || '').trim();
              return locA.localeCompare(locB, 'zh-CN');
            })
          }));
        },

        // å·¥å•é…æ–™ï¼šæ’åºåçš„ç‰©æ–™ï¼ˆé»˜è®¤äº§å“ç”¨ï¼‰
        sortedMaterials() {
          const workOrder = this.selectedWorkOrder;
          if (!workOrder || !workOrder.materials || workOrder.materials.length === 0) {
            return [];
          }
          
          const list = [...workOrder.materials];
          list.sort((a, b) => {
            const locA = String(a.PENDING_LOCATOR || a['PENDING_LOCATOR'] || '').trim();
            const locB = String(b.PENDING_LOCATOR || b['PENDING_LOCATOR'] || '').trim();
            return locA.localeCompare(locB, 'zh-CN');
          });
          return list;
        },

        // å·¥å•é…æ–™ï¼šæ‰“å°é¡µé¢æ•°ç»„
        printPages() {
          const workOrder = this.selectedWorkOrder;
          if (!workOrder) {
            return [];
          }
          return this.generatePrintPages(workOrder);
        },

        // ä¾›åº”å•†æ”¶è´§ç›‘æ§ï¼šä» arrivalLog è½¬æ¢çš„ç›‘æ§åˆ—è¡¨
        monitoringList() {
          // ä» arrivalLog è¯»å–æ‰€æœ‰è®°å½•ï¼Œè½¬æ¢ä¸ºç›‘æ§å¡ç‰‡æ ¼å¼
          return (this.arrivalLog || []).map(arrival => {
            // ç»„åˆæ—¥æœŸå’Œæ—¶é—´ä½œä¸ºåˆ°è´§æ—¥æœŸ
            const arrivalDate = arrival.æ—¥æœŸ || '';
            const arrivalTime = arrival.æ—¶é—´ || '';
            const fullDate = arrivalDate && arrivalTime ? `${arrivalDate} ${arrivalTime}` : arrivalDate || arrivalTime;
            
            return {
              // åŸºç¡€å­—æ®µï¼ˆæ¥è‡ªåˆ°è´§ç™»è®°ï¼‰
              supplier_cn: arrival.ä¾›åº”å•†åç§° || '',
              supplier_en: '', // å¯èƒ½é€šè¿‡åŒ¹é…è·å¾—
              åˆ°è´§æ—¥æœŸ: fullDate,
              date: fullDate,
              å®ç‰©æ•°é‡: arrival.å®ç‰©æ•°é‡ || 0,
              physical_qty: arrival.å®ç‰©æ•°é‡ || 0,
              unit: arrival.å•ä½ || 'ä»¶',
              é€è´§å•å·: arrival.é€è´§å•å· || '',
              å¤‡æ³¨: arrival.å¤‡æ³¨ || '',
              
              // ç›‘æ§æ¨¡å—ä¸“ç”¨å­—æ®µ
              system_data: arrival.system_data || {
                total: 0,
                logs: []
              },
              is_closed: arrival.is_closed || false,
              kpi: arrival.kpi || null,
              
              // å…¼å®¹å­—æ®µ
              system_lines: arrival.system_data ? arrival.system_data.total : (arrival.system_lines || 0),
              æ€»è¡Œæ•°: arrival.system_data ? arrival.system_data.total : (arrival.system_lines || 0),
              
              // ä¿ç•™åŸå§‹ arrivalLog çš„ç´¢å¼•ï¼Œç”¨äºå›å¡«æ•°æ®
              _arrivalIndex: this.arrivalLog.indexOf(arrival)
            };
          });
        },

        // ä¾›åº”å•†æ”¶è´§ç›‘æ§ï¼šè¿‡æ»¤åçš„ä»»åŠ¡åˆ—è¡¨
        filteredReceivingTasks() {
          const kw = (this.receivingSearchKeyword || '').trim().toLowerCase();
          return (this.monitoringList || []).filter(task => {
            // çŠ¶æ€æ ‡ç­¾è¿‡æ»¤
            if (this.activeReceivingTab === 'ongoing') {
              // è¿›è¡Œä¸­ï¼šæœªç»“æ¡ˆä¸”æœ‰æ•°æ®ï¼Œæˆ–å·²ç»“æ¡ˆ
              if (task.is_closed) return true;
              if (task.system_data && task.system_data.total > 0) return true;
              return false;
            }
            // æœç´¢è¿‡æ»¤
            if (!kw) return true;
            const name = String(task.supplier_cn || '').toLowerCase();
            return name.includes(kw);
          });
        },

        // ä¾›åº”å•†æ”¶è´§ç›‘æ§ï¼šåˆ†é¡µåçš„åˆ—è¡¨
        pagedReceivingTasks() {
          const list = this.filteredReceivingTasks;
          const size = this.receivingPageSize || 10;
          const page = Math.max(1, this.receivingPage || 1);
          const start = (page - 1) * size;
          return list.slice(start, start + size);
        },

        // ä¾›åº”å•†æ”¶è´§ç›‘æ§ï¼šå¯ç”¨äºå…³è”çš„ä¾›åº”å•†åˆ—è¡¨ï¼ˆåªæ˜¾ç¤ºå°šæœªæœ‰ç³»ç»Ÿæ•°æ®çš„ä»»åŠ¡ï¼‰
        availableSuppliersForMapping() {
          // ç­›é€‰å‡ºå½“å‰åˆ—è¡¨é‡Œå°šæœªæœ‰ç³»ç»Ÿæ•°æ®çš„æ‰€æœ‰ä»»åŠ¡çš„ä¸­æ–‡å
          const suppliers = new Set();
          (this.monitoringList || []).forEach(task => {
            const hasSystemData = task.system_data && task.system_data.total > 0;
            if (!hasSystemData && task.supplier_cn) {
              suppliers.add(task.supplier_cn);
            }
          });
          return Array.from(suppliers).sort();
        },

        receivingTotalPages() {
          const size = this.receivingPageSize || 10;
          if (!size) return 1;
          const total = this.filteredReceivingTasks.length;
          return total === 0 ? 1 : Math.ceil(total / size);
        },

        // åˆ°è´§ç™»è®°ï¼šè¿‡æ»¤åçš„åˆ—è¡¨
        filteredArrivalLog() {
          const kw = (this.arrivalSearchKeyword || '').trim().toLowerCase();
          let result = this.arrivalLog || [];
          
          if (kw) {
            result = result.filter(item => {
              const supplier = String(item.ä¾›åº”å•†åç§° || '').toLowerCase();
              const date = String(item.æ—¥æœŸ || '').toLowerCase();
              return supplier.includes(kw) || date.includes(kw);
            });
          }
          
          return result.sort((a, b) => {
            const dateA = new Date(a.æ—¥æœŸ || '');
            const dateB = new Date(b.æ—¥æœŸ || '');
            return dateB - dateA;
          });
        },

        // å®¢æˆ·è´¹ç”¨ç»“ç®—ï¼šè¿‡æ»¤åçš„åˆ—è¡¨
        filteredBillingRecord() {
          const kw = (this.billingSearchKeyword || '').trim().toLowerCase();
          if (!kw) return this.billingRecord || [];
          return (this.billingRecord || []).filter(item => {
            const customer = String(item.å®¢æˆ·åç§° || '').toLowerCase();
            const type = String(item.è´¹ç”¨ç±»å‹ || '').toLowerCase();
            return customer.includes(kw) || type.includes(kw);
          });
        },

        // ç¼ºé™·ç®¡ç†ï¼šè¿‡æ»¤åçš„åˆ—è¡¨
        filteredDefectList() {
          let list = this.defectList || [];

          // æŒ‰æœˆä»½ç­›é€‰
          if (this.defectFilterMonth) {
            const month = this.defectFilterMonth;
            list = list.filter(item => {
              const dateStr = String(item.å‘ç°æ—¥æœŸ || '').trim().replace(/\//g, '-');
              return dateStr.startsWith(month);
            });
          }

          // æŒ‰ç±»å‹ç­›é€‰
          if (this.defectFilterType) {
            const type = this.defectFilterType;
            list = list.filter(item => String(item.ç±»å‹ || '').trim() === type);
          }

          return list;
        },

        // è½¦æ¬¡ç®¡ç†ï¼šè¿‡æ»¤åçš„åˆ—è¡¨
        filteredVehicleLog() {
          const kw = (this.vehicleSearchKeyword || '').trim().toLowerCase();
          if (!kw) return this.vehicleLog || [];
          return (this.vehicleLog || []).filter(item => {
            const customer = String(item.å®¢æˆ·åç§° || '').toLowerCase();
            const driver = String(item.å¸æœºå§“å || '').toLowerCase();
            const vehicle = String(item.è½¦å‹ || '').toLowerCase();
            return customer.includes(kw) || driver.includes(kw) || vehicle.includes(kw);
          });
        },

        // åˆ°è´§å¼‚å¸¸ç®¡ç†ï¼šè¿‡æ»¤åçš„åˆ—è¡¨
        filteredDiscrepancyList() {
          const kw = (this.discrepancySearchKeyword || '').trim().toLowerCase();
          if (!kw) return this.discrepancyList || [];
          return (this.discrepancyList || []).filter(item => {
            const supplier = String(item.supplier || '').toLowerCase();
            const po = String(item.po || '').toLowerCase();
            const material = String(item.material || '').toLowerCase();
            const category = String(item.category || '').toLowerCase();
            const status = String(item.status || '').toLowerCase();
            const desc = String(item.description || '').toLowerCase();
            return (
              supplier.includes(kw) ||
              po.includes(kw) ||
              material.includes(kw) ||
              category.includes(kw) ||
              status.includes(kw) ||
              desc.includes(kw)
            );
          });
        }
      },

      methods: {
        // åˆ‡æ¢èœå•
        switchMenu(menuId) {
          this.currentMenu = menuId;
        },

        // åˆ‡æ¢è§’è‰²
        switchRole(role) {
          if (!this.roles[role]) {
            alert('æ— æ•ˆçš„è§’è‰²');
            return;
          }
          this.currentUser.role = role;
          this.currentUser.name = this.roles[role].name;
          this.showRoleDropdown = false;
          
          // å¦‚æœå½“å‰èœå•ä¸åœ¨æ–°è§’è‰²çš„æƒé™èŒƒå›´å†…ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨èœå•
          const roleConfig = this.roles[role];
          if (!roleConfig.menus.includes('all')) {
            const allowedMenus = roleConfig.menus || [];
            if (!allowedMenus.includes(this.currentMenu)) {
              this.currentMenu = allowedMenus[0] || 'dashboard';
            }
          }
        },

        // è·å–è§’è‰²åç§°
        getRoleName(role) {
          return this.roles[role]?.name || role;
        },

        // é€€å‡ºç™»å½•
        logout() {
          if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
            alert('é€€å‡ºç™»å½•åŠŸèƒ½å¾…å®ç°');
          }
        },

        // æ ¼å¼åŒ–æ•°å­—ï¼ˆæ·»åŠ åƒåˆ†ä½ï¼‰
        formatNumber(num) {
          return Number(num).toLocaleString('zh-CN');
        },

        // è§¦å‘ç”Ÿäº§è®¡åˆ’æ–‡ä»¶ä¸Šä¼ 
        triggerPlanFileUpload() {
          if (this.$refs.planFileInput) {
            this.$refs.planFileInput.click();
          }
        },

        // å¤„ç†ç”Ÿäº§è®¡åˆ’æ–‡ä»¶ä¸Šä¼ 
        handlePlanFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          // æ£€æŸ¥ XLSX æ˜¯å¦å·²åŠ è½½
          if (typeof XLSX === 'undefined') {
            alert('XLSX åº“æœªåŠ è½½ï¼Œæ— æ³•è¯»å– Excel æ–‡ä»¶');
            return;
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

              // å­—æ®µæ˜ å°„ - ä¸¥æ ¼æŒ‰ç…§ Excel åˆ—åæ˜ å°„
              const planData = jsonData.map(row => {
                // å…³é”®å­—æ®µæ˜ å°„
                const workOrder = String(row['å·¥å•å·'] || '').trim();
                const op = String(row['å·¥åº'] || row['OP'] || '').trim();
                const arrivalTimeRaw = row['åˆ°è¾¾æ—¶é—´'] || row['arrival_time'] || row['åˆ°åœºæ—¶é—´'] || '';
                
                // æ ¼å¼åŒ–æ—¶é—´ï¼ˆæ”¯æŒå°æ•°æ ¼å¼å’Œå­—ç¬¦ä¸²æ ¼å¼ï¼‰
                let arrivalTime = '';
                if (arrivalTimeRaw) {
                  if (typeof arrivalTimeRaw === 'number' && arrivalTimeRaw < 1) {
                    // Excel æ—¶é—´æ ¼å¼ï¼šå°æ•°è½¬ HH:mm
                    const totalHours = arrivalTimeRaw * 24;
                    const hours = Math.floor(totalHours);
                    const minutes = Math.floor((totalHours - hours) * 60);
                    arrivalTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                  } else {
                    // å­—ç¬¦ä¸²æ ¼å¼
                    const timeStr = String(arrivalTimeRaw).trim();
                    if (timeStr.includes(':')) {
                      arrivalTime = timeStr.substring(0, 5);
                    } else {
                      arrivalTime = timeStr;
                    }
                  }
                }

                // æ ¼å¼åŒ–æ—¥æœŸ
                const arrivalDateRaw = row['åˆ°è¾¾æ—¥æœŸ'] || row['ä½¿ç”¨æ—¥æœŸ'] || row['arrival_date'] || '';
                let arrivalDate = '';
                if (arrivalDateRaw) {
                  if (arrivalDateRaw instanceof Date) {
                    const year = arrivalDateRaw.getFullYear();
                    const month = String(arrivalDateRaw.getMonth() + 1).padStart(2, '0');
                    const day = String(arrivalDateRaw.getDate()).padStart(2, '0');
                    arrivalDate = `${year}-${month}-${day}`;
                  } else if (typeof arrivalDateRaw === 'number') {
                    // Excel æ—¥æœŸåºåˆ—å·
                    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                    const ms = arrivalDateRaw * 24 * 60 * 60 * 1000;
                    const date = new Date(excelEpoch.getTime() + ms);
                    const year = date.getUTCFullYear();
                    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(date.getUTCDate()).padStart(2, '0');
                    arrivalDate = `${year}-${month}-${day}`;
                  } else {
                    arrivalDate = String(arrivalDateRaw).trim().replace(/\//g, '-').substring(0, 10);
                  }
                }

                return {
                  work_order: workOrder,
                  op: op,
                  arrival_time: arrivalTime,
                  arrival_date: arrivalDate,
                  trip_no: String(row['è½¦æ¬¡'] || '').trim(),
                  line: String(row['äº§çº¿'] || row['äº§çº¿åç§°'] || '').trim(),
                  description: String(row['äº§å“æè¿°'] || '').trim(),
                  seq_no: String(row['åŠ å·¥åºåˆ—å·'] || row['å°å¥—'] || '').trim(),
                  // å…¼å®¹å­—æ®µ
                  'å·¥å•å·': workOrder,
                  'OP': op,
                  'åˆ°è¾¾æ—¶é—´': arrivalTime,
                  'åˆ°è¾¾æ—¥æœŸ': arrivalDate,
                  'è½¦æ¬¡': String(row['è½¦æ¬¡'] || '').trim(),
                  'äº§çº¿': String(row['äº§çº¿'] || row['äº§çº¿åç§°'] || '').trim(),
                  'äº§å“æè¿°': String(row['äº§å“æè¿°'] || '').trim(),
                  'åŠ å·¥åºåˆ—å·': String(row['åŠ å·¥åºåˆ—å·'] || row['å°å¥—'] || '').trim()
                };
              }).filter(item => item.work_order && item.op); // è¿‡æ»¤ç©ºæ•°æ®

              // ä¿å­˜æ•°æ®
              this.productionPlanData = planData;
              
              // ä¿å­˜åˆ° localStorage
              try {
                localStorage.setItem('productionPlanData', JSON.stringify(planData));
                localStorage.setItem('planUpdateTime', new Date().toLocaleString('zh-CN'));
              } catch (e) {
                console.error('ä¿å­˜åˆ° localStorage å¤±è´¥:', e);
              }

              alert(`æˆåŠŸå¯¼å…¥ ${planData.length} æ¡ç”Ÿäº§è®¡åˆ’æ•°æ®`);
              
              // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
              event.target.value = '';
            } catch (error) {
              console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
              alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
              event.target.value = '';
            }
          };

          reader.onerror = () => {
            alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            event.target.value = '';
          };

          reader.readAsArrayBuffer(file);
        },

        // åˆ·æ–°ç”Ÿäº§è®¡åˆ’æ•°æ®
        refreshPlanData() {
          try {
            const saved = localStorage.getItem('productionPlanData');
            if (saved) {
              this.productionPlanData = JSON.parse(saved);
              alert('æ•°æ®å·²åˆ·æ–°');
            } else {
              alert('æš‚æ— ä¿å­˜çš„æ•°æ®');
            }
          } catch (e) {
            console.error('è¯»å–æ•°æ®å¤±è´¥:', e);
            alert('è¯»å–æ•°æ®å¤±è´¥');
          }
        },

        // åˆå§‹åŒ– ECharts å›¾è¡¨
        initCharts() {
          // æ£€æŸ¥ ECharts æ˜¯å¦å·²åŠ è½½
          if (typeof echarts === 'undefined') {
            console.warn('ECharts æœªåŠ è½½ï¼Œæ— æ³•åˆå§‹åŒ–å›¾è¡¨');
            return;
          }
          
          this.$nextTick(() => {
            try {
            // å›¾è¡¨1ï¼šäº§é‡è¶‹åŠ¿æŸ±çŠ¶å›¾
            if (this.$refs.chart1) {
                // æ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨
                const productionTrend = this.biData?.productionTrend || {};
                const months = productionTrend.months || [];
                const production = productionTrend.production || [];
                
                // å¦‚æœæ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
                if (months.length === 0 || production.length === 0) {
                  console.warn('äº§é‡è¶‹åŠ¿æ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                }
                
                // é”€æ¯æ—§å®ä¾‹
              if (this.chartInstances.chart1) {
                  try {
                this.chartInstances.chart1.dispose();
                  } catch (e) {
                    console.warn('é”€æ¯å›¾è¡¨1å®ä¾‹å¤±è´¥:', e);
              }
                }
                
                // åˆå§‹åŒ–æ–°å®ä¾‹
              this.chartInstances.chart1 = echarts.init(this.$refs.chart1);
                
                // æ„å»ºé…ç½®å¯¹è±¡ï¼Œç¡®ä¿æ‰€æœ‰å¿…éœ€å±æ€§éƒ½å­˜åœ¨
              const option1 = {
                tooltip: {
                  trigger: 'axis',
                    axisPointer: { 
                      type: 'shadow' 
                    }
                },
                xAxis: {
                  type: 'category',
                    data: months.length > 0 ? months : ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ']
                },
                yAxis: {
                  type: 'value',
                  name: 'äº§é‡'
                },
                series: [{
                  name: 'äº§é‡',
                  type: 'bar',
                    data: production.length > 0 ? production : [0, 0, 0, 0, 0, 0],
                  itemStyle: {
                    color: '#3b82f6'
                  }
                }]
              };
                
                // éªŒè¯é…ç½®å¯¹è±¡
                if (option1 && option1.series && Array.isArray(option1.series) && option1.series.length > 0) {
                  const firstSeries = option1.series[0];
                  if (firstSeries && firstSeries.type) {
              this.chartInstances.chart1.setOption(option1);
                  } else {
                    console.error('å›¾è¡¨1é…ç½®é”™è¯¯ï¼šseries[0].type æœªå®šä¹‰');
                  }
                } else {
                  console.error('å›¾è¡¨1é…ç½®é”™è¯¯ï¼šoption1 æˆ– series æ— æ•ˆ');
                }
            }

            // å›¾è¡¨2ï¼šé—®é¢˜åˆ†å¸ƒé¥¼å›¾
            if (this.$refs.chart2) {
                // æ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨
                const issueDistribution = this.biData?.issueDistribution || [];
                
                // é”€æ¯æ—§å®ä¾‹
              if (this.chartInstances.chart2) {
                  try {
                this.chartInstances.chart2.dispose();
                  } catch (e) {
                    console.warn('é”€æ¯å›¾è¡¨2å®ä¾‹å¤±è´¥:', e);
              }
                }
                
                // åˆå§‹åŒ–æ–°å®ä¾‹
              this.chartInstances.chart2 = echarts.init(this.$refs.chart2);
                
                // å¤„ç†æ•°æ®ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
                const pieData = Array.isArray(issueDistribution) && issueDistribution.length > 0
                  ? issueDistribution.map(item => ({
                      value: item?.value || 0,
                      name: item?.name || 'æœªçŸ¥'
                    }))
                  : [
                      { value: 0, name: 'æš‚æ— æ•°æ®' }
                    ];
                
                // æ„å»ºé…ç½®å¯¹è±¡ï¼Œç¡®ä¿æ‰€æœ‰å¿…éœ€å±æ€§éƒ½å­˜åœ¨
              const option2 = {
                tooltip: {
                  trigger: 'item',
                  formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                  orient: 'vertical',
                  left: 'left'
                },
                series: [{
                  name: 'é—®é¢˜åˆ†å¸ƒ',
                  type: 'pie',
                  radius: '50%',
                    data: pieData,
                  emphasis: {
                    itemStyle: {
                      shadowBlur: 10,
                      shadowOffsetX: 0,
                      shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                  }
                }]
              };
                
                // éªŒè¯é…ç½®å¯¹è±¡
                if (option2 && option2.series && Array.isArray(option2.series) && option2.series.length > 0) {
                  const firstSeries = option2.series[0];
                  if (firstSeries && firstSeries.type) {
              this.chartInstances.chart2.setOption(option2);
                  } else {
                    console.error('å›¾è¡¨2é…ç½®é”™è¯¯ï¼šseries[0].type æœªå®šä¹‰');
                  }
                } else {
                  console.error('å›¾è¡¨2é…ç½®é”™è¯¯ï¼šoption2 æˆ– series æ— æ•ˆ');
                }
              }

              // å“åº”å¼è°ƒæ•´ - ä½¿ç”¨é˜²æŠ–é¿å…é¢‘ç¹è°ƒç”¨
              let resizeTimer = null;
              const handleResize = () => {
                if (resizeTimer) {
                  clearTimeout(resizeTimer);
                }
                resizeTimer = setTimeout(() => {
                  // æ£€æŸ¥å›¾è¡¨1ï¼šå®ä¾‹å­˜åœ¨ä¸” DOM å­˜åœ¨
                  try {
                    if (this.chartInstances.chart1 && 
                        this.chartInstances.chart1.resize && 
                        this.$refs.chart1) {
                this.chartInstances.chart1.resize();
              }
                  } catch (e) {
                    console.warn('å›¾è¡¨1 resize å¤±è´¥:', e);
                  }
                  // æ£€æŸ¥å›¾è¡¨2ï¼šå®ä¾‹å­˜åœ¨ä¸” DOM å­˜åœ¨
                  try {
                    if (this.chartInstances.chart2 && 
                        this.chartInstances.chart2.resize && 
                        this.$refs.chart2) {
                this.chartInstances.chart2.resize();
                    }
                  } catch (e) {
                    console.warn('å›¾è¡¨2 resize å¤±è´¥:', e);
                  }
                }, 100);
              };
              
              // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              if (this._chartResizeHandler) {
                window.removeEventListener('resize', this._chartResizeHandler);
              }
              
              // æ·»åŠ æ–°çš„ç›‘å¬å™¨
              this._chartResizeHandler = handleResize;
              window.addEventListener('resize', handleResize);
              
            } catch (error) {
              console.error('åˆå§‹åŒ–å›¾è¡¨å¤±è´¥:', error);
            }
          });
        },

        // ========== ECO å˜æ›´ç®¡ç†ç›¸å…³æ–¹æ³• ==========
        // æ‰“å¼€ ECO å¼¹çª—
        openEcoModal() {
          this.newEco = {
            eco_no: '',
            description: '',
            op: '',
            start_set: '',
            change_details: '',
            materials: [],
            status: 'è¿›è¡Œä¸­',
            issue_date: '',
            issue_time: ''
          };
          this.currentEcoMaterial = { material: '', start_set: '', change_details: '' };
          this.showEcoModal = true;
        },

        // å…³é—­ ECO å¼¹çª—
        closeEcoModal() {
          this.showEcoModal = false;
        },

        // æ·»åŠ  ECO ç‰©æ–™
        addEcoMaterial() {
          const material = (this.currentEcoMaterial.material || '').trim();
          if (!material) {
            alert('è¯·è¾“å…¥ç‰©æ–™å·');
            return;
          }
          this.newEco.materials.push(material);
          this.currentEcoMaterial.material = '';
        },

        // åˆ é™¤ ECO ç‰©æ–™
        removeEcoMaterial(index) {
          this.newEco.materials.splice(index, 1);
        },

        // ä¿å­˜ ECO
        saveEco() {
          if (!this.newEco.eco_no || !this.newEco.description || !this.newEco.op || !this.newEco.start_set) {
            alert('è¯·å¡«å†™å¿…å¡«é¡¹ï¼ˆECOå·ã€äº§å“æè¿°ã€å·¥åºã€èµ·å§‹å°å¥—ï¼‰');
            return;
          }
          if (!this.newEco.materials || this.newEco.materials.length === 0) {
            alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªç‰©æ–™');
            return;
          }

          const ecoItem = {
            ...this.newEco,
            update_time: new Date().toLocaleString('zh-CN')
          };
          
          this.ecoList.push(ecoItem);
          
          // ä¿å­˜åˆ° localStorage
          try {
            localStorage.setItem('ecoList', JSON.stringify(this.ecoList));
          } catch (e) {
            console.error('ä¿å­˜ ECO æ•°æ®å¤±è´¥:', e);
          }

          alert('ECO ä¿å­˜æˆåŠŸ');
          this.closeEcoModal();
        },

        // æ‰§è¡Œ ECO - é‡å†™
        executeEco(item, index) {
          if (confirm(`ç¡®å®šè¦å°† ECO-${item.eco_no} æ ‡è®°ä¸º"å·²å®Œæˆ"å—ï¼Ÿ`)) {
            // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•ï¼ˆè€ƒè™‘è¿‡æ»¤åçš„åˆ—è¡¨ï¼‰
            const actualIndex = this.ecoList.findIndex(eco => eco.eco_no === item.eco_no);
            if (actualIndex === -1) {
              alert('æœªæ‰¾åˆ°å¯¹åº”çš„ ECO è®°å½•');
              return;
            }

            // æ›´æ–°çŠ¶æ€ä¸º"å·²å®Œæˆ"
            this.ecoList[actualIndex].status = 'å·²å®Œæˆ';
            
            // è·å–å½“å‰ç³»ç»Ÿæ—¶é—´ï¼Œæ ¼å¼åŒ–ä¸º YYYY-MM-DD HH:mm
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            // èµ‹å€¼ç»™ update_timeï¼ˆå˜æ›´æ—¶é—´ï¼‰
            this.ecoList[actualIndex].update_time = `${year}-${month}-${day} ${hours}:${minutes}`;
            
            // ä¿å­˜åˆ° localStorage
            try {
              localStorage.setItem('ecoList', JSON.stringify(this.ecoList));
            } catch (e) {
              console.error('ä¿å­˜ ECO æ•°æ®å¤±è´¥:', e);
              alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
              return;
            }
            
            alert('ECO å·²æ ‡è®°ä¸ºå·²å®Œæˆ');
          }
        },

        // å¯¼å‡º ECO åˆ° Excel
        exportEcoToExcel() {
          if (!this.ecoList || this.ecoList.length === 0) {
            alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
            return;
          }

          try {
            // å‡†å¤‡å¯¼å‡ºæ•°æ® - ä¸¥æ ¼æŒ‰ç…§ç½‘é¡µæ˜¾ç¤ºæ ¼å¼
            const exportData = this.ecoList.map(item => {
              // æ ¼å¼åŒ–èµ·å§‹å°å¥—ï¼šç¬¬ X å°èµ·
              let startSetFormatted = '';
              if (item.start_set) {
                startSetFormatted = `ç¬¬ ${item.start_set} å°èµ·`;
              }

              // æ ¼å¼åŒ–æ¶‰åŠç‰©æ–™ï¼šæ•°ç»„è½¬ä¸ºé€—å·åˆ†éš”å­—ç¬¦ä¸²
              let materialsFormatted = '';
              if (item.materials && Array.isArray(item.materials) && item.materials.length > 0) {
                materialsFormatted = item.materials.join(', ');
              }

              // æ ¼å¼åŒ–å˜æ›´çŠ¶æ€ï¼šå°†"ä¸ç”¨å†™"è½¬æ¢ä¸º"å¾…æ‰§è¡Œ"ï¼ˆä¸ç½‘é¡µæ˜¾ç¤ºä¸€è‡´ï¼‰
              let statusFormatted = item.status || '';
              if (statusFormatted === 'ä¸ç”¨å†™') {
                statusFormatted = 'å¾…æ‰§è¡Œ';
              }

              // æ„å»ºå¯¼å‡ºå¯¹è±¡ï¼Œä½¿ç”¨ä¸­æ–‡åˆ—å
              return {
                'ECOå·': item.eco_no || '',
                'äº§å“æè¿°': item.description || '',
                'å·¥åº': item.op || '',
                'èµ·å§‹å°å¥—': startSetFormatted,
                'æ¶‰åŠç‰©æ–™': materialsFormatted,
                'å˜æ›´è¯¦æƒ…': item.change_details || '',
                'ä¸‹å‘æ—¥æœŸ': item.issue_date || '',
                'ä¸‹å‘æ—¶é—´': item.issue_time || '',
                'å˜æ›´æ—¶é—´': item.update_time || '',
                'å˜æ›´çŠ¶æ€': statusFormatted
              };
            });

            // åˆ›å»ºå·¥ä½œç°¿
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ECOå˜æ›´åˆ—è¡¨');

            // å¯¼å‡ºæ–‡ä»¶ - æ–‡ä»¶åæ ¼å¼ï¼šECOå˜æ›´ç®¡ç†_YYYYMMDD.xlsx
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const fileName = `ECOå˜æ›´ç®¡ç†_${year}${month}${day}.xlsx`;
            
            XLSX.writeFile(workbook, fileName);
            
            alert(`æˆåŠŸå¯¼å‡º ${exportData.length} æ¡æ•°æ®ï¼`);
          } catch (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
            alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        },

        // æŸ¥çœ‹ ECO è¯¦æƒ…
        viewEcoDetail(item) {
          const materialsList = this.getEcoMaterialsFullList(item);
          alert(`ECO-${item.eco_no}\n\näº§å“æè¿°ï¼š${item.description}\nå·¥åºï¼š${item.op}\nèµ·å§‹å°å¥—ï¼šç¬¬ ${item.start_set} å°èµ·\nå˜æ›´è¯¦æƒ…ï¼š${item.change_details || 'æ— '}\n\næ¶‰åŠç‰©æ–™ï¼š\n${materialsList}`);
        },

        // è·å– ECO ç‰©æ–™æ‘˜è¦
        getEcoMaterialsSummary(item) {
          const materials = item.materials || [];
          if (materials.length === 0) return '-';
          if (materials.length === 1) {
            return typeof materials[0] === 'string' ? materials[0] : materials[0].material || '';
          }
          // å¤šä¸ªç‰©æ–™ï¼šæ˜¾ç¤ºç¬¬ä¸€ä¸ª + "ç­‰xé¡¹"
          const firstMaterial = typeof materials[0] === 'string' ? materials[0] : materials[0].material || '';
          return `${firstMaterial} ç­‰${materials.length}é¡¹`;
        },

        // è·å– ECO ç‰©æ–™å®Œæ•´åˆ—è¡¨
        getEcoMaterialsFullList(item) {
          const materials = item.materials || [];
          return materials.map((mat, idx) => {
            const matStr = typeof mat === 'string' ? mat : mat.material || '';
            return `${idx + 1}. ${matStr}`;
          }).join('\n');
        },

        // è§¦å‘ ECO å¯¼å…¥
        triggerEcoImport() {
          if (this.$refs.ecoFileInput) {
            this.$refs.ecoFileInput.click();
          }
        },

        // æ ¼å¼åŒ–åˆ°è¾¾æ—¶é—´æ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºæ—¶é—´éƒ¨åˆ† HH:mmï¼‰
        formatArrivalTime(item) {
          // ä¼˜å…ˆä½¿ç”¨ arrival_timeï¼ˆå·²ç»æ˜¯ HH:mm æ ¼å¼ï¼‰
          if (item.arrival_time && typeof item.arrival_time === 'string' && item.arrival_time.includes(':')) {
            return item.arrival_time.substring(0, 5);
          }
          if (item.åˆ°è¾¾æ—¶é—´ && typeof item.åˆ°è¾¾æ—¶é—´ === 'string' && item.åˆ°è¾¾æ—¶é—´.includes(':')) {
            return item.åˆ°è¾¾æ—¶é—´.substring(0, 5);
          }
          // å¦‚æœ arrival_time_formatted å­˜åœ¨ï¼Œæå–æ—¶é—´éƒ¨åˆ†
          if (item.arrival_time_formatted && typeof item.arrival_time_formatted === 'string') {
            const parts = item.arrival_time_formatted.split(' ');
            if (parts.length > 1 && parts[1].includes(':')) {
              return parts[1].substring(0, 5);
            }
          }
          if (item.åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ– && typeof item.åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ– === 'string') {
            const parts = item.åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ–.split(' ');
            if (parts.length > 1 && parts[1].includes(':')) {
              return parts[1].substring(0, 5);
            }
          }
          // å¦‚æœ arrival_time æ˜¯æ•°å­—ï¼ˆExcelå°æ•°ï¼‰ï¼Œæ ¼å¼åŒ–å®ƒ
          if (typeof item.arrival_time === 'number' && item.arrival_time >= 0 && item.arrival_time < 1) {
            return this.formatExcelTime(item.arrival_time);
          }
          if (typeof item.åˆ°è¾¾æ—¶é—´ === 'number' && item.åˆ°è¾¾æ—¶é—´ >= 0 && item.åˆ°è¾¾æ—¶é—´ < 1) {
            return this.formatExcelTime(item.åˆ°è¾¾æ—¶é—´);
          }
          return item.arrival_time || item.åˆ°è¾¾æ—¶é—´ || item.arrival_time_formatted || item.åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ– || item.åˆ°åœºæ—¶é—´ || '--';
        },

        // 1. è¾…åŠ©å‡½æ•°ï¼šå¤„ç† Excel çš„æ—¥æœŸæ ¼å¼ (æ•°å­—è½¬ YYYY-MM-DD)
        formatExcelDate(serial) {
          if (!serial && serial !== 0) return '--';
          // å¦‚æœå·²ç»æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œå°è¯•è§£ææˆ–ç›´æ¥è¿”å›
          if (typeof serial === 'string') {
            const trimmed = serial.trim();
            if (!trimmed) return '--';
            // å¦‚æœåŒ…å«ç©ºæ ¼ï¼Œè¯´æ˜æœ‰æ—¥æœŸæ—¶é—´æ ¼å¼ï¼ˆå¦‚ "2025-12-30 20:14"ï¼‰ï¼Œæˆªå–å‰10ä½
            if (trimmed.includes(' ')) {
              const datePart = trimmed.substring(0, 10);
              // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼
              if (/^\d{4}-\d{2}-\d{2}$/.test(datePart)) {
                return datePart;
              }
            }
            // å¦‚æœå·²ç»æ˜¯ YYYY-MM-DD æ ¼å¼ï¼Œç›´æ¥è¿”å›
            if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
              return trimmed;
            }
            // å°è¯•è§£æå…¶ä»–æ—¥æœŸæ ¼å¼
            const dateMatch = trimmed.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
            if (dateMatch) {
              const year = dateMatch[1];
              const month = String(parseInt(dateMatch[2], 10)).padStart(2, '0');
              const day = String(parseInt(dateMatch[3], 10)).padStart(2, '0');
              return `${year}-${month}-${day}`;
            }
            return trimmed;
          }
          // Excel åºåˆ—å·è½¬æ—¥æœŸ (1900-01-01 æ˜¯åºåˆ—å· 1)
          // æ³¨æ„ï¼šExcel æ—¥æœŸä» 1900-01-01 å¼€å§‹ï¼Œä½† Excel é”™è¯¯åœ°å°† 1900 å¹´è§†ä¸ºé—°å¹´
          // æ‰€ä»¥ä½¿ç”¨ 25569 ä½œä¸ºåŸºå‡†ï¼ˆ1970-01-01 çš„åºåˆ—å·ï¼‰
          if (typeof serial === 'number') {
            const date = new Date((serial - 25569) * 86400 * 1000);
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
          }
          return '--';
        },

        // ========== é‡å†™ï¼šé€šç”¨æ—¥æœŸæ¸…æ´—å‡½æ•°ï¼ˆUTC æ•´æ•°è¿ç®—ï¼Œé¿å…æ—¶åŒºåå·®ï¼‰ ==========
        // æ— è®ºè¾“å…¥æ˜¯ Excel æ•°å­—ã€è¿˜æ˜¯å¸¦æ—¶é—´çš„å­—ç¬¦ä¸²ï¼Œç»Ÿä¸€è¿”å› "YYYY-MM-DD" æ ¼å¼
        normalizeDate(input) {
          if (!input && input !== 0) return '';
          
          // 1. å¤„ç† Excel åºåˆ—å· (æ•°å­—) - æ ¸å¿ƒä¿®å¤
          if (typeof input === 'number') {
            // Math.floor å–æ•´ï¼Œèˆå¼ƒæ—¶é—´éƒ¨åˆ†ï¼Œåªä¿ç•™æ—¥æœŸ
            const serial = Math.floor(input);
            // ä½¿ç”¨ UTC æ—¶é—´è®¡ç®—ï¼Œé¿å…æ—¶åŒºåç§»
            // 25569 æ˜¯ Excel (1900-01-01) åˆ° Unix (1970-01-01) çš„å¤©æ•°å·®
            const date = new Date((serial - 25569) * 86400 * 1000);
            
            const y = date.getUTCFullYear();
            const m = String(date.getUTCMonth() + 1).padStart(2, '0');
            const d = String(date.getUTCDate()).padStart(2, '0');
            
            return `${y}-${m}-${d}`;
          }
          
          // 2. å¤„ç†å­—ç¬¦ä¸² (å¦‚ "2025-12-30 13:02")
          if (typeof input === 'string') {
            // ç›´æ¥æˆªå–å‰ 10 ä½ï¼Œä¸è¿›è¡Œ Date å¯¹è±¡è½¬æ¢ï¼Œé˜²æ­¢æ—¶åŒºå¹²æ‰°
            return input.trim().substring(0, 10);
          }
          
          return '';
        },

        // ========== æ™ºèƒ½åˆ—åæŸ¥æ‰¾å‡½æ•° ==========
        // éå† row çš„æ‰€æœ‰ keyï¼Œå¦‚æœ key åŒ…å« keywords ä¸­çš„ä»»æ„ä¸€ä¸ªï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼Œå¿½ç•¥ç©ºæ ¼ï¼‰ï¼Œå°±è¿”å›è¯¥ key å¯¹åº”çš„å€¼
        // ä¾‹å¦‚ï¼šfindColumnValue(row, ['Date', 'æ—¥æœŸ']) èƒ½åŒ¹é…åˆ° "Transaction Date", "Date ", "æ”¶è´§æ—¥æœŸ" ç­‰
        findColumnValue(row, keywords) {
          if (!row || !keywords || keywords.length === 0) {
            return null;
          }
          
          // å°† keywords è½¬æ¢ä¸ºå°å†™ï¼Œå»é™¤ç©ºæ ¼ï¼Œç”¨äºåŒ¹é…
          const normalizedKeywords = keywords.map(k => k.toLowerCase().replace(/\s+/g, ''));
          
          // éå† row çš„æ‰€æœ‰ key
          for (const key in row) {
            if (row.hasOwnProperty(key)) {
              // å°† key æ ‡å‡†åŒ–ï¼šè½¬å°å†™ï¼Œå»é™¤ç©ºæ ¼
              const normalizedKey = key.toLowerCase().replace(/\s+/g, '');
              
              // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»æ„ä¸€ä¸ª keyword
              for (const keyword of normalizedKeywords) {
                if (normalizedKey.includes(keyword) || keyword.includes(normalizedKey)) {
                  return row[key];
                }
              }
            }
          }
          
          return null;
        },

        // ========== è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—æ—¥æœŸçš„å‰ä¸€å¤©å’Œåä¸€å¤© ==========
        // è¾“å…¥ï¼šYYYY-MM-DD æ ¼å¼çš„å­—ç¬¦ä¸²
        // è¿”å›ï¼š{ prevDay: 'YYYY-MM-DD', nextDay: 'YYYY-MM-DD' }
        getAdjacentDates(dateStr) {
          if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
            return { prevDay: '', nextDay: '' };
          }
          
          const [year, month, day] = dateStr.split('-').map(Number);
          const date = new Date(year, month - 1, day);
          
          // å‰ä¸€å¤©
          const prevDate = new Date(date);
          prevDate.setDate(prevDate.getDate() - 1);
          const prevDay = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}-${String(prevDate.getDate()).padStart(2, '0')}`;
          
          // åä¸€å¤©
          const nextDate = new Date(date);
          nextDate.setDate(nextDate.getDate() + 1);
          const nextDay = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;
          
          return { prevDay, nextDay };
        },

        // 2. è¾…åŠ©å‡½æ•°ï¼šå¤„ç† Excel çš„æ—¶é—´æ ¼å¼ (å°æ•°è½¬ HH:mm)
        formatExcelTime(decimal) {
          if (!decimal && decimal !== 0) return '--';
          // å¦‚æœå·²ç»æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œç›´æ¥è¿”å›
          if (typeof decimal === 'string') {
            const trimmed = decimal.trim();
            if (!trimmed) return '--';
            // å¦‚æœå·²ç»æ˜¯ HH:mm æ ¼å¼ï¼Œç›´æ¥è¿”å›
            const timeMatch = trimmed.match(/(\d{1,2}):(\d{2})/);
            if (timeMatch) {
              const hours = String(parseInt(timeMatch[1], 10)).padStart(2, '0');
              const minutes = timeMatch[2];
              return `${hours}:${minutes}`;
            }
            return trimmed;
          }
          // Excel å°æ•°è½¬æ—¶é—´ (0-1ä¹‹é—´çš„å°æ•°ï¼Œè¡¨ç¤ºä¸€å¤©ä¸­çš„æ¯”ä¾‹)
          if (typeof decimal === 'number' && decimal >= 0 && decimal < 1) {
            const totalSeconds = Math.floor(decimal * 86400);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
          }
          return '--';
        },

        // 3. è¾…åŠ©å‡½æ•°ï¼šç»„åˆ Excel æ—¥æœŸå’Œæ—¶é—´åºåˆ—å·ä¸º YYYY-MM-DD HH:mm
        formatExcelDateTime(dateSerial, timeDecimal) {
          const dateStr = this.formatExcelDate(dateSerial);
          const timeStr = this.formatExcelTime(timeDecimal);
          if (dateStr === '--' || timeStr === '--') {
            return dateStr !== '--' ? dateStr : (timeStr !== '--' ? timeStr : '--');
          }
          return `${dateStr} ${timeStr}`;
        },

        // 3. æ ¸å¿ƒä¸Šä¼ é€»è¾‘ - é‡å†™
        handleEcoImport(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet);

              console.log('è¯»å–åˆ°çš„åŸå§‹ ECO æ•°æ®:', jsonData);
              if (jsonData.length > 0) {
                console.log('ç¬¬ä¸€è¡ŒåŸå§‹æ•°æ®:', jsonData[0]);
                console.log('æ‰€æœ‰è¡¨å¤´:', Object.keys(jsonData[0]));
              }

              // æ˜ å°„å¹¶æ¸…æ´—æ•°æ®
              const processedData = jsonData.map((row) => {
                // ECOå·æ˜ å°„
                const ecoNo = String(row['ECOå·'] || '').trim();
                if (!ecoNo) {
                  return null; // è·³è¿‡æ²¡æœ‰ ECO å·çš„è¡Œ
                }

                // å°å¥—è§£æï¼šä½¿ç”¨æ­£åˆ™æå–æ•°å­—
                let startSet = row['å°å¥—'] || row['èµ·å§‹å°å¥—'] || '';
                if (startSet) {
                  if (typeof startSet === 'string') {
                    // ä½¿ç”¨æ­£åˆ™ /\d+/ æå–çº¯æ•°å­—ï¼ˆä¾‹å¦‚æŠŠ "ç¬¬21å°" å˜æˆ 21ï¼‰
                    const match = String(startSet).match(/\d+/);
                    if (match) {
                      startSet = parseInt(match[0], 10);
                    } else {
                      startSet = '';
                    }
                  } else if (typeof startSet === 'number') {
                    startSet = startSet;
                  } else {
                    startSet = '';
                  }
                } else {
                  startSet = '';
                }

                // ç‰©æ–™å·æ˜ å°„ï¼šè½¬ä¸ºæ•°ç»„
                let materials = [];
                const materialValue = row['ç‰©æ–™å·'] || '';
                if (materialValue) {
                  const matStr = String(materialValue).trim();
                  if (matStr) {
                    // æ”¯æŒé€—å·åˆ†éš”çš„å¤šä¸ªç‰©æ–™å·
                    materials = matStr.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
                  }
                }

                // å¤„ç†å˜æ›´æ—¶é—´ï¼šå¦‚æœ Excel ä¸­æœ‰"å˜æ›´æ—¶é—´"å­—æ®µï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä¸ºç©º
                let updateTime = '';
                const changeTimeRaw = row['å˜æ›´æ—¶é—´'] || row['æ›´æ–°æ—¶é—´'] || '';
                if (changeTimeRaw) {
                  // å¦‚æœæ˜¯æ—¥æœŸæ ¼å¼ï¼Œè½¬æ¢ä¸º YYYY-MM-DD HH:mm
                  if (typeof changeTimeRaw === 'string') {
                    // å°è¯•è§£ææ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²
                    const dateTimeMatch = changeTimeRaw.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})[\s\T](\d{1,2}):(\d{2})/);
                    if (dateTimeMatch) {
                      const y = dateTimeMatch[1];
                      const m = String(parseInt(dateTimeMatch[2], 10)).padStart(2, '0');
                      const d = String(parseInt(dateTimeMatch[3], 10)).padStart(2, '0');
                      const h = String(parseInt(dateTimeMatch[4], 10)).padStart(2, '0');
                      const min = dateTimeMatch[5];
                      updateTime = `${y}-${m}-${d} ${h}:${min}`;
                    } else {
                      // å¦‚æœåªæ˜¯æ—¥æœŸï¼Œæ·»åŠ é»˜è®¤æ—¶é—´
                      const dateOnly = this.formatExcelDate(changeTimeRaw);
                      if (dateOnly && dateOnly !== '--') {
                        updateTime = `${dateOnly} 00:00`;
                      }
                    }
                  } else if (typeof changeTimeRaw === 'number') {
                    // å¦‚æœæ˜¯ Excel åºåˆ—å·ï¼Œè½¬æ¢ä¸ºæ—¥æœŸæ—¶é—´
                    const dateStr = this.formatExcelDate(changeTimeRaw);
                    if (dateStr && dateStr !== '--') {
                      updateTime = `${dateStr} 00:00`;
                    }
                  }
                }

                // æ„å»ºæ•°æ®å¯¹è±¡
                const ecoItem = {
                  eco_no: ecoNo,
                description: String(row['äº§å“æè¿°'] || '').trim(),
                  op: String(row['å·¥åº'] || '').trim(),
                  start_set: startSet,
                  materials: materials,
                  issue_date: this.formatExcelDate(row['ä¸‹å‘æ—¥æœŸ'] || ''),
                  issue_time: this.formatExcelTime(row['ä¸‹å‘æ—¶é—´'] || ''),
                  status: String(row['å˜æ›´çŠ¶æ€'] || 'è¿›è¡Œä¸­').trim(),
                change_details: String(row['å˜æ›´è¯¦æƒ…'] || '').trim(),
                  operator: String(row['é…æ–™å‘˜'] || '').trim(),
                  update_time: updateTime || '' // å¦‚æœ Excel ä¸­æœ‰å˜æ›´æ—¶é—´ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä¸ºç©º
                };

                return ecoItem;
              }).filter(item => item !== null && item.eco_no); // è¿‡æ»¤ç©ºè¡Œ

              // æ›´æ–°æ•°æ®æº
              this.ecoList = processedData;
              
              // æŒä¹…åŒ–ä¿å­˜
              try {
                localStorage.setItem('ecoList', JSON.stringify(this.ecoList));
              } catch (e) {
                console.error('ä¿å­˜ ECO æ•°æ®å¤±è´¥:', e);
                alert('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                event.target.value = '';
                return;
              }

              alert(`æˆåŠŸå¯¼å…¥ ${this.ecoList.length} æ¡ ECO æ•°æ®ï¼`);
              
              // æ¸…ç©º input å…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
              event.target.value = '';

            } catch (error) {
              console.error('ECO ä¸Šä¼ å¤±è´¥:', error);
              alert('è§£æ Excel å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼š' + error.message);
              event.target.value = '';
            }
          };

          reader.onerror = () => {
            alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            event.target.value = '';
          };

          reader.readAsArrayBuffer(file);
        },

        // åˆ·æ–° ECO æ•°æ®
        refreshEcoData() {
          try {
            const saved = localStorage.getItem('ecoList');
            if (saved) {
              this.ecoList = JSON.parse(saved);
              alert('æ•°æ®å·²åˆ·æ–°');
            } else {
              alert('æš‚æ— ä¿å­˜çš„æ•°æ®');
            }
          } catch (e) {
            console.error('è¯»å– ECO æ•°æ®å¤±è´¥:', e);
            alert('è¯»å–æ•°æ®å¤±è´¥');
          }
        },

        // ========== å·¥å•é…æ–™ç›¸å…³æ–¹æ³• ==========
        // è§¦å‘ç”Ÿäº§è®¡åˆ’æ–‡ä»¶ä¸Šä¼ ï¼ˆå·¥å•é…æ–™ï¼‰
        triggerPlanFileUploadKitting() {
          if (this.$refs.planFileInputKitting) {
            this.$refs.planFileInputKitting.click();
          }
        },

        // å¤„ç†ç”Ÿäº§è®¡åˆ’æ–‡ä»¶ä¸Šä¼ ï¼ˆå·¥å•é…æ–™ï¼‰
        handlePlanFileUploadKitting(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: '' });

              // å­—æ®µæ˜ å°„ï¼šå·¥å•å·->work_order, å·¥åº->op, åˆ°è¾¾æ—¥æœŸ->arrival_date, åˆ°è¾¾æ—¶é—´->arrival_time
              this.planData = jsonData.map(row => {
                const workOrder = String(row['å·¥å•å·'] || '').trim();
                const op = String(row['å·¥åº'] || row['OP'] || '').trim();
                
                // è§£æåˆ°è¾¾æ—¥æœŸ
                const arrivalDateRaw = row['åˆ°è¾¾æ—¥æœŸ'] || row['ä½¿ç”¨æ—¥æœŸ'] || '';
                const arrivalDate = this.formatExcelDate(arrivalDateRaw);
                
                // è§£æåˆ°è¾¾æ—¶é—´ï¼šå¼ºåˆ¶æ ¼å¼åŒ–ä¸º HH:mm
                const arrivalTimeRaw = row['åˆ°è¾¾æ—¶é—´'] || '';
                let arrivalTime = '';
                let timeDecimal = null;
                
                // å¤„ç†Excelåºåˆ—å·ï¼ˆå¦‚45988.35ï¼‰ï¼šå¦‚æœå€¼>1ï¼Œå–å°æ•°éƒ¨åˆ†
                if (typeof arrivalTimeRaw === 'number') {
                  if (arrivalTimeRaw >= 1) {
                    // åŒ…å«æ—¥æœŸï¼Œå–å°æ•°éƒ¨åˆ†
                    timeDecimal = arrivalTimeRaw % 1;
                  } else if (arrivalTimeRaw >= 0 && arrivalTimeRaw < 1) {
                    // çº¯æ—¶é—´å°æ•°
                    timeDecimal = arrivalTimeRaw;
                  }
                  
                  if (timeDecimal !== null) {
                    // è®¡ç®—å°æ—¶å’Œåˆ†é’Ÿ
                    const hours = Math.floor(timeDecimal * 24);
                    const minutes = Math.round((timeDecimal * 24 % 1) * 60);
                    arrivalTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                  }
                }
                // å¦‚æœè¯»å–åˆ°çš„æ˜¯æ—¥æœŸå¯¹è±¡ï¼Œæå–æ—¶é—´éƒ¨åˆ†
                else if (arrivalTimeRaw instanceof Date) {
                  const hours = String(arrivalTimeRaw.getHours()).padStart(2, '0');
                  const minutes = String(arrivalTimeRaw.getMinutes()).padStart(2, '0');
                  arrivalTime = `${hours}:${minutes}`;
                }
                // å¦‚æœå·²ç»æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
                else if (typeof arrivalTimeRaw === 'string') {
                  const timeStr = arrivalTimeRaw.trim();
                  // å¦‚æœåŒ…å«æ—¥æœŸæ—¶é—´æ ¼å¼ï¼Œåªæå–æ—¶é—´éƒ¨åˆ†
                  if (timeStr.includes(' ') && timeStr.includes(':')) {
                    const timePart = timeStr.split(' ')[1] || timeStr.split(' ')[0];
                    const timeMatch = timePart.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                      const hours = String(parseInt(timeMatch[1], 10)).padStart(2, '0');
                      const minutes = timeMatch[2];
                      arrivalTime = `${hours}:${minutes}`;
                  } else {
                      arrivalTime = timePart.substring(0, 5);
                    }
                  }
                  // å¦‚æœåªæ˜¯æ—¶é—´æ ¼å¼ HH:mm
                  else if (timeStr.match(/\d{1,2}:\d{2}/)) {
                    arrivalTime = timeStr.substring(0, 5);
                  }
                  // å°è¯•è§£æä¸ºæ•°å­—å­—ç¬¦ä¸²
                  else {
                    const numVal = parseFloat(timeStr);
                    if (!isNaN(numVal)) {
                      if (numVal >= 1) {
                        timeDecimal = numVal % 1;
                      } else if (numVal >= 0) {
                        timeDecimal = numVal;
                      }
                      if (timeDecimal !== null) {
                        const hours = Math.floor(timeDecimal * 24);
                        const minutes = Math.round((timeDecimal * 24 % 1) * 60);
                        arrivalTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                      }
                    }
                  }
                }
                
                // å¦‚æœä»æœªè§£ææˆåŠŸï¼Œä½¿ç”¨formatExcelTimeä½œä¸ºåå¤‡
                if (!arrivalTime) {
                  arrivalTime = this.formatExcelTime(arrivalTimeRaw);
                }
                
                // ç»„åˆæ—¥æœŸæ—¶é—´ï¼ˆç”¨äºå®Œæ•´æ˜¾ç¤ºï¼‰
                const arrivalTimeFormatted = arrivalTime && arrivalTime !== '--' 
                  ? `${arrivalDate || '--'} ${arrivalTime}` 
                  : '--';

                return {
                  work_order: workOrder,
                  op: op,
                  arrival_time: arrivalTime,
                  arrival_date: arrivalDate,
                  arrival_time_formatted: arrivalTimeFormatted,
                  description: String(row['äº§å“æè¿°'] || '').trim(),
                  seq_no: String(row['åŠ å·¥åºåˆ—å·'] || row['å°å¥—'] || '').trim(),
                  line: String(row['äº§çº¿'] || row['äº§çº¿åç§°'] || '').trim(),
                  trip_no: String(row['è½¦æ¬¡'] || '').trim(),
                  'å·¥å•å·': workOrder,
                  'OP': op,
                  'åˆ°è¾¾æ—¶é—´': arrivalTime,
                  'åˆ°è¾¾æ—¥æœŸ': arrivalDate,
                  'åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ–': arrivalTimeFormatted,
                  'äº§å“æè¿°': String(row['äº§å“æè¿°'] || '').trim(),
                  'åŠ å·¥åºåˆ—å·': String(row['åŠ å·¥åºåˆ—å·'] || row['å°å¥—'] || '').trim(),
                  'äº§çº¿': String(row['äº§çº¿'] || row['äº§çº¿åç§°'] || '').trim(),
                  'è½¦æ¬¡': String(row['è½¦æ¬¡'] || '').trim()
                };
              }).filter(item => item.work_order && item.op);

              console.log('è§£æåçš„ç”Ÿäº§è®¡åˆ’æ•°æ®:', this.planData);
              
              // åŒæ­¥æ•°æ®åˆ°ç”Ÿäº§è®¡åˆ’è¡¨ï¼Œå¹¶æ·»åŠ æ›´æ–°æ—¶é—´
              const updateTime = new Date().toLocaleString('zh-CN');
              const syncedPlanData = this.planData.map(item => ({
                ...item,
                update_time: updateTime,
                æ›´æ–°æ—¶é—´: updateTime,
                line: item.line || '',
                äº§çº¿: item.line || '',
                trip_no: item.trip_no || '',
                è½¦æ¬¡: item.trip_no || ''
              }));
              
              // æ›´æ–° productionPlanData
              this.productionPlanData = syncedPlanData;
              
              // ä¿å­˜åˆ° localStorage
              try {
                localStorage.setItem('productionPlanData', JSON.stringify(syncedPlanData));
                localStorage.setItem('planUpdateTime', updateTime);
              } catch (e) {
                console.error('ä¿å­˜åˆ° localStorage å¤±è´¥:', e);
              }

              this.matchWorkOrders();
              alert(`æˆåŠŸå¯¼å…¥ ${this.planData.length} æ¡ç”Ÿäº§è®¡åˆ’æ•°æ®`);
              event.target.value = '';
            } catch (error) {
              console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
              alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
              event.target.value = '';
            }
          };

          reader.onerror = () => {
            alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            event.target.value = '';
          };

          reader.readAsArrayBuffer(file);
        },

        // è§¦å‘ BOM æ–‡ä»¶ä¸Šä¼ 
        triggerBomFileUpload() {
          if (this.$refs.bomFileInput) {
            this.$refs.bomFileInput.click();
          }
        },

        // å¤„ç† BOM æ–‡ä»¶ä¸Šä¼ 
        handleBomFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: '' });

              // å­—æ®µæ˜ å°„ï¼šå™¨å…·->tool_type, å®é™…æ•°é‡->remark
              this.bomData = jsonData.map(row => {
                const job = String(row['Job'] || row['å·¥å•å·'] || '').trim();
                const op = String(row['OP'] || row['å·¥åº'] || '').trim();
                
                return {
                  'Job': job,
                  'OP': op,
                  'Component': String(row['Component'] || row['ç‰©æ–™å·'] || '').trim(),
                  'PENDING_LOCATOR': String(row['PENDING_LOCATOR'] || row['åº“ä½'] || '').trim(),
                  'Required': String(row['Required'] || row['æ•°é‡'] || '').trim(),
                  'tool_type': String(row['å™¨å…·'] || '').trim(),
                  'remark': String(row['å®é™…æ•°é‡'] || row['å¤‡æ³¨'] || '').trim(),
                  'å¤‡æ³¨': String(row['å®é™…æ•°é‡'] || row['å¤‡æ³¨'] || '').trim()
                };
              }).filter(item => item.Job && item.OP && item.Component);

              console.log('è§£æåçš„BOMæ•°æ®:', this.bomData);
              this.matchWorkOrders();
              alert(`æˆåŠŸå¯¼å…¥ ${this.bomData.length} æ¡ BOM æ•°æ®`);
              event.target.value = '';
            } catch (error) {
              console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
              alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
              event.target.value = '';
            }
          };

          reader.onerror = () => {
            alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            event.target.value = '';
          };

          reader.readAsArrayBuffer(file);
        },

        // åŒ¹é…å·¥å•å’Œ BOM
        matchWorkOrders() {
          if (this.planData.length === 0 || this.bomData.length === 0) {
            this.matchedWorkOrders = [];
            return;
          }

          // æŒ‰ work_order + op åŒ¹é…
          const matchedMap = {};
          
          this.planData.forEach(plan => {
            const key = `${plan.work_order}|${plan.op}`;
            if (!matchedMap[key]) {
              // ç¬¬ä¸€æ¬¡å‡ºç°ï¼Œç›´æ¥åˆ›å»º
              matchedMap[key] = {
                ...plan,
                materials: []
              };
            } else {
              // å¦‚æœå·²å­˜åœ¨ï¼Œä¼˜å…ˆä¿ç•™æœ‰åˆ°è¾¾æ—¶é—´çš„è®°å½•
              const existingArrivalTime = matchedMap[key].arrival_time || matchedMap[key]['åˆ°è¾¾æ—¶é—´'] || '';
              const newArrivalTime = plan.arrival_time || plan['åˆ°è¾¾æ—¶é—´'] || '';
              
              // å¦‚æœç°æœ‰è®°å½•æ²¡æœ‰åˆ°è¾¾æ—¶é—´ï¼Œä½†æ–°è®°å½•æœ‰ï¼Œåˆ™æ›´æ–°ä¸ºæœ‰æ—¶é—´çš„è®°å½•
              if ((!existingArrivalTime || existingArrivalTime.trim() === '') && 
                  newArrivalTime && newArrivalTime.trim() !== '') {
                matchedMap[key] = {
                  ...plan,
                  materials: matchedMap[key].materials // ä¿ç•™å·²æœ‰çš„ç‰©æ–™
                };
              }
              // å¦‚æœç°æœ‰è®°å½•æœ‰åˆ°è¾¾æ—¶é—´ï¼Œä½†æ–°è®°å½•æ²¡æœ‰ï¼Œåˆ™ä¿æŒç°æœ‰è®°å½•ä¸å˜
              // å¦‚æœä¸¤è€…éƒ½æœ‰æˆ–éƒ½æ²¡æœ‰ï¼Œä¿æŒç°æœ‰è®°å½•ä¸å˜ï¼ˆä¼˜å…ˆä¿ç•™ç¬¬ä¸€æ¬¡ï¼‰
            }
          });

          // åŒ¹é… BOM æ•°æ®
          // ç»Ÿè®¡ç©ºå™¨å…·ç‰©æ–™æ•°é‡ï¼ˆç”¨äºé¢„è­¦ï¼‰- ä»…ç»Ÿè®¡ Pitch/SA14 äº§å“
          let emptyToolCount = 0;
          
          this.bomData.forEach(bom => {
            // 1. è¿‡æ»¤ AWï¼šå¦‚æœ tool_type === 'AW'ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼Œè·³è¿‡è¯¥ç‰©æ–™
            const toolType = String(bom.tool_type || bom['tool_type'] || '').trim();
            if (toolType.toUpperCase() === 'AW') {
              return; // è·³è¿‡ AW ç‰©æ–™ï¼Œä¸åŠ å…¥é…æ–™å•
            }
            
            // 2. ä¸¥æ ¼åŒ¹é…ï¼šåŒé‡é’¥åŒ™åŒ¹é…ï¼ˆå·¥å•å· AND OPï¼‰
            const bomJob = String(bom.Job || '').trim();
            const bomOP = String(bom.OP || '').trim();
            
            // å…ˆæ‰¾åˆ°åŒ¹é…çš„å·¥å•ï¼ˆç”¨äºåˆ¤æ–­äº§å“ç±»å‹å’Œç»Ÿè®¡ç©ºå™¨å…·ï¼‰
            let matchedWorkOrder = null;
            
            // éå† matchedMapï¼Œæ‰¾åˆ°å®Œå…¨åŒ¹é…çš„å·¥å•
            Object.keys(matchedMap).forEach(key => {
              const workOrder = matchedMap[key];
              const planWorkOrder = String(workOrder.work_order || workOrder['å·¥å•å·'] || '').trim();
              const planOP = String(workOrder.op || workOrder['OP'] || '').trim();
              
              // åŒé‡åŒ¹é…ï¼šå·¥å•å·å’ŒOPéƒ½å¿…é¡»å®Œå…¨ä¸€è‡´
              if (planWorkOrder === bomJob && planOP === bomOP) {
                matchedWorkOrder = workOrder;
                
                // åŒ¹é…æˆåŠŸï¼Œå°†ç‰©æ–™æ·»åŠ åˆ°å·¥å•
                workOrder.materials.push(bom);
                
                // å°† Plan çš„ arrival_time_formatted èµ‹ç»™ BOM ç‰©æ–™ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
                if (!bom.arrival_time_formatted && workOrder.arrival_time_formatted) {
                  bom.arrival_time_formatted = workOrder.arrival_time_formatted;
                  bom['åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ–'] = workOrder.arrival_time_formatted;
                }
                if (!bom.arrival_time && workOrder.arrival_time) {
                  bom.arrival_time = workOrder.arrival_time;
                  bom['åˆ°è¾¾æ—¶é—´'] = workOrder.arrival_time;
                }
              }
            });
            
            // 3. ç»Ÿè®¡ç©ºå™¨å…·ï¼ˆä»…ç»Ÿè®¡ Pitch/SA14 äº§å“ï¼‰
            // æ¡ä»¶ Aï¼šè¯¥å·¥å•å¯¹åº”çš„ product_description åŒ…å« "pitch" æˆ– "SA14"ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            // æ¡ä»¶ Bï¼šè¯¥ç‰©æ–™çš„ tool_type ä¸ºç©ºã€undefined æˆ–ç©ºå­—ç¬¦ä¸²
            if (matchedWorkOrder) {
              const productDesc = String(matchedWorkOrder.description || matchedWorkOrder['äº§å“æè¿°'] || '').trim().toLowerCase();
              const isPitchOrSA14 = productDesc.includes('pitch') || productDesc.includes('sa14');
              
              // åªæœ‰ Pitch/SA14 äº§å“ä¸”å™¨å…·ä¸ºç©ºæ—¶æ‰è®¡æ•°
              if (isPitchOrSA14 && (!toolType || toolType === '')) {
                emptyToolCount++;
              }
            }
          });

          // è½¬æ¢ä¸ºæ•°ç»„å¹¶åº”ç”¨ ECO æ‹¦æˆª
          this.matchedWorkOrders = Object.values(matchedMap).map(workOrder => {
            // ECO æ™ºèƒ½æ‹¦æˆªï¼šTriple Match
            workOrder.hasEco = false;
            if (workOrder.materials && workOrder.materials.length > 0) {
              workOrder.materials.forEach(material => {
                const component = String(material.Component || '').trim();
                const op = String(workOrder.op || '').trim();
                const seqNo = parseInt(workOrder.seq_no || workOrder['åŠ å·¥åºåˆ—å·'] || '0', 10) || 0;

                // æŸ¥æ‰¾åŒ¹é…çš„ ECO
                const matchedEco = (this.ecoList || []).find(eco => {
                  if (eco.op !== op) return false;
                  if (!eco.materials || eco.materials.length === 0) return false;
                  
                  const hasMaterial = eco.materials.some(mat => {
                    const matStr = typeof mat === 'string' ? mat : String(mat.material || '');
                    return matStr === component;
                  });
                  
                  if (!hasMaterial) return false;
                  
                  const startSet = parseInt(eco.start_set || '0', 10) || 0;
                  return seqNo >= startSet;
                });

                if (matchedEco) {
                  material.ecoInfo = {
                    ecoNo: matchedEco.eco_no,
                    changeDetails: matchedEco.change_details || ''
                  };
                  workOrder.hasEco = true;
                }
              });
            }
            return workOrder;
          });
          
          // 3. ç©ºå™¨å…·é¢„è­¦ï¼šåŒ¹é…ç»“æŸåï¼Œå¦‚æœæœ‰1ä¸ªæˆ–ä»¥ä¸Š Pitch/SA14 å…³é”®ç‰©æ–™ç¼ºå¤±å™¨å…·ä¿¡æ¯ï¼Œå¼¹å‡ºè­¦å‘Š
          if (emptyToolCount >= 1) {
            alert(`âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ° ${emptyToolCount} æ¡ Pitch/SA14 å…³é”®ç‰©æ–™ç¼ºå°‘'å™¨å…·'ä¿¡æ¯ï¼è¿™å°†å½±å“æ‰“å°æ‹†åˆ†ï¼Œè¯·æ£€æŸ¥ BOM è¡¨ã€‚`);
          }
        },

        // é€‰æ‹©å·¥å•ï¼ˆæ”¯æŒæ—¶é—´ç»„ï¼‰
        selectWorkOrder(index) {
          this.selectedWorkOrderIndex = index;
          this.printTime = new Date().toLocaleString('zh-CN');
          // æ¸…é™¤æ‰¹é‡æ‰“å°é¢„è§ˆ
          this.batchPrintPages = [];
          
          // å¦‚æœé€‰æ‹©çš„æ˜¯æ—¶é—´ç»„ï¼ˆPitchï¼‰ï¼Œéœ€è¦åˆå¹¶æ‰€æœ‰å·¥å•çš„ç‰©æ–™
          const group = this.groupedWorkOrderList[index];
          if (group && group.type === 'time_group') {
            // åˆ›å»ºä¸€ä¸ªåˆå¹¶çš„å·¥å•å¯¹è±¡ï¼ŒåŒ…å«è¯¥æ—¶é—´ç»„ä¸‹æ‰€æœ‰å·¥å•çš„ç‰©æ–™
            const mergedWorkOrder = {
              type: 'time_group',
              timeKey: group.timeKey,
              workOrders: group.workOrders || group.items || [],
              description: 'Pitch Axis- FFF',
              'äº§å“æè¿°': 'Pitch Axis- FFF',
              arrival_time: group.timeKey,
              'åˆ°è¾¾æ—¶é—´': group.timeKey,
              arrival_time_formatted: group.timeKey,
              'åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ–': group.timeKey,
              materials: [],
              hasEco: false
            };
            
            // åˆå¹¶æ‰€æœ‰å·¥å•çš„ç‰©æ–™
            (group.workOrders || group.items || []).forEach(wo => {
              if (wo.materials && wo.materials.length > 0) {
                wo.materials.forEach(material => {
                  // ä¸ºæ¯ä¸ªç‰©æ–™æ·»åŠ æ‰€å±å·¥å•å·å’ŒOPä¿¡æ¯
                  mergedWorkOrder.materials.push({
                    ...material,
                    _work_order: wo.work_order || wo['å·¥å•å·'] || '',
                    _op: wo.op || wo['OP'] || ''
                  });
                });
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ECO
                if (wo.hasEco) {
                  mergedWorkOrder.hasEco = true;
                }
              }
            });
            
            // å°†åˆå¹¶åçš„å·¥å•è®¾ç½®ä¸ºé€‰ä¸­å·¥å•ï¼ˆä½¿ç”¨å†…éƒ¨å˜é‡ï¼‰
            this._selectedWorkOrder = mergedWorkOrder;
          } else if (group && group.type === 'tool_group') {
            // å¦‚æœæ˜¯å™¨å…·ç»„ï¼ˆSA14æŒ‰å™¨å…·åˆ†ç»„ï¼‰ï¼Œæ„é€ å™¨å…·ç»„å¯¹è±¡
            let hasEco = false;
            if (group.materials && group.materials.length > 0) {
              group.materials.forEach(material => {
                if (material.ecoInfo && material.ecoInfo.ecoNo) {
                  hasEco = true;
                }
              });
            }
            if (group.workOrders && group.workOrders.length > 0) {
              group.workOrders.forEach(wo => {
                if (wo.hasEco) {
                  hasEco = true;
                }
              });
            }
            
            const toolGroupWorkOrder = {
              work_order: group.workOrders && group.workOrders[0] ? (group.workOrders[0].work_order || group.workOrders[0]['å·¥å•å·'] || '') : '',
              description: group.workOrders && group.workOrders[0] ? (group.workOrders[0].description || group.workOrders[0]['äº§å“æè¿°'] || '') : '',
              op: group.workOrders && group.workOrders[0] ? (group.workOrders[0].op || group.workOrders[0]['OP'] || '') : '',
              materials: group.materials || [],
              hasEco: hasEco,
              _isToolGroup: true,
              _toolType: group.toolType || 'æœªåˆ†ç±»',
              _allWorkOrders: group.workOrders || []
            };
            
            this._selectedWorkOrder = toolGroupWorkOrder;
          } else {
            // æ™®é€šå·¥å•æˆ–å·¥å•ç»„
            const workOrder = group.workOrder || (group.workOrders && group.workOrders[0]) || group;
            this._selectedWorkOrder = workOrder;
          }
        },

        // åˆ¤æ–­æ˜¯å¦ä¸º Pitch äº§å“
        isPitchProduct(workOrder) {
          if (!workOrder) return false;
          const desc = String(workOrder.description || workOrder['äº§å“æè¿°'] || '').trim().toLowerCase();
          return desc.includes('pitch');
        },

        // åˆ¤æ–­æ˜¯å¦ä¸º SA14 äº§å“
        isSA14Product(workOrder) {
          if (!workOrder) return false;
          const desc = String(workOrder.description || workOrder['äº§å“æè¿°'] || '').trim().toLowerCase();
          return desc.includes('sa14');
        },

        // è®¡ç®—ä¸€ç»„å·¥å•åŒ¹é…åˆ°çš„ç‰©æ–™æ€»è¡Œæ•°ï¼ˆè¾…åŠ©å‡½æ•°ï¼‰
        // è¾“å…¥ï¼šworkOrders æ•°ç»„ï¼ˆä¸€ç»„å·¥å•ï¼‰
        // è¿”å›ï¼šåŒ¹é…åˆ°çš„ç‰©æ–™æ€»è¡Œæ•°ï¼ˆæ’é™¤ AW ç‰©æ–™ï¼‰
        calculateMatchedBomCount(workOrders) {
          if (!workOrders || !Array.isArray(workOrders) || workOrders.length === 0) {
            return 0;
          }
          
          let totalCount = 0;
          workOrders.forEach(workOrder => {
            if (workOrder.materials && Array.isArray(workOrder.materials)) {
              // ç»Ÿè®¡ç‰©æ–™æ•°é‡ï¼ˆæ’é™¤ AW ç‰©æ–™ï¼‰
              workOrder.materials.forEach(material => {
                const toolType = String(material.tool_type || material['tool_type'] || '').trim();
                if (toolType.toUpperCase() !== 'AW') {
                  totalCount++;
                }
              });
            }
          });
          
          return totalCount;
        },

        // ç”Ÿæˆæ‰“å°é¡µé¢æ•°æ®
        generatePrintPages(workOrder) {
          if (!workOrder) {
            return [];
          }

          // å¦‚æœæ˜¯æ—¶é—´ç»„ï¼ˆPitchæŒ‰æ—¶é—´åˆ†ç»„ï¼‰ï¼Œåˆå¹¶æ‰€æœ‰å·¥å•çš„ç‰©æ–™
          if (workOrder.type === 'time_group' && workOrder.workOrders) {
            const allMergedMaterials = [];
            let hasEco = false;
            
            // åˆå¹¶æ‰€æœ‰å·¥å•çš„ç‰©æ–™
            workOrder.workOrders.forEach(wo => {
              if (wo.materials && wo.materials.length > 0) {
                wo.materials.forEach(material => {
                  allMergedMaterials.push({
                    ...material,
                    _work_order: wo.work_order || wo['å·¥å•å·'] || '',
                    _op: wo.op || wo['OP'] || '',
                    // æ·»åŠ äº§å“æè¿°å’Œå°å¥—ä¿¡æ¯
                    _description: wo.description || wo['äº§å“æè¿°'] || '',
                    _seq_no: wo.seq_no || wo['åŠ å·¥åºåˆ—å·'] || ''
                  });
                });
                
                if (wo.hasEco) {
                  hasEco = true;
                }
              }
            });
            
            // æ’åºï¼šå…ˆæŒ‰tool_typeï¼Œå†æŒ‰locator
            const sortedMaterials = allMergedMaterials.sort((a, b) => {
              const toolA = String(a.tool_type || a['tool_type'] || '').trim();
              const toolB = String(b.tool_type || b['tool_type'] || '').trim();
              if (toolA !== toolB) {
                return toolA.localeCompare(toolB, 'zh-CN');
              }
              const locA = String(a.PENDING_LOCATOR || a['PENDING_LOCATOR'] || '').trim();
              const locB = String(b.PENDING_LOCATOR || b['PENDING_LOCATOR'] || '').trim();
              return locA.localeCompare(locB, 'zh-CN');
            });
            
            const info = {
              description: 'Pitch Axis- FFF',
              'äº§å“æè¿°': 'Pitch Axis- FFF',
              hasEco: hasEco
            };
            
            const timeKey = workOrder.timeKey || workOrder.arrival_time || '--';
            return [{
              title: `åˆ°è¾¾æ—¶é—´ï¼š[${timeKey}]`,
              info: info,
              materials: sortedMaterials
            }];
          }

          // å¦‚æœæ˜¯å™¨å…·ç»„ï¼ˆSA14æŒ‰å™¨å…·åˆ†ç»„ï¼‰ï¼Œç›´æ¥ä½¿ç”¨å·²åˆ†ç»„çš„ç‰©æ–™
          if (workOrder._isToolGroup && workOrder.materials && workOrder.materials.length > 0) {
            const materials = [...workOrder.materials];
            
            // æŒ‰locatoræ’åº
            const sortedMaterials = materials.sort((a, b) => {
              const locA = String(a.PENDING_LOCATOR || a['PENDING_LOCATOR'] || '').trim();
              const locB = String(b.PENDING_LOCATOR || b['PENDING_LOCATOR'] || '').trim();
              return locA.localeCompare(locB, 'zh-CN');
            });

            const info = {
              description: workOrder.description || workOrder['äº§å“æè¿°'] || '',
              station: workOrder.station || workOrder['å°å¥—'] || '',
              hasEco: workOrder.hasEco || false
            };

            return [{
              title: `å™¨å…·ï¼š[${workOrder._toolType || 'æœªåˆ†ç±»'}]`,
              info: info,
              materials: sortedMaterials
            }];
          }

          const isPitch = this.isPitchProduct(workOrder);
          const isSA14 = this.isSA14Product(workOrder);

          // å·¥å•åŸºæœ¬ä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºï¼Œä¸åŒ…å«å·¥å•å·å’ŒOPï¼Œå› ä¸ºå®ƒä»¬ç§»å…¥è¡¨æ ¼ï¼‰
          const info = {
            description: workOrder.description || workOrder['äº§å“æè¿°'] || '',
            station: workOrder.station || workOrder['å°å¥—'] || '',
            hasEco: workOrder.hasEco || false
          };

          if (isPitch) {
            // Pitch äº§å“ï¼šè·¨å·¥å•åˆå¹¶æ‰“å°ç­–ç•¥
            // 1. è·å–é€‰ä¸­å·¥å•çš„åˆ°è¾¾æ—¶é—´ï¼ˆåªå–HH:mméƒ¨åˆ†ï¼‰
            const arrivalTime = workOrder.arrival_time || workOrder['åˆ°è¾¾æ—¶é—´'] || '';
            let arrivalTimeDisplay = '--';
            
            // å¼ºåˆ¶æ ¼å¼åŒ–ä¸º HH:mmï¼Œç¡®ä¿ä¸æ˜¾ç¤ºæ—¥æœŸ
            if (arrivalTime) {
              if (typeof arrivalTime === 'string') {
                // å¦‚æœåŒ…å«æ—¥æœŸæ—¶é—´æ ¼å¼ï¼Œåªæå–æ—¶é—´éƒ¨åˆ†
                if (arrivalTime.includes(' ') && arrivalTime.includes(':')) {
                  const timePart = arrivalTime.split(' ')[1] || arrivalTime.split(' ')[0];
                  const timeMatch = timePart.match(/(\d{1,2}):(\d{2})/);
                  if (timeMatch) {
                    arrivalTimeDisplay = `${String(parseInt(timeMatch[1], 10)).padStart(2, '0')}:${timeMatch[2]}`;
                  } else {
                    arrivalTimeDisplay = timePart.substring(0, 5);
                  }
                } else if (arrivalTime.match(/\d{1,2}:\d{2}/)) {
                  arrivalTimeDisplay = arrivalTime.substring(0, 5);
                } else {
                  arrivalTimeDisplay = arrivalTime;
                }
              } else {
                arrivalTimeDisplay = String(arrivalTime);
              }
            }

            // 2. æŸ¥æ‰¾æ‰€æœ‰ç›¸åŒåˆ°è¾¾æ—¶é—´çš„Pitchå·¥å•
            const allMergedMaterials = [];
            const mergedWorkOrders = [];
            
            // éå†matchedWorkOrdersï¼ŒæŸ¥æ‰¾æ‰€æœ‰ç›¸åŒåˆ°è¾¾æ—¶é—´çš„Pitchå·¥å•
            (this.matchedWorkOrders || []).forEach(wo => {
              const woDesc = String(wo.description || wo['äº§å“æè¿°'] || '').trim().toLowerCase();
              const woTime = wo.arrival_time || wo['åˆ°è¾¾æ—¶é—´'] || '';
              
              // æ ¼å¼åŒ–å·¥å•çš„åˆ°è¾¾æ—¶é—´ç”¨äºæ¯”è¾ƒ
              let woTimeDisplay = '';
              if (woTime) {
                if (typeof woTime === 'string') {
                  if (woTime.includes(' ') && woTime.includes(':')) {
                    const timePart = woTime.split(' ')[1] || woTime.split(' ')[0];
                    const timeMatch = timePart.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                      woTimeDisplay = `${String(parseInt(timeMatch[1], 10)).padStart(2, '0')}:${timeMatch[2]}`;
                    } else {
                      woTimeDisplay = timePart.substring(0, 5);
                    }
                  } else if (woTime.match(/\d{1,2}:\d{2}/)) {
                    woTimeDisplay = woTime.substring(0, 5);
                  } else {
                    woTimeDisplay = woTime;
                  }
                } else {
                  woTimeDisplay = String(woTime);
                }
              }
              
              // å¦‚æœäº§å“æè¿°åŒ…å«pitchä¸”åˆ°è¾¾æ—¶é—´ç›¸åŒï¼Œåˆå¹¶ç‰©æ–™
              if (woDesc.includes('pitch') && woTimeDisplay === arrivalTimeDisplay && wo.materials && wo.materials.length > 0) {
                mergedWorkOrders.push(wo);
                wo.materials.forEach(material => {
                  // ä¸ºæ¯ä¸ªç‰©æ–™æ·»åŠ æ‰€å±å·¥å•å·å’ŒOPä¿¡æ¯
                  allMergedMaterials.push({
                    ...material,
                    _work_order: wo.work_order || wo['å·¥å•å·'] || '',
                    _op: wo.op || wo['OP'] || '',
                    // æ·»åŠ äº§å“æè¿°å’Œå°å¥—ä¿¡æ¯
                    _description: wo.description || wo['äº§å“æè¿°'] || '',
                    _seq_no: wo.seq_no || wo['åŠ å·¥åºåˆ—å·'] || ''
                  });
                });
              }
            });

            // 3. æ’åºï¼šå…ˆæŒ‰tool_typeï¼Œå†æŒ‰locator
            const sortedMaterials = allMergedMaterials.sort((a, b) => {
              const toolA = String(a.tool_type || a['tool_type'] || '').trim();
              const toolB = String(b.tool_type || b['tool_type'] || '').trim();
              if (toolA !== toolB) {
                return toolA.localeCompare(toolB, 'zh-CN');
              }
              const locA = String(a.PENDING_LOCATOR || a['PENDING_LOCATOR'] || '').trim();
              const locB = String(b.PENDING_LOCATOR || b['PENDING_LOCATOR'] || '').trim();
              return locA.localeCompare(locB, 'zh-CN');
            });

            // 4. æ£€æŸ¥æ˜¯å¦æœ‰ECO
            let hasEco = false;
            sortedMaterials.forEach(material => {
              if (material.ecoInfo && material.ecoInfo.ecoNo) {
                hasEco = true;
              }
            });
            info.hasEco = hasEco;

            // 5. ç”Ÿæˆæ ‡é¢˜
            const title = arrivalTimeDisplay !== '--' ? `åˆ°è¾¾æ—¶é—´ï¼š[${arrivalTimeDisplay}]` : 'åˆ°è¾¾æ—¶é—´ï¼š[--]';
            
            return [{
              title: title,
              info: info,
              materials: sortedMaterials
            }];
          } else if (isSA14) {
            // SA14 äº§å“ï¼šéœ€è¦ç‰©æ–™æ•°æ®
            if (!workOrder.materials || workOrder.materials.length === 0) {
              return [];
            }
            const materials = [...workOrder.materials];
            
            // ä¸ºæ¯ä¸ªç‰©æ–™æ·»åŠ æ‰€å±å·¥å•å·å’ŒOPä¿¡æ¯
            const materialsWithWorkOrder = materials.map(material => ({
              ...material,
              _work_order: workOrder.work_order || workOrder['å·¥å•å·'] || '',
              _op: workOrder.op || workOrder['OP'] || '',
              // æ·»åŠ äº§å“æè¿°å’Œå°å¥—ä¿¡æ¯
              _description: workOrder.description || workOrder['äº§å“æè¿°'] || '',
              _seq_no: workOrder.seq_no || workOrder['åŠ å·¥åºåˆ—å·'] || ''
            }));
            
            // SA14 äº§å“ï¼šNé¡µï¼ˆæŒ‰ tool_type åˆ†ç»„ï¼‰ï¼Œæ¯é¡µæ ‡é¢˜ä¸º tool_typeï¼Œç‰©æ–™æŒ‰ locator æ’åº
            const groups = {};
            materialsWithWorkOrder.forEach(material => {
              const toolType = String(material.tool_type || material['tool_type'] || 'æœªåˆ†ç±»').trim();
              if (!groups[toolType]) {
                groups[toolType] = [];
              }
              groups[toolType].push(material);
            });

            return Object.keys(groups).map(toolType => {
              const groupMaterials = groups[toolType].sort((a, b) => {
                const locA = String(a.PENDING_LOCATOR || a['PENDING_LOCATOR'] || '').trim();
                const locB = String(b.PENDING_LOCATOR || b['PENDING_LOCATOR'] || '').trim();
                return locA.localeCompare(locB, 'zh-CN');
              });

              return {
                title: `å™¨å…·ï¼š[${toolType}]`,
                info: info,
                materials: groupMaterials
              };
            });
          } else {
            // æ™®é€šäº§å“ï¼šéœ€è¦ç‰©æ–™æ•°æ®
            // Step A: è·å–è¯¥å·¥å•å·
            const workOrderNo = String(workOrder.work_order || workOrder['å·¥å•å·'] || '').trim();
            if (!workOrderNo) {
              return [];
            }
            
            // Step B: åœ¨ productionPlanData ä¸­æŸ¥æ‰¾æ‰€æœ‰å±äºè¯¥å·¥å•å·çš„è®°å½•ï¼ˆè·å–æ‰€æœ‰ OPï¼‰
            const allOpsForWorkOrder = (this.productionPlanData || []).filter(plan => {
              const planWorkOrder = String(plan.work_order || plan['å·¥å•å·'] || '').trim();
              return planWorkOrder === workOrderNo;
            });
            
            // Step C: éå†è¿™æ‰€æœ‰ OPï¼Œåˆ†åˆ«å» bomData ä¸­æŸ¥æ‰¾åŒ¹é…çš„ç‰©æ–™
            const allMaterials = [];
            let hasEco = false;
            
            allOpsForWorkOrder.forEach(planOp => {
              const planOpCode = String(planOp.op || planOp['OP'] || '').trim();
              
              // ä» bomData ä¸­æŸ¥æ‰¾åŒ¹é…çš„ç‰©æ–™ï¼ˆå·¥å•å· + OP åŒé‡åŒ¹é…ï¼‰
              (this.bomData || []).forEach(bom => {
                // è¿‡æ»¤ AWï¼šå¦‚æœ tool_type === 'AW'ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼Œè·³è¿‡è¯¥ç‰©æ–™
                const toolType = String(bom.tool_type || bom['tool_type'] || '').trim();
                if (toolType.toUpperCase() === 'AW') {
                  return; // è·³è¿‡ AW ç‰©æ–™
                }
                
                const bomJob = String(bom.Job || '').trim();
                const bomOP = String(bom.OP || '').trim();
                
                // åŒé‡åŒ¹é…ï¼šå·¥å•å·å’ŒOPéƒ½å¿…é¡»å®Œå…¨ä¸€è‡´
                if (bomJob === workOrderNo && bomOP === planOpCode) {
                  // åŒ¹é…æˆåŠŸï¼Œæ·»åŠ ç‰©æ–™
                  const material = {
                    ...bom,
                    _work_order: workOrderNo,
                    _op: planOpCode,
                    // æ·»åŠ äº§å“æè¿°å’Œå°å¥—ä¿¡æ¯ï¼ˆä» planOp ä¸­è·å–ï¼‰
                    _description: planOp.description || planOp['äº§å“æè¿°'] || '',
                    _seq_no: planOp.seq_no || planOp['åŠ å·¥åºåˆ—å·'] || ''
                  };
                  
                  // å°† Plan çš„ arrival_time_formatted èµ‹ç»™ BOM ç‰©æ–™ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
                  if (!material.arrival_time_formatted && planOp.arrival_time_formatted) {
                    material.arrival_time_formatted = planOp.arrival_time_formatted;
                    material['åˆ°è¾¾æ—¶é—´æ ¼å¼åŒ–'] = planOp.arrival_time_formatted;
                  }
                  if (!material.arrival_time && planOp.arrival_time) {
                    material.arrival_time = planOp.arrival_time;
                    material['åˆ°è¾¾æ—¶é—´'] = planOp.arrival_time;
                  }
                  
                  allMaterials.push(material);
                  
                  // æ£€æŸ¥æ˜¯å¦æœ‰ECO
                  const component = String(material.Component || '').trim();
                  const seqNo = parseInt(planOp.seq_no || planOp['åŠ å·¥åºåˆ—å·'] || '0', 10) || 0;
                  
                  // æŸ¥æ‰¾åŒ¹é…çš„ ECO
                  const matchedEco = (this.ecoList || []).find(eco => {
                    if (eco.op !== planOpCode) return false;
                    if (!eco.materials || eco.materials.length === 0) return false;
                    
                    const hasMaterial = eco.materials.some(mat => {
                      const matStr = typeof mat === 'string' ? mat : String(mat.material || '');
                      return matStr === component;
                    });
                    
                    if (!hasMaterial) return false;
                    
                    const startSet = parseInt(eco.start_set || '0', 10) || 0;
                    return seqNo >= startSet;
                  });
                  
                  if (matchedEco) {
                    material.ecoInfo = {
                      ecoNo: matchedEco.eco_no,
                      changeDetails: matchedEco.change_details || ''
                    };
                    hasEco = true;
                  }
                }
              });
            });
            
            // Step D: å°†æ‰€æœ‰åŒ¹é…åˆ°çš„ç‰©æ–™åˆå¹¶åˆ°ä¸€ä¸ªå¤§æ•°ç»„ allMaterials ä¸­
            if (allMaterials.length === 0) {
              return [];
            }
            
            // æ›´æ–° info çš„ hasEco çŠ¶æ€
            info.hasEco = hasEco;
            
            // æ™®é€šäº§å“ï¼šæŒ‰ OP åˆ†ç»„ï¼Œæ¯ä¸ª OP ç”Ÿæˆä¸€é¡µ
            // 1. æŒ‰ OP åˆ†ç»„
            const opGroups = {};
            allMaterials.forEach(material => {
              const op = String(material._op || '').trim();
              if (!opGroups[op]) {
                opGroups[op] = [];
              }
              opGroups[op].push(material);
            });
            
            // 2. è·å–æ‰€æœ‰ OP å¹¶æ’åºï¼ˆæŒ‰æ•°å­—å¤§å°å‡åºï¼‰
            const opKeys = Object.keys(opGroups).sort((a, b) => {
              // å°è¯•å°† OP è½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒ
              const numA = parseInt(a, 10);
              const numB = parseInt(b, 10);
              if (!isNaN(numA) && !isNaN(numB)) {
                return numA - numB;
              }
              // å¦‚æœæ— æ³•è½¬æ¢ä¸ºæ•°å­—ï¼ŒæŒ‰å­—ç¬¦ä¸²æ¯”è¾ƒ
              return a.localeCompare(b, 'zh-CN');
            });
            
            // 3. ä¸ºæ¯ä¸ª OP ç»„ç”Ÿæˆä¸€ä¸ªé¡µé¢
            return opKeys.map(op => {
              // ç»„å†…ç‰©æ–™æŒ‰ locator æ’åº
              const groupMaterials = opGroups[op].sort((a, b) => {
                const locA = String(a.PENDING_LOCATOR || a['PENDING_LOCATOR'] || '').trim();
                const locB = String(b.PENDING_LOCATOR || b['PENDING_LOCATOR'] || '').trim();
                return locA.localeCompare(locB, 'zh-CN');
              });
              
              // æ£€æŸ¥è¯¥ OP ç»„æ˜¯å¦æœ‰ ECO
              let groupHasEco = false;
              groupMaterials.forEach(material => {
                if (material.ecoInfo && material.ecoInfo.ecoNo) {
                  groupHasEco = true;
                }
              });
              
              return {
                title: `å·¥å•ï¼š[${workOrderNo}]`,
                info: {
                  ...info,
                  hasEco: groupHasEco,
                  op: op  // æ·»åŠ  OP ä¿¡æ¯ç”¨äºå‰¯æ ‡é¢˜æ˜¾ç¤º
                },
                materials: groupMaterials
              };
            });
          }
        },

        // æ‰“å°å·¥å•
        printWorkOrder() {
          window.print();
        },

        // æ‰¹é‡æ‰“å°
        printBatchWorkOrders() {
          window.print();
        },

        // å¯¼å‡ºç­›é€‰ç»“æœåˆ°Excel
        exportToExcel() {
          const groupedList = this.groupedWorkOrderList || [];
          
          if (groupedList.length === 0) {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
            return;
          }

          try {
            // æ”¶é›†æ‰€æœ‰ç‰©æ–™æ•°æ®
            const allExportData = [];
            let rowIndex = 1;

            groupedList.forEach((group, groupIndex) => {
              let workOrder = null;
              
              // æ ¹æ®åˆ†ç»„ç±»å‹è·å–å·¥å•å¯¹è±¡
              if (group.type === 'time_group' && group.workOrders && group.workOrders.length > 0) {
                // Pitchæ—¶é—´ç»„
                workOrder = {
                  type: 'time_group',
                  timeKey: group.timeKey,
                  workOrders: group.workOrders
                };
              } else if (group.type === 'tool_group') {
                // SA14å™¨å…·ç»„
                workOrder = {
                  _isToolGroup: true,
                  _toolType: group.toolType,
                  materials: group.materials || [],
                  workOrders: group.workOrders || []
                };
              } else if (group.type === 'work_order_group' && group.workOrder) {
                // å·¥å•ç»„
                workOrder = group.workOrder;
              }

              if (!workOrder) return;

              // ç”Ÿæˆæ‰“å°é¡µé¢ä»¥è·å–ç‰©æ–™æ•°æ®
              const pages = this.generatePrintPages(workOrder);
              
              pages.forEach((page, pageIdx) => {
                if (page.materials && page.materials.length > 0) {
                  page.materials.forEach((material, matIdx) => {
                    // è·å–äº§å“æè¿°å’Œå°å¥—ï¼ˆå4ä½ï¼‰
                    const description = material._description || '';
                    const seqNo = material._seq_no || '';
                    const seqNoLast4 = seqNo.toString().slice(-4) || '--';
                    
                    // æ„å»ºå¯¼å‡ºè¡Œæ•°æ®
                    const rowData = {
                      'åºå·': rowIndex++,
                      'äº§å“': description || '--',
                      'å°å¥—': seqNoLast4,
                      'å·¥åº(OP)': material._op || '--',
                      'ç‰©æ–™å·': material.Component || material['Component'] || '--',
                      'åº“ä½': material.PENDING_LOCATOR || material['PENDING_LOCATOR'] || '--',
                      'æ•°é‡': material.Required || material['Required'] || '--',
                      'å™¨å…·': material.tool_type || material['tool_type'] || '--',
                      'ECOå˜æ›´': material.ecoInfo && material.ecoInfo.ecoNo ? `ECO-${material.ecoInfo.ecoNo}` : '--',
                      'å¤‡æ³¨': material.remark || material['å¤‡æ³¨'] || '--'
                    };
                    
                    allExportData.push(rowData);
                  });
                }
              });
            });

            if (allExportData.length === 0) {
              alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç‰©æ–™æ•°æ®');
              return;
            }

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            
            // åˆ›å»ºå·¥ä½œè¡¨æ•°æ®
            const wsData = [
              // è¡¨å¤´
              ['åºå·', 'äº§å“', 'å°å¥—', 'å·¥åº(OP)', 'ç‰©æ–™å·', 'åº“ä½', 'æ•°é‡', 'å™¨å…·', 'ECOå˜æ›´', 'å¤‡æ³¨'],
              // æ•°æ®è¡Œ
              ...allExportData.map(row => [
                row['åºå·'],
                row['äº§å“'],
                row['å°å¥—'],
                row['å·¥åº(OP)'],
                row['ç‰©æ–™å·'],
                row['åº“ä½'],
                row['æ•°é‡'],
                row['å™¨å…·'],
                row['ECOå˜æ›´'],
                row['å¤‡æ³¨']
              ])
            ];

            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
              { wch: 8 },   // åºå·
              { wch: 30 },  // äº§å“
              { wch: 10 },  // å°å¥—
              { wch: 12 },  // å·¥åº(OP)
              { wch: 25 },  // ç‰©æ–™å·
              { wch: 15 },  // åº“ä½
              { wch: 10 },  // æ•°é‡
              { wch: 20 },  // å™¨å…·
              { wch: 15 },  // ECOå˜æ›´
              { wch: 20 }   // å¤‡æ³¨
            ];

            // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, 'å·¥å•é…æ–™æ˜ç»†');

            // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«æ—¥æœŸæ—¶é—´ï¼‰
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
            const fileName = `å·¥å•é…æ–™æ˜ç»†_${dateStr}_${timeStr}.xlsx`;

            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(wb, fileName);
            
            alert(`æˆåŠŸå¯¼å‡º ${allExportData.length} æ¡ç‰©æ–™æ˜ç»†ï¼`);
          } catch (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
            alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•ï¼š' + error.message);
          }
        },

        // ç”Ÿæˆæ‰¹é‡æ‰“å°é¡µé¢
        generateBatchPrint() {
          const groupedList = this.groupedWorkOrderList || [];
          
          if (groupedList.length === 0) {
            alert('æ²¡æœ‰å¯æ‰“å°çš„å·¥å•');
            return;
          }

          this.batchPrintPages = [];
          
          // éå†æ‰€æœ‰åˆ†ç»„ï¼Œä¸ºæ¯ä¸ªåˆ†ç»„ç”Ÿæˆæ‰“å°é¡µé¢
          groupedList.forEach((group, groupIndex) => {
            let workOrder = null;
            
            // æ ¹æ®åˆ†ç»„ç±»å‹è·å–å·¥å•å¯¹è±¡
            if (group.type === 'time_group' && group.workOrders && group.workOrders.length > 0) {
              // Pitchæ—¶é—´ç»„ï¼šä½¿ç”¨ç¬¬ä¸€ä¸ªå·¥å•è§¦å‘åˆå¹¶æ‰“å°
              workOrder = group.workOrders[0];
            } else if (group.type === 'tool_group') {
              // SA14å™¨å…·ç»„ï¼šæ„é€ ä¸€ä¸ªåŒ…å«è¯¥å™¨å…·æ‰€æœ‰ç‰©æ–™çš„å·¥å•å¯¹è±¡
              workOrder = {
                work_order: group.workOrders[0]?.work_order || group.workOrders[0]?.['å·¥å•å·'] || '',
                description: group.workOrders[0]?.description || group.workOrders[0]?.['äº§å“æè¿°'] || '',
                op: group.workOrders[0]?.op || group.workOrders[0]?.['OP'] || '',
                materials: group.materials || [],
                hasEco: group.workOrders.some(wo => wo.hasEco) || false,
                _isToolGroup: true,
                _toolType: group.toolType,
                _allWorkOrders: group.workOrders
              };
            } else if (group.type === 'work_order_group' && group.workOrder) {
              // å·¥å•ç»„ï¼šä½¿ç”¨ä»£è¡¨å·¥å•
              workOrder = group.workOrder;
            }
            
            if (workOrder) {
              const pages = this.generatePrintPages(workOrder);
              pages.forEach((page, pageIdx) => {
                this.batchPrintPages.push({
                  ...page,
                  groupIndex: groupIndex,
                  pageIndex: pageIdx,
                  isLastPage: pageIdx === pages.length - 1,
                  isLastGroup: groupIndex === groupedList.length - 1
                });
              });
            }
          });

          this.printTime = new Date().toLocaleString('zh-CN');
          // æ»šåŠ¨åˆ°æ‰¹é‡æ‰“å°åŒºåŸŸ
          this.$nextTick(() => {
            const batchPrintArea = document.querySelector('.batch-print-area');
            if (batchPrintArea) {
              batchPrintArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
        },

        // è·å–æ‰¹é‡æ‰“å°é¡µé¢æ ·å¼
        getBatchPrintPageStyle(page, pageIdx) {
          let style = '';
          // ç¬¬ä¸€é¡µä¸éœ€è¦ page-break-before
          if (pageIdx > 0) {
            style += 'page-break-before: always;';
          }
          // æ¯ä¸ªåˆ†ç»„çš„æœ€åä¸€é¡µï¼ˆä½†ä¸æ˜¯æœ€åä¸€ä¸ªåˆ†ç»„ï¼‰éœ€è¦ page-break-after
          if (page.isLastPage && !page.isLastGroup) {
            style += 'page-break-after: always;';
          }
          return style;
        },

        // ========== ä¾›åº”å•†æ”¶è´§ç›‘æ§ç›¸å…³æ–¹æ³• ==========
        // è§¦å‘æµæ°´è¡¨ä¸Šä¼ 
        triggerTransactionLogUpload() {
          if (this.$refs.transactionLogFileInput) {
            this.$refs.transactionLogFileInput.click();
          }
        },

        // ========== é‡å†™ï¼šå¤„ç†æµæ°´è¡¨ä¸Šä¼ ï¼ˆç®€åŒ–ç‰ˆï¼‰ ==========
        handleTransactionLogUpload(event) {
          const file = event.target.files[0];
          if (!file) return;
          this.transactionLogFile = file;
          
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              this.transactionLogData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
              alert('æµæ°´è¡¨ä¸Šä¼ æˆåŠŸ');
            } catch (error) {
              console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
              alert('æ–‡ä»¶è§£æå¤±è´¥');
            }
          };
          reader.readAsArrayBuffer(file);
        },

        // è§¦å‘å…³ç³»è¡¨ä¸Šä¼ 
        triggerMappingTableUpload() {
          if (this.$refs.mappingTableFileInput) {
            this.$refs.mappingTableFileInput.click();
          }
        },

        // ========== é‡å†™ï¼šå¤„ç†å…³ç³»è¡¨ä¸Šä¼ ï¼ˆç®€åŒ–ç‰ˆï¼‰ ==========
        handleMappingTableUpload(event) {
          const file = event.target.files[0];
          if (!file) return;
          this.mappingTableFile = file;
          
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              this.mappingTableData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
              alert('å…³ç³»è¡¨ä¸Šä¼ æˆåŠŸ');
            } catch (error) {
              console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
              alert('æ–‡ä»¶è§£æå¤±è´¥');
            }
          };
          reader.readAsArrayBuffer(file);
        },

        // ========== é‡å†™ï¼šå¼€å§‹åŒ¹é…è®¡ç®—ï¼ˆå…¨æ–°çº¿æ€§æµç¨‹ï¼‰ ==========
        startMatching() {
          if (!this.transactionLogData || !this.mappingTableData) {
            alert('è¯·å…ˆä¸Šä¼ æµæ°´è¡¨å’Œå…³ç³»è¡¨');
            return;
          }

          // è°ƒç”¨æ–°çš„å¤„ç†æµç¨‹
          this.processMatching(this.transactionLogData, this.mappingTableData);
        },

        // ========== å…¨æ–°åŒ¹é…æµç¨‹ï¼šçº¿æ€§å¤„ç†ï¼Œè¯¦ç»†æ—¥å¿— ==========
        processMatching(transactionData, mappingData) {
          console.log('--- å¼€å§‹å…¨æ–°åŒ¹é…æµç¨‹ ---');
          
          // ========== ç¬¬ä¸€æ­¥ï¼šæ„å»ºå­—å…¸ Map (Item -> SupplierCN) ==========
          console.log('ã€ç¬¬ä¸€æ­¥ã€‘æ„å»ºå­—å…¸ Map (Item -> SupplierCN)');
          const itemToSupplierCnMap = new Map(); // ç‰©æ–™å· -> ä¸­æ–‡ä¾›åº”å•†å
          const unknownSuppliersEn = new Set(); // æ”¶é›†éœ€è¦å…³è”çš„è‹±æ–‡ä¾›åº”å•†å
          
          mappingData.forEach((row, index) => {
            // ä½¿ç”¨æ™ºèƒ½åˆ—åæŸ¥æ‰¾
            const itemValue = this.findColumnValue(row, ['Item', 'ç‰©æ–™', 'Part', 'ç‰©æ–™å·']);
            const supplierValue = this.findColumnValue(row, ['Supplier', 'ä¾›åº”å•†', 'Vendor']);
            
            const itemKey = itemValue ? String(itemValue).trim() : '';
            const supplierEn = supplierValue ? String(supplierValue).trim() : '';
            
            if (index === 0) {
              console.log('å…³ç³»è¡¨ç¬¬ä¸€è¡Œ:', { itemKey, supplierEn });
            }
            
            if (itemKey && supplierEn) {
              // æŸ¥å­—å…¸ï¼šè‹±æ–‡å -> ä¸­æ–‡å
              const supplierCn = this.supplierMap[supplierEn] || supplierEn;
              
              // å¦‚æœå­—å…¸ä¸­æ²¡æœ‰ï¼Œè®°å½•éœ€è¦å…³è”
              if (!this.supplierMap[supplierEn]) {
                unknownSuppliersEn.add(supplierEn);
              }
              
              // å»ºç«‹æ˜ å°„ï¼šç‰©æ–™å· -> ä¸­æ–‡ä¾›åº”å•†å
              itemToSupplierCnMap.set(itemKey, supplierCn);
            }
          });
          
          console.log(`å­—å…¸æ„å»ºå®Œæˆ: ${itemToSupplierCnMap.size} ä¸ªç‰©æ–™æ˜ å°„`);
          console.log(`éœ€è¦å…³è”çš„ä¾›åº”å•†: ${unknownSuppliersEn.size} ä¸ª`, Array.from(unknownSuppliersEn));
          
          // ========== ç¬¬äºŒæ­¥ï¼šèšåˆ Excel æ•°æ® (Excel Aggregation) - çº¯è¡Œæ•°è®¡æ•° + Subinventory è¿‡æ»¤ ==========
          console.log('ã€ç¬¬äºŒæ­¥ã€‘èšåˆ Excel æ•°æ®ï¼ˆçº¯è¡Œæ•°è®¡æ•° + Subinventory è¿‡æ»¤ï¼‰');
          const excelAggregatedData = []; // [{ supplier: 'è‹¹æœå…¬å¸', date: '2025-12-30', count: 30 }, ...]
          const unknownItems = [];
          let filteredRowCount = 0; // ç»Ÿè®¡è¢«è¿‡æ»¤æ‰çš„è¡Œæ•°
          
          transactionData.forEach((row, index) => {
            // ========== æ–°å¢ï¼šSubinventory è¿‡æ»¤ ==========
            // æ£€æŸ¥ Subinventory åˆ—ï¼Œåªä¿ç•™å€¼ä¸º SUN æˆ– XDOCK çš„è¡Œ
            const subinventoryValue = this.findColumnValue(row, ['Subinventory', 'å­åº“å­˜', 'ä»“åº“', 'Sub Inventory']);
            const subinventory = subinventoryValue ? String(subinventoryValue).trim().toUpperCase() : '';
            
            if (subinventory && subinventory !== 'SUN' && subinventory !== 'XDOCK') {
              filteredRowCount++;
              return; // è·³è¿‡ä¸ç¬¦åˆæ¡ä»¶çš„è¡Œ
            }
            
            // ä½¿ç”¨æ™ºèƒ½åˆ—åæŸ¥æ‰¾ Item
            const itemValue = this.findColumnValue(row, ['Item', 'ç‰©æ–™', 'Part', 'ç‰©æ–™å·']);
            const itemKey = itemValue ? String(itemValue).trim() : '';
            
            if (index === 0) {
              console.log('æµæ°´è¡¨ç¬¬ä¸€è¡Œ:', { itemKey, subinventory, 'æ‰€æœ‰åˆ—å': Object.keys(row) });
            }
            
            if (!itemKey) {
              return; // è·³è¿‡ç©ºç‰©æ–™å·
            }
            
            // é€šè¿‡ Item æ‰¾åˆ° Supplierï¼ˆä¸­æ–‡åï¼‰
            const supplierCn = itemToSupplierCnMap.get(itemKey);
            
            if (!supplierCn) {
              if (!unknownItems.includes(itemKey)) {
                unknownItems.push(itemKey);
              }
              return; // è·³è¿‡ï¼Œä¸è¿›è¡Œç»Ÿè®¡
            }
            
            // æ—¥æœŸå¤„ç†ï¼šä½¿ç”¨æ™ºèƒ½åˆ—åæŸ¥æ‰¾ï¼Œç„¶åè°ƒç”¨ normalizeDate è·å–çº¯æ—¥æœŸï¼ˆUTC å–æ•´ï¼‰
            const dateValue = this.findColumnValue(row, ['Date', 'æ—¥æœŸ', 'Time', 'äº¤æ˜“æ—¥æœŸ', 'Transaction Date']);
            const dateRaw = dateValue || '';
            const excelDate = this.normalizeDate(dateRaw);
            
            if (index === 0) {
              console.log(`æ—¥æœŸæ¸…æ´—: ${dateRaw} -> ${excelDate}`);
            }
            
            // æ ¸å¿ƒèšåˆé€»è¾‘ï¼šçº¯è¡Œæ•°è®¡æ•°ï¼ˆæ¯è¡ŒåªåŠ  1ï¼Œä¸è¯»å–ä»»ä½•æ•°é‡å­—æ®µï¼‰
            // æ³¨æ„ï¼šä¸è¯»å– row['Transaction Quantity'] æˆ–ä»»ä½•æ•°é‡å­—æ®µ
            if (excelDate) {
              const existingIndex = excelAggregatedData.findIndex(
                item => item.supplier === supplierCn && item.date === excelDate
              );
              
              if (existingIndex >= 0) {
                excelAggregatedData[existingIndex].count += 1; // æ ¸å¿ƒï¼šæ¯è¡ŒåªåŠ  1
              } else {
                excelAggregatedData.push({
                  supplier: supplierCn,
                  date: excelDate,
                  count: 1 // æ ¸å¿ƒï¼šæ¯è¡ŒåªåŠ  1
                });
              }
            } else {
              // æ²¡æœ‰æ—¥æœŸçš„æ•°æ®
              const existingIndex = excelAggregatedData.findIndex(
                item => item.supplier === supplierCn && item.date === 'æœªçŸ¥æ—¥æœŸ'
              );
              
              if (existingIndex >= 0) {
                excelAggregatedData[existingIndex].count += 1; // æ ¸å¿ƒï¼šæ¯è¡ŒåªåŠ  1
              } else {
                excelAggregatedData.push({
                  supplier: supplierCn,
                  date: 'æœªçŸ¥æ—¥æœŸ',
                  count: 1 // æ ¸å¿ƒï¼šæ¯è¡ŒåªåŠ  1
                });
              }
            }
          });
          
          if (filteredRowCount > 0) {
            console.log(`âš ï¸ Subinventory è¿‡æ»¤ï¼šå·²è¿‡æ»¤ ${filteredRowCount} è¡Œï¼ˆä»…ä¿ç•™ SUN å’Œ XDOCKï¼‰`);
          }

          // è°ƒè¯•æ—¥å¿—ï¼šæ‰“å°èšåˆåçš„ç»“æœï¼ˆæŒ‰ä¾›åº”å•†å’Œæ—¥æœŸåˆ†ç»„ï¼‰
          console.log(`Excel èšåˆå®Œæˆ: ${excelAggregatedData.length} æ¡æ•°æ®`);
          console.log('Excel èšåˆæ•°æ®ç¤ºä¾‹ï¼ˆå‰5æ¡ï¼‰:', excelAggregatedData.slice(0, 5));
          
          // æ‰“å°èšåˆåçš„å®Œæ•´ç»“æœï¼ˆç”¨äºæ ¸å¯¹è¡Œæ•°ï¼‰
          const aggregatedMap = {};
          excelAggregatedData.forEach(item => {
            const key = `${item.supplier}|${item.date}`;
            aggregatedMap[key] = item.count;
          });
          console.log('Excel èšåˆç»“æœï¼ˆå®Œæ•´ï¼‰:', aggregatedMap);
          
          // å¤„ç†æœªæ‰¾åˆ°ä¾›åº”å•†çš„ç‰©æ–™
          if (unknownItems.length > 0) {
            const itemsList = unknownItems.slice(0, 10).join('ã€');
            const moreText = unknownItems.length > 10 ? `ç­‰å…± ${unknownItems.length} ä¸ª` : '';
            alert(`âš ï¸ è­¦å‘Šï¼šä»¥ä¸‹ç‰©æ–™åœ¨å…³ç³»è¡¨ä¸­æœªæ‰¾åˆ°ä¾›åº”å•†ï¼š${itemsList}${moreText}\n\nè¯·æ£€æŸ¥å…³ç³»è¡¨æ˜¯å¦åŒ…å«è¿™äº›ç‰©æ–™ï¼Œæˆ–æ£€æŸ¥ç‰©æ–™å·æ˜¯å¦åŒ…å«ç©ºæ ¼ã€‚`);
          }
          
          // ========== ç¬¬ä¸‰æ­¥ï¼šæ™ºèƒ½åŒ¹é…ç­–ç•¥ (Smart Match Strategy) - Priority A/B/C ==========
          console.log('ã€ç¬¬ä¸‰æ­¥ã€‘æ™ºèƒ½åŒ¹é…ç­–ç•¥ï¼šéå† Excel æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§åŒ¹é…ä»»åŠ¡ï¼ˆPriority A/B/Cï¼‰');
          console.log(`å¾…åŒ¹é…ä»»åŠ¡æ•°: ${this.arrivalLog.length}`);
          
          let matchCount = 0;
          
          // ä¸ºæ¯ä¸ª Excel æ•°æ®é¡¹æ·»åŠ æ¶ˆè´¹æ ‡è®°ï¼Œç”¨äºæ£€æµ‹æœªå…³è”æ•°æ®
          excelAggregatedData.forEach(item => {
            item._isConsumed = false; // æ ‡è®°æ˜¯å¦è¢«åŒ¹é…
          });
          
          // éå† Excel èšåˆæ•°æ®ï¼Œä¸ºæ¯æ¡æ•°æ®å¯»æ‰¾åŒ¹é…çš„ä»»åŠ¡
          excelAggregatedData.forEach((excelItem, excelIndex) => {
            console.log(`\n[Excel æ•°æ® ${excelIndex + 1}] ä¾›åº”å•†: ${excelItem.supplier}, æ—¥æœŸ: ${excelItem.date}, æ•°é‡: ${excelItem.count}æ¡`);
            
            // ========== Priority A (ç²¾å‡†åŒ¹é…)ï¼šä¸­æ–‡åç›¸åŒ ä¸” æ—¥æœŸå®Œå…¨ç›¸åŒ ==========
            let matchedArrival = null;
            let matchedIndex = -1;
            
            // æŸ¥æ‰¾ç²¾å‡†åŒ¹é…
            for (let i = 0; i < this.arrivalLog.length; i++) {
              const arrival = this.arrivalLog[i];
              const taskSupplier = arrival.ä¾›åº”å•†åç§° || arrival.supplier || arrival.supplier_cn || '';
              const taskDateRaw = arrival.æ—¥æœŸ || arrival.date || '';
              const taskDate = this.normalizeDate(taskDateRaw);
              
              if (taskSupplier === excelItem.supplier && taskDate === excelItem.date) {
                matchedArrival = arrival;
                matchedIndex = i;
                console.log(`  âœ“ Priority A (ç²¾å‡†åŒ¹é…): ä»»åŠ¡ ${i + 1} - ${taskSupplier} ${taskDate}`);
                break;
              }
            }
            
            // ========== Priority B (å¡«å‘åŒ¹é…)ï¼šå¦‚æœ A æ²¡æ‰¾åˆ°ï¼Œæ‰¾åˆ° ä¸­æ–‡åç›¸åŒ ä¸” æœªç»“æ¡ˆ ä¸” æ—¥æœŸæœ€æ—© çš„ä»»åŠ¡ ==========
            if (!matchedArrival) {
              let earliestArrival = null;
              let earliestIndex = -1;
              let earliestDate = null;
              
              for (let i = 0; i < this.arrivalLog.length; i++) {
                const arrival = this.arrivalLog[i];
                const taskSupplier = arrival.ä¾›åº”å•†åç§° || arrival.supplier || arrival.supplier_cn || '';
                const taskDateRaw = arrival.æ—¥æœŸ || arrival.date || '';
                const taskDate = this.normalizeDate(taskDateRaw);
                
                // æ¡ä»¶ï¼šä¸­æ–‡åç›¸åŒ ä¸” æœªç»“æ¡ˆ ä¸” æ—¥æœŸæœ‰æ•ˆ
                if (taskSupplier === excelItem.supplier && !arrival.is_closed && taskDate) {
                  // æ‰¾åˆ°æ—¥æœŸæœ€æ—©çš„ä»»åŠ¡
                  if (!earliestDate || taskDate < earliestDate) {
                    earliestArrival = arrival;
                    earliestIndex = i;
                    earliestDate = taskDate;
                  }
                }
              }
              
              if (earliestArrival) {
                matchedArrival = earliestArrival;
                matchedIndex = earliestIndex;
                console.log(`  âœ“ Priority B (å¡«å‘åŒ¹é…): ä»»åŠ¡ ${earliestIndex + 1} - ${earliestArrival.ä¾›åº”å•†åç§° || earliestArrival.supplier_cn} ${earliestDate}`);
              }
            }
            
            // ========== Priority C (æŠ¥è­¦)ï¼šéƒ½æ‰¾ä¸åˆ° -> è®°å½•ä¸º"æœªå…³è”æ•°æ®" ==========
            if (!matchedArrival) {
              console.log(`  âœ— Priority C (æŠ¥è­¦): æœªæ‰¾åˆ°åŒ¹é…ä»»åŠ¡`);
              // ä¸æ ‡è®°ä¸ºå·²æ¶ˆè´¹ï¼Œç¨åç»Ÿä¸€æŠ¥è­¦
              return;
            }
            
            // ========== æ‰§è¡Œæ›´æ–°ï¼šæŒ‰æ—¥æœŸæ™ºèƒ½åˆå¹¶ï¼ˆUpsert é€»è¾‘ï¼‰ ==========
            console.log(`  â†’ æ‰§è¡Œæ›´æ–°: ${matchedArrival.ä¾›åº”å•†åç§° || matchedArrival.supplier_cn} -> æ›´æ–°ä¸º ${excelItem.count} æ¡ï¼ˆè¡Œæ•°ï¼‰`);
            
            // æ ‡è®°è¯¥ Excel æ•°æ®å·²è¢«æ¶ˆè´¹
            excelItem._isConsumed = true;
            
            // 1. åˆå§‹åŒ– system_data å’Œ logs
            if (!matchedArrival.system_data) {
              matchedArrival.system_data = { total: 0, logs: [] };
            }
            if (!matchedArrival.system_data.logs) {
              matchedArrival.system_data.logs = [];
            }
            
            // 2. ç¡®å®šè¦ä½¿ç”¨çš„æ—¥æœŸï¼ˆä½¿ç”¨ Excel æ•°æ®çš„æ—¥æœŸï¼‰
            const excelDate = excelItem.date === 'æœªçŸ¥æ—¥æœŸ' ? 'æœªçŸ¥æ—¥æœŸ' : excelItem.date;
            
            // 3. æŒ‰æ—¥æœŸæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨
            const existingLogIndex = matchedArrival.system_data.logs.findIndex(log => log.date === excelDate);
            
            if (existingLogIndex >= 0) {
              // A. å¦‚æœå·²å­˜åœ¨å½“å¤©æ•°æ® -> è¦†ç›–ï¼ˆä¿®æ­£ï¼‰ï¼Œé¿å…é‡å¤ä¸Šä¼ æ—¶æ•°æ®ç¿»å€
              const oldCount = matchedArrival.system_data.logs[existingLogIndex].count;
              matchedArrival.system_data.logs[existingLogIndex].count = excelItem.count; // è¦†ç›–ï¼Œä¸æ˜¯ç´¯åŠ 
              console.log(`  -> è¦†ç›–å·²æœ‰æ•°æ®: ${excelDate} ${oldCount}æ¡ -> ${excelItem.count}æ¡`);
            } else {
              // B. å¦‚æœæ˜¯æ–°æ—¥æœŸ -> è¿½åŠ ï¼ˆæ–°å¢ï¼‰
              matchedArrival.system_data.logs.push({ date: excelDate, count: excelItem.count });
              console.log(`  -> æ–°å¢æ—¥æœŸæ•°æ®: ${excelDate} ${excelItem.count}æ¡`);
            }
            
            // 4. é‡æ–°è®¡ç®—æ€»æ•°ï¼ˆSumï¼‰
            const newTotal = matchedArrival.system_data.logs.reduce((sum, log) => sum + log.count, 0);
            matchedArrival.system_lines = newTotal;
            matchedArrival.system_data.total = newTotal;
            
            matchCount++;
            
            if (matchedArrival.is_closed) {
              console.log(`  -> ä»»åŠ¡å·²ç»“æ¡ˆï¼Œä½†å·²å¼ºåˆ¶æ›´æ–°æ•°æ®`);
            }
          });
          
          console.log(`\n========== åŒ¹é…å®Œæˆï¼Œå…±æ›´æ–° ${matchCount} ä¸ªä»»åŠ¡ ==========`);
          
          // ========== ä¼˜åŒ–ï¼šæœªå…³è”æ•°æ®æŠ¥è­¦ï¼ˆç®€çŸ­æç¤º + è¯¦ç»†æ—¥å¿—ï¼‰ ==========
          const unmatchedData = excelAggregatedData.filter(item => !item._isConsumed);
          
          if (unmatchedData.length > 0) {
            // ç»Ÿè®¡ä¾›åº”å•†æ•°é‡
            const uniqueSuppliers = new Set(unmatchedData.map(item => item.supplier));
            const supplierCount = uniqueSuppliers.size;
            const totalCount = unmatchedData.reduce((sum, item) => sum + item.count, 0);
            
            // ç®€çŸ­ alert æç¤º
            alert(`âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ° ${supplierCount} å®¶ä¾›åº”å•†ï¼ˆå…± ${totalCount} æ¡æ•°æ®ï¼‰æœªåœ¨ç³»ç»Ÿä¸­ç™»è®°å®ç‰©ï¼\nè¯·æ£€æŸ¥ 'åˆ°è´§ç™»è®°' æ˜¯å¦é—æ¼ã€‚è¯¦ç»†åå•å·²æ‰“å°è‡³æ§åˆ¶å°ã€‚`);
            
            // è¯¦ç»†æ—¥å¿—æ‰“å°åˆ°æ§åˆ¶å°
            console.warn('========== æœªå…³è”æ•°æ®è¯¦ç»†åˆ—è¡¨ ==========');
            console.warn(`å…± ${supplierCount} å®¶ä¾›åº”å•†ï¼Œ${unmatchedData.length} æ¡è®°å½•ï¼Œæ€»è®¡ ${totalCount} æ¡æ•°æ®ï¼š`);
            unmatchedData.forEach((item, index) => {
              console.warn(`${index + 1}. ${item.supplier} | ${item.date} | ${item.count}æ¡`);
            });
            console.warn('==========================================');
          }
          
          // ä¿å­˜æ›´æ–°åçš„ arrivalLog åˆ° localStorage
          try {
            localStorage.setItem('arrivalLogData', JSON.stringify(this.arrivalLog));
          } catch (e) {
            console.error('ä¿å­˜åˆ°è´§ç™»è®°æ•°æ®å¤±è´¥:', e);
          }
          
          // ========== ç¬¬å››æ­¥ï¼šæœªçŸ¥ä¾›åº”å•†å¤„ç†ï¼ˆåªæ”¶é›†ï¼Œä¸å¼¹çª—ï¼‰ ==========
          console.log('ã€ç¬¬å››æ­¥ã€‘æœªçŸ¥ä¾›åº”å•†å¤„ç†ï¼šæ”¶é›†å¾…å…³è”ä¾›åº”å•†');
          
          // æ¸…ç©ºä¹‹å‰çš„é˜Ÿåˆ—
          this.pendingAssociations = [];
          
          if (unknownSuppliersEn.size > 0) {
            // éå†æ‰€æœ‰æœªçŸ¥ä¾›åº”å•†ï¼Œæ”¶é›†ä¿¡æ¯
            unknownSuppliersEn.forEach(supplierEn => {
              // æŸ¥æ‰¾è¯¥ä¾›åº”å•†å¯¹åº”çš„ Excel æ—¥æœŸåˆ—è¡¨å’Œ Excel æ•°æ®
              const dates = [];
              const excelDataItems = [];
              
              excelAggregatedData.forEach(item => {
                // å¦‚æœä¾›åº”å•†åæ˜¯è‹±æ–‡åï¼ˆè¯´æ˜è¿˜æœªå…³è”ï¼‰ï¼Œä¸”åŒ¹é…å½“å‰ä¾›åº”å•†
                if (item.supplier === supplierEn) {
                  if (item.date !== 'æœªçŸ¥æ—¥æœŸ' && !dates.includes(item.date)) {
                    dates.push(item.date);
                  }
                  excelDataItems.push(item); // ä¿å­˜è¯¥ä¾›åº”å•†çš„æ‰€æœ‰ Excel æ•°æ®é¡¹
                }
              });
              
              dates.sort(); // æŒ‰æ—¥æœŸæ’åº
              
              // æ·»åŠ åˆ°å¾…å…³è”é˜Ÿåˆ—
              this.pendingAssociations.push({
                supplierEn: supplierEn,
                dates: dates,
                excelData: excelDataItems // ä¿å­˜è¯¥ä¾›åº”å•†çš„æ‰€æœ‰ Excel æ•°æ®ï¼Œç”¨äºåç»­å›å¡«
              });
            });
            
            console.log(`æ”¶é›†åˆ° ${this.pendingAssociations.length} ä¸ªå¾…å…³è”ä¾›åº”å•†`);
            this.pendingAssociations.forEach((item, index) => {
              console.log(`  ${index + 1}. ${item.supplierEn} (æ—¥æœŸ: ${item.dates.join(', ')})`);
            });
            
            // å¼€å§‹å¤„ç†é˜Ÿåˆ—
            this.processNextAssociation();
          } else {
            // æ²¡æœ‰æœªçŸ¥ä¾›åº”å•†ï¼Œç›´æ¥å®Œæˆ
            alert(`åŒ¹é…å®Œæˆï¼æˆåŠŸæ›´æ–° ${matchCount} ä¸ªä»»åŠ¡ã€‚`);
          }
        },

        // æ•°æ®å›å¡«æ–¹æ³•ï¼šå°†åŒ¹é…ç»“æœç´¯åŠ åˆ° arrivalLog
        fillMatchedDataToArrivalLog(geDataByDateAndSupplier) {
          // æ•°æ®å›å¡«ï¼šç´¯åŠ æ•°æ®åˆ° arrivalLogï¼ˆè€Œä¸æ˜¯ receivingTasksï¼‰
          this.arrivalLog.forEach((arrival, index) => {
            // å¦‚æœå·²ç»“æ¡ˆï¼Œè·³è¿‡æ›´æ–°ï¼ˆä¸è¦†ç›–å·²ç»“æ¡ˆçš„æ•°æ®ï¼‰
            if (arrival.is_closed) {
              return;
            }
            
            const supplierCn = arrival.ä¾›åº”å•†åç§° || '';
            const arrivalDate = arrival.æ—¥æœŸ || '';
            const arrivalTime = arrival.æ—¶é—´ || '';
            
            // åˆå§‹åŒ– system_dataï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!arrival.system_data) {
              arrival.system_data = {
                total: 0,
                logs: []
              };
            }
            if (arrival.is_closed === undefined) {
              arrival.is_closed = false;
            }
            
            // è§£æåˆ°è´§æ—¥æœŸï¼ˆç»„åˆæ—¥æœŸå’Œæ—¶é—´ï¼‰
            let arrivalDateObj = null;
            if (arrivalDate) {
              // å°è¯•è§£ææ—¥æœŸï¼Œæ”¯æŒå¤šç§æ ¼å¼
              let dateStr = arrivalDate;
              if (dateStr.includes(' ')) {
                dateStr = dateStr.split(' ')[0]; // å–æ—¥æœŸéƒ¨åˆ†
              }
              // å¤„ç† YYYY-MM-DD æ ¼å¼
              if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                arrivalDateObj = new Date(dateStr);
              } else if (dateStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
                arrivalDateObj = new Date(dateStr.replace(/\//g, '-'));
              }
            }
            
            // åŒ¹é…åˆ°è´§æ—¥æœŸåŠå…¶å3å¤©å†…çš„GEæ•°æ®
            const matchedLogs = [];
            Object.keys(geDataByDateAndSupplier).forEach(key => {
              const [geDate, geSupplier] = key.split('|');
              
              // ä¾›åº”å•†åŒ¹é…
              if (geSupplier !== supplierCn) return;
              
              // æ—¥æœŸåŒ¹é…ï¼šåˆ°è´§æ—¥æœŸåŠå…¶å3å¤©
              if (geDate === 'no_date') {
                // æ²¡æœ‰æ—¥æœŸçš„æ•°æ®ï¼Œç›´æ¥ç´¯åŠ 
                matchedLogs.push({ date: 'æœªçŸ¥æ—¥æœŸ', count: geDataByDateAndSupplier[key] });
              } else if (arrivalDateObj) {
                const geDateObj = new Date(geDate);
                const diffDays = Math.floor((geDateObj - arrivalDateObj) / (1000 * 60 * 60 * 24));
                
                if (diffDays >= 0 && diffDays <= 3) {
                  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æ—¥æœŸçš„log
                  const existingLogIndex = arrival.system_data.logs.findIndex(log => log.date === geDate);
                  if (existingLogIndex >= 0) {
                    // ç´¯åŠ 
                    arrival.system_data.logs[existingLogIndex].count += geDataByDateAndSupplier[key];
                  } else {
                    // æ–°å¢ï¼špush åˆ° logs æ•°ç»„
                    matchedLogs.push({ date: geDate, count: geDataByDateAndSupplier[key] });
                  }
                }
              }
            });
            
            // æ·»åŠ æ–°çš„logsï¼ˆpush åˆ°æ•°ç»„ï¼‰
            matchedLogs.forEach(log => {
              arrival.system_data.logs.push(log);
            });
            
            // é‡æ–°è®¡ç®—total
            arrival.system_data.total = arrival.system_data.logs.reduce((sum, log) => sum + log.count, 0);
            
            // å…¼å®¹æ—§å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰
            arrival.system_lines = arrival.system_data.total;
          });
          
          // ä¿å­˜æ›´æ–°åçš„ arrivalLog åˆ° localStorage
          try {
            localStorage.setItem('arrivalLogData', JSON.stringify(this.arrivalLog));
          } catch (e) {
            console.error('ä¿å­˜åˆ°è´§ç™»è®°æ•°æ®å¤±è´¥:', e);
          }
        },

        // ========== æ–°å¢ï¼šå¤„ç†ä¸‹ä¸€ä¸ªå…³è”ï¼ˆé€’å½’å¤„ç†é˜Ÿåˆ—ï¼‰ ==========
        processNextAssociation() {
          // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¯´æ˜å¤„ç†å®Œäº†
          if (this.pendingAssociations.length === 0) {
            // æ‰§è¡Œæœ€ç»ˆçš„æ•°æ®ä¿å­˜
            try {
              localStorage.setItem('arrivalLogData', JSON.stringify(this.arrivalLog));
              localStorage.setItem('supplierMap', JSON.stringify(this.supplierMap));
            } catch (e) {
              console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
            }
            
            // å¼¹å‡º"åŒ¹é…å®Œæˆ"æç¤º
            alert('æ‰€æœ‰ä¾›åº”å•†å·²å…³è”å®Œæˆï¼åŒ¹é…æµç¨‹ç»“æŸã€‚');
            this.showUnknownSupplierModal = false;
            this.currentAssociation = null;
            return;
          }
          
          // å–å‡ºä¸€ä¸ªï¼ˆshift()ï¼‰èµ‹å€¼ç»™ currentAssociation
          this.currentAssociation = this.pendingAssociations.shift();
          
          // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆå…³é”®ï¼ç¡®ä¿å¯ä»¥é‡æ–°è¾“å…¥ï¼‰
          this.associationCnName = '';
          
          // æ˜¾ç¤ºå¼¹çª—
          this.showUnknownSupplierModal = true;
          
          console.log(`å¤„ç†å…³è”: ${this.currentAssociation.supplierEn} (å‰©ä½™ ${this.pendingAssociations.length} ä¸ª)`);
        },

        // ========== é‡å†™ï¼šä¿å­˜å…³è”ï¼ˆä¿å­˜å¹¶ç»§ç»­ä¸‹ä¸€ä¸ªï¼‰ ==========
        saveUnknownSupplierMapping() {
          const cnName = (this.associationCnName || '').trim();
          if (!cnName) {
            alert('è¯·è¾“å…¥ä¸­æ–‡åç§°');
            return;
          }

          if (!this.currentAssociation) {
            console.error('å½“å‰å…³è”é¡¹ä¸å­˜åœ¨');
            return;
          }

          const supplierEn = this.currentAssociation.supplierEn;
          const datesToCheck = this.currentAssociation.dates.length > 0 
            ? this.currentAssociation.dates 
            : [new Date().toISOString().split('T')[0]]; // å¦‚æœæ²¡æœ‰æ—¥æœŸä¿¡æ¯ï¼Œä½¿ç”¨ä»Šå¤©

          // 1. æ›´æ–°æ˜ å°„è¡¨
          this.supplierMap[supplierEn] = cnName;
          
          // ä¿å­˜åˆ° localStorage
          try {
            localStorage.setItem('supplierMap', JSON.stringify(this.supplierMap));
          } catch (e) {
            console.error('ä¿å­˜ä¾›åº”å•†æ˜ å°„å¤±è´¥:', e);
          }

          // 2. è‡ªåŠ¨è¡¥å½•é€»è¾‘ï¼šå¦‚æœè¾“å…¥çš„ä¸­æ–‡ååœ¨ç°æœ‰ä»»åŠ¡ä¸­æ‰¾ä¸åˆ°ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€æ¡æ–°çš„å®ç‰©ç™»è®°è®°å½•
          let createdCount = 0;
          datesToCheck.forEach(dateStr => {
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥ä¾›åº”å•†å’Œæ—¥æœŸçš„ä»»åŠ¡
            const existingArrival = this.arrivalLog.find(arrival => {
              const arrivalSupplier = arrival.ä¾›åº”å•†åç§° || arrival.supplier || arrival.supplier_cn || '';
              const arrivalDate = this.normalizeDate(arrival.æ—¥æœŸ || arrival.date || '');
              return arrivalSupplier === cnName && arrivalDate === dateStr;
            });
            
            if (!existingArrival) {
              // ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€æ¡æ–°çš„å®ç‰©ç™»è®°è®°å½•
              const newArrival = {
                ä¾›åº”å•†åç§°: cnName,
                supplier_cn: cnName,
                æ—¥æœŸ: dateStr,
                date: dateStr,
                å®ç‰©æ•°é‡: 0,
                physical_qty: 0,
                å•ä½: 'ä»¶',
                unit: 'ä»¶',
                å¤‡æ³¨: 'ç³»ç»Ÿè‡ªåŠ¨è¡¥å½•ï¼ˆExcel åŒ¹é…æ—¶åˆ›å»ºï¼‰',
                system_data: {
                  total: 0,
                  logs: []
                },
                is_closed: false
              };
              
              this.arrivalLog.push(newArrival);
              createdCount++;
              console.log(`âœ“ è‡ªåŠ¨åˆ›å»ºåˆ°è´§ç™»è®°è®°å½•: ${cnName} ${dateStr}`);
            }
          });
          
          // æç¤ºç”¨æˆ·
          if (createdCount > 0) {
            console.log(`å·²è‡ªåŠ¨ä¸ºæ‚¨è¡¥å½• '${cnName}' çš„åˆ°è´§ç™»è®°è®°å½•ï¼ˆ${createdCount} æ¡ï¼‰ã€‚`);
          }

          // 3. ç«‹å³æ‰§è¡Œæ•°æ®å›å¡«ï¼šæŠŠå½“å‰è¿™ä¸ªä¾›åº”å•†çš„ Excel æ•°æ®å¡«å…¥å¯¹åº”çš„ä»»åŠ¡å¡ç‰‡
          if (this.currentAssociation.excelData && this.currentAssociation.excelData.length > 0) {
            this.currentAssociation.excelData.forEach(excelItem => {
              // æ›´æ–°ä¾›åº”å•†åä¸ºä¸­æ–‡åï¼ˆå› ä¸ºç°åœ¨æ˜ å°„å·²å»ºç«‹ï¼‰
              excelItem.supplier = cnName;
              
              // æŸ¥æ‰¾åŒ¹é…çš„ä»»åŠ¡ï¼ˆPriority A/Bï¼‰
              let matchedArrival = null;
              
              // Priority A: ç²¾å‡†åŒ¹é…
              for (let i = 0; i < this.arrivalLog.length; i++) {
                const arrival = this.arrivalLog[i];
                const taskSupplier = arrival.ä¾›åº”å•†åç§° || arrival.supplier || arrival.supplier_cn || '';
                const taskDateRaw = arrival.æ—¥æœŸ || arrival.date || '';
                const taskDate = this.normalizeDate(taskDateRaw);
                
                if (taskSupplier === cnName && taskDate === excelItem.date) {
                  matchedArrival = arrival;
                  break;
                }
              }
              
              // Priority B: å¡«å‘åŒ¹é…
              if (!matchedArrival) {
                let earliestArrival = null;
                let earliestDate = null;
                
                for (let i = 0; i < this.arrivalLog.length; i++) {
                  const arrival = this.arrivalLog[i];
                  const taskSupplier = arrival.ä¾›åº”å•†åç§° || arrival.supplier || arrival.supplier_cn || '';
                  const taskDateRaw = arrival.æ—¥æœŸ || arrival.date || '';
                  const taskDate = this.normalizeDate(taskDateRaw);
                  
                  if (taskSupplier === cnName && !arrival.is_closed && taskDate) {
                    if (!earliestDate || taskDate < earliestDate) {
                      earliestArrival = arrival;
                      earliestDate = taskDate;
                    }
                  }
                }
                
                if (earliestArrival) {
                  matchedArrival = earliestArrival;
                }
              }
              
              // æ‰§è¡Œå›å¡«
              if (matchedArrival) {
                if (!matchedArrival.system_data) {
                  matchedArrival.system_data = { total: 0, logs: [] };
                }
                if (!matchedArrival.system_data.logs) {
                  matchedArrival.system_data.logs = [];
                }
                
                const excelDate = excelItem.date === 'æœªçŸ¥æ—¥æœŸ' ? 'æœªçŸ¥æ—¥æœŸ' : excelItem.date;
                const existingLogIndex = matchedArrival.system_data.logs.findIndex(log => log.date === excelDate);
                
                if (existingLogIndex >= 0) {
                  matchedArrival.system_data.logs[existingLogIndex].count = excelItem.count;
                } else {
                  matchedArrival.system_data.logs.push({ date: excelDate, count: excelItem.count });
                }
                
                const newTotal = matchedArrival.system_data.logs.reduce((sum, log) => sum + log.count, 0);
                matchedArrival.system_lines = newTotal;
                matchedArrival.system_data.total = newTotal;
                
                console.log(`âœ“ æ•°æ®å›å¡«: ${cnName} ${excelDate} -> ${excelItem.count}æ¡`);
              }
            });
          }

          // 4. å…³é—­å¼¹çª—
          this.showUnknownSupplierModal = false;
          
          // 5. å…³é”®åŠ¨ä½œï¼šå†æ¬¡è°ƒç”¨ processNextAssociation()ï¼ˆè§¦å‘ä¸‹ä¸€ä¸ªå¼¹çª—ï¼‰
          this.processNextAssociation();
        },

        // è·å–æ’åºåçš„logsï¼ˆæŒ‰æ—¥æœŸæ’åºï¼‰
        getSortedLogs(task) {
          if (!task || !task.system_data || !task.system_data.logs) {
            return [];
          }
          const logs = [...task.system_data.logs];
          // æ’é™¤"æœªçŸ¥æ—¥æœŸ"ï¼ŒæŒ‰æ—¥æœŸæ’åº
          return logs
            .filter(log => log.date !== 'æœªçŸ¥æ—¥æœŸ')
            .sort((a, b) => {
              const dateA = new Date(a.date);
              const dateB = new Date(b.date);
              return dateA - dateB;
            });
        },

        // è®¡ç®—æ—¶æ•ˆåˆ†ç±»æ ‡ç­¾ï¼ˆä½¿ç”¨å‡æœŸæ‰£é™¤é€»è¾‘ï¼‰
        getTimelinessLabel(log, task) {
          if (log.date === 'æœªçŸ¥æ—¥æœŸ') {
            return 'æœªçŸ¥';
          }
          
          const arrivalDate = task.æ—¥æœŸ || task.date || '';
          if (!arrivalDate) {
            return 'æœªçŸ¥';
          }
          
          // è§£æåˆ°è´§æ—¥æœŸ
          let arrivalDateStr = arrivalDate;
          if (arrivalDateStr.includes(' ')) {
            arrivalDateStr = arrivalDateStr.split(' ')[0];
          }
          if (arrivalDateStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
            arrivalDateStr = arrivalDateStr.replace(/\//g, '-');
          }
          
          const arrivalDateNormalized = this.normalizeDate(arrivalDateStr);
          const logDateNormalized = this.normalizeDate(log.date);
          
          if (!arrivalDateNormalized || !logDateNormalized) {
            return 'æœªçŸ¥';
          }
          
          // ä½¿ç”¨ calculateNetDays è®¡ç®—å‡€å¤©æ•°ï¼ˆæ‰£é™¤å‡æœŸï¼‰
          const netDiffDays = this.calculateNetDays(arrivalDateNormalized, logDateNormalized);
          
          if (netDiffDays === 0) {
            return 'N (å½“å¤©)';
          } else if (netDiffDays === 1) {
            return 'N+1';
          } else if (netDiffDays > 1) {
            return `è¶…æ—¶ (N+${netDiffDays})`;
          } else {
            return 'æœªçŸ¥';
          }
        },

        // è·å–æ—¶æ•ˆåˆ†ç±»çš„CSSç±»ï¼ˆä½¿ç”¨å‡æœŸæ‰£é™¤é€»è¾‘ï¼‰
        getTimelinessClass(log, task) {
          if (log.date === 'æœªçŸ¥æ—¥æœŸ') {
            return 'bg-gray-100 text-gray-600';
          }
          
          const arrivalDate = task.æ—¥æœŸ || task.date || '';
          if (!arrivalDate) {
            return 'bg-gray-100 text-gray-600';
          }
          
          // è§£æåˆ°è´§æ—¥æœŸ
          let arrivalDateStr = arrivalDate;
          if (arrivalDateStr.includes(' ')) {
            arrivalDateStr = arrivalDateStr.split(' ')[0];
          }
          if (arrivalDateStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
            arrivalDateStr = arrivalDateStr.replace(/\//g, '-');
          }
          
          const arrivalDateNormalized = this.normalizeDate(arrivalDateStr);
          const logDateNormalized = this.normalizeDate(log.date);
          
          if (!arrivalDateNormalized || !logDateNormalized) {
            return 'bg-gray-100 text-gray-600';
          }
          
          // ä½¿ç”¨ calculateNetDays è®¡ç®—å‡€å¤©æ•°ï¼ˆæ‰£é™¤å‡æœŸï¼‰
          const netDiffDays = this.calculateNetDays(arrivalDateNormalized, logDateNormalized);
          
          if (netDiffDays === 0) {
            return 'bg-green-100 text-green-700';
          } else if (netDiffDays === 1) {
            return 'bg-yellow-100 text-yellow-700';
          } else if (netDiffDays > 1) {
            return 'bg-red-100 text-red-700';
          } else {
            return 'bg-gray-100 text-gray-600';
          }
        },

        // è®¡ç®—å æ¯”
        getLogPercentage(log, task) {
          if (!task || !task.system_data || !task.system_data.total || task.system_data.total === 0) {
            return '0.0';
          }
          const percentage = (log.count / task.system_data.total) * 100;
          return percentage.toFixed(1);
        },

        // ========== å‡æœŸç®¡ç†æ–¹æ³• ==========
        addHoliday() {
          if (!this.newHolidayDate) {
            alert('è¯·é€‰æ‹©æ—¥æœŸ');
            return;
          }
          
          const dateStr = this.normalizeDate(this.newHolidayDate);
          if (!dateStr) {
            alert('æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®');
            return;
          }
          
          if (this.holidays.includes(dateStr)) {
            alert('è¯¥æ—¥æœŸå·²å­˜åœ¨');
            return;
          }
          
          this.holidays.push(dateStr);
          this.holidays.sort(); // æŒ‰æ—¥æœŸæ’åº
          this.newHolidayDate = '';
          
          // ä¿å­˜åˆ° localStorage
          this.saveHolidays();
        },

        removeHoliday(index) {
          if (index >= 0 && index < this.holidays.length) {
            this.holidays.splice(index, 1);
            // ä¿å­˜åˆ° localStorage
            this.saveHolidays();
          }
        },

        saveHolidays() {
          try {
            localStorage.setItem('supplierMonitorHolidays', JSON.stringify(this.holidays));
          } catch (e) {
            console.error('ä¿å­˜å‡æœŸæ•°æ®å¤±è´¥:', e);
          }
        },

        loadHolidays() {
          try {
            const saved = localStorage.getItem('supplierMonitorHolidays');
            if (saved) {
              this.holidays = JSON.parse(saved);
            }
          } catch (e) {
            console.error('åŠ è½½å‡æœŸæ•°æ®å¤±è´¥:', e);
            this.holidays = [];
          }
        },

        // ========== è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—å‡€å¤©æ•°ï¼ˆæ‰£é™¤å‡æœŸï¼‰ ==========
        // è¾“å…¥ï¼šstartDate (YYYY-MM-DD), endDate (YYYY-MM-DD)
        // è¿”å›ï¼šå‡€å¤©æ•°ï¼ˆå·²æ‰£é™¤æœŸé—´åŒ…å«çš„å‡æœŸå¤©æ•°ï¼‰ï¼Œæœ€å°ä¸º 0
        calculateNetDays(startDate, endDate) {
          if (!startDate || !endDate) return 0;
          
          // è§£ææ—¥æœŸå­—ç¬¦ä¸²
          const start = new Date(startDate);
          const end = new Date(endDate);
          
          if (isNaN(start.getTime()) || isNaN(end.getTime())) return 0;
          
          // è®¡ç®—æ€»å¤©æ•°å·®
          const totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24));
          
          // è®¡ç®—æœŸé—´åŒ…å«çš„å‡æœŸå¤©æ•°
          let holidayCount = 0;
          const holidaysSet = new Set(this.holidays || []);
          
          // éå†ä» startDate åˆ° endDate çš„æ¯ä¸€å¤©
          const currentDate = new Date(start);
          while (currentDate <= end) {
            const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
            if (holidaysSet.has(dateStr)) {
              holidayCount++;
            }
            currentDate.setDate(currentDate.getDate() + 1);
          }
          
          // å‡€å¤©æ•° = æ€»å¤©æ•° - å‡æœŸå¤©æ•°ï¼Œæœ€å°ä¸º 0
          const netDays = Math.max(0, totalDays - holidayCount);
          
          return netDays;
        },

        // ç»“æ¡ˆåŠŸèƒ½ï¼šè®¡ç®—KPIå¹¶æ ‡è®°ä¸ºå·²ç»“æ¡ˆï¼ˆä½¿ç”¨å‡æœŸæ‰£é™¤é€»è¾‘ï¼‰
        closeReceivingTask(task) {
          if (!task) return;
          
          // åœ¨ arrivalLog ä¸­æ‰¾åˆ°å¯¹åº”çš„è®°å½•ï¼ˆé€šè¿‡ _arrivalIndex æˆ–åŒ¹é…ä¾›åº”å•†å’Œæ—¥æœŸï¼‰
          let arrivalIndex = -1;
          if (task._arrivalIndex !== undefined && task._arrivalIndex >= 0) {
            arrivalIndex = task._arrivalIndex;
          } else {
            // é€šè¿‡ä¾›åº”å•†åç§°å’Œæ—¥æœŸåŒ¹é…
            arrivalIndex = this.arrivalLog.findIndex(arrival => 
              arrival.ä¾›åº”å•†åç§° === task.supplier_cn && 
              (arrival.æ—¥æœŸ === task.åˆ°è´§æ—¥æœŸ || arrival.æ—¥æœŸ === task.date)
            );
          }
          
          if (arrivalIndex === -1) {
            alert('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„åˆ°è´§ç™»è®°è®°å½•');
            return;
          }
          
          const arrival = this.arrivalLog[arrivalIndex];
          
          // å¦‚æœå·²ç»“æ¡ˆï¼Œä¸é‡å¤å¤„ç†
          if (arrival.is_closed) {
            alert('è¯¥ä»»åŠ¡å·²ç»“æ¡ˆ');
            return;
          }
          
          // è§£æåˆ°è´§æ—¥æœŸ
          const arrivalDate = arrival.æ—¥æœŸ || '';
          if (!arrivalDate) {
            alert('æ— æ³•ç»“æ¡ˆï¼šç¼ºå°‘åˆ°è´§æ—¥æœŸ');
            return;
          }
          
          // è§£ææ—¥æœŸå­—ç¬¦ä¸²
          let arrivalDateStr = arrivalDate;
          if (arrivalDateStr.includes(' ')) {
            arrivalDateStr = arrivalDateStr.split(' ')[0];
          }
          // å¤„ç†æ—¥æœŸæ ¼å¼
          if (arrivalDateStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
            arrivalDateStr = arrivalDateStr.replace(/\//g, '-');
          }
          const arrivalDateNormalized = this.normalizeDate(arrivalDateStr);
          
          // åˆå§‹åŒ–KPIæ•°æ®
          let nCount = 0;  // Diff = 0
          let nPlus1Count = 0;  // Diff = 1
          let overtimeCount = 0;  // Diff > 1
          let totalCount = 0;
          
          // éå†logsæ•°ç»„ï¼Œè®¡ç®—KPIï¼ˆä½¿ç”¨å‡æœŸæ‰£é™¤é€»è¾‘ï¼‰
          if (arrival.system_data && arrival.system_data.logs) {
            arrival.system_data.logs.forEach(log => {
              if (log.date === 'æœªçŸ¥æ—¥æœŸ') {
                // æœªçŸ¥æ—¥æœŸçš„æ•°æ®ä¸è®¡å…¥KPI
                return;
              }
              
              const logDateNormalized = this.normalizeDate(log.date);
              if (!logDateNormalized) {
                return;
              }
              
              // ä½¿ç”¨ calculateNetDays è®¡ç®—å‡€å¤©æ•°ï¼ˆæ‰£é™¤å‡æœŸï¼‰
              const netDiffDays = this.calculateNetDays(arrivalDateNormalized, logDateNormalized);
              
              if (netDiffDays === 0) {
                nCount += log.count;
              } else if (netDiffDays === 1) {
                nPlus1Count += log.count;
              } else if (netDiffDays > 1) {
                overtimeCount += log.count;
              }
              
              totalCount += log.count;
            });
          }
          
          // è®¡ç®—ç™¾åˆ†æ¯”
          const nPercent = totalCount > 0 ? Math.round((nCount / totalCount) * 100) : 0;
          const nPlus1Percent = totalCount > 0 ? Math.round((nPlus1Count / totalCount) * 100) : 0;
          const overtimePercent = totalCount > 0 ? Math.round((overtimeCount / totalCount) * 100) : 0;
          
          // ä¿å­˜KPIæ•°æ®åˆ° arrivalLog è®°å½•
          arrival.kpi = {
            n: nCount,
            nPlus1: nPlus1Count,
            overtime: overtimeCount,
            total: totalCount,
            nPercent: nPercent,
            nPlus1Percent: nPlus1Percent,
            overtimePercent: overtimePercent
          };
          
          // æ ‡è®°ä¸ºå·²ç»“æ¡ˆ
          arrival.is_closed = true;
          
          // ä¿å­˜åˆ°localStorageï¼ˆä¿å­˜åˆ° arrivalLogDataï¼‰
          try {
            localStorage.setItem('arrivalLogData', JSON.stringify(this.arrivalLog));
          } catch (e) {
            console.error('ä¿å­˜ç»“æ¡ˆæ•°æ®å¤±è´¥:', e);
          }
          
          alert(`ç»“æ¡ˆæˆåŠŸï¼\nKPIåˆ†å¸ƒï¼š\nN: ${nPercent}% (${nCount}æ¡)\nN+1: ${nPlus1Percent}% (${nPlus1Count}æ¡)\nè¶…æ—¶: ${overtimePercent}% (${overtimeCount}æ¡)`);
        },

        // åˆ‡æ¢æ”¶è´§ä»»åŠ¡æ ‡ç­¾
        changeReceivingTab(tab) {
          this.activeReceivingTab = tab;
          this.receivingPage = 1;
        },

        // æ‰“å¼€ç™»è®°å®ç‰©å¼¹çª—
        openNewReceivingModal() {
          this.newReceivingTask = {
            ä¾›åº”å•†åç§°: '',
            supplier_en: '',
            supplier_cn: '',
            åˆ°è´§æ—¥æœŸ: '',
            æ€»è¡Œæ•°: 0,
            physical_qty: '',
            unit: 'æ‰˜',
            data_source: 'pending',
            å¤‡æ³¨: '',
            system_lines: 0,
            å½“å‰çŠ¶æ€: 'æ­£å¸¸'
          };
          this.showNewReceivingModal = true;
        },

        // å…³é—­ç™»è®°å®ç‰©å¼¹çª—
        closeNewReceivingModal() {
          this.showNewReceivingModal = false;
        },

        // ä¿å­˜æ”¶è´§ä»»åŠ¡
        saveReceivingTask() {
          if (!this.newReceivingTask.ä¾›åº”å•†åç§° || !this.newReceivingTask.åˆ°è´§æ—¥æœŸ || !this.newReceivingTask.physical_qty) {
            alert('è¯·å¡«å†™å¿…å¡«é¡¹');
            return;
          }

          const task = {
            ...this.newReceivingTask,
            supplier_cn: this.newReceivingTask.ä¾›åº”å•†åç§°,
            date: this.newReceivingTask.åˆ°è´§æ—¥æœŸ,
            å·²å®Œæˆæ•°é‡: 0,
            æ¯æ—¥è¿›åº¦è®°å½•: [],
            // æ–°çš„æ•°æ®ç»“æ„ï¼šsystem_data å¯¹è±¡
            system_data: {
              total: 0,
              logs: []
            },
            is_closed: false
          };

          this.receivingTasks.push(task);

          try {
            localStorage.setItem('receivingTasks', JSON.stringify(this.receivingTasks));
          } catch (e) {
            console.error('ä¿å­˜æ”¶è´§ä»»åŠ¡å¤±è´¥:', e);
          }

          alert('ç™»è®°æˆåŠŸ');
          this.closeNewReceivingModal();
        },

        // å¯¼å‡ºä¾›åº”å•†æ”¶è´§æ•°æ®
        exportSupplierReceivingToExcel() {
          const dataToExport = this.filteredReceivingTasks.map(task => ({
            'ä¾›åº”å•†åç§°': task.ä¾›åº”å•†åç§° || task.supplier_cn || '',
            'åˆ°è´§æ—¥æœŸ': task.åˆ°è´§æ—¥æœŸ || task.date || '',
            'å®ç‰©æ•°é‡': task.physical_qty || 0,
            'å•ä½': task.unit || '',
            'æ€»è¡Œæ•°': task.æ€»è¡Œæ•° || 0,
            'ç³»ç»ŸåŒ¹é…è¡Œæ•°': task.system_lines || 0,
            'å½“å‰çŠ¶æ€': task.å½“å‰çŠ¶æ€ || '',
            'å¤‡æ³¨': task.å¤‡æ³¨ || ''
          }));

          const ws = XLSX.utils.json_to_sheet(dataToExport);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'ä¾›åº”å•†æ”¶è´§ç›‘æ§');
          XLSX.writeFile(wb, `ä¾›åº”å•†æ”¶è´§ç›‘æ§_${new Date().toISOString().split('T')[0]}.xlsx`);
        },

        // ========== åˆ°è´§ç™»è®°ç›¸å…³æ–¹æ³• ==========
        // æ‰“å¼€ç™»è®°å¼¹çª—
        openArrivalModal() {
          this.newArrival = {
            æ—¥æœŸ: '',
            æ—¶é—´: '',
            ä¾›åº”å•†åç§°: '',
            å®ç‰©æ•°é‡: '',
            å•ä½: 'æ‰˜',
            é€è´§å•å·: '',
            å¤‡æ³¨: '',
            status: 'å¾…æ”¶è´§',
            actual_qty: null
          };
          this.showArrivalModal = true;
        },

        // å…³é—­ç™»è®°å¼¹çª—
        closeArrivalModal() {
          this.showArrivalModal = false;
        },

        // ä¿å­˜åˆ°è´§ç™»è®°
        saveArrival() {
          if (!this.newArrival.æ—¥æœŸ || !this.newArrival.æ—¶é—´ || !this.newArrival.ä¾›åº”å•†åç§° || !this.newArrival.å®ç‰©æ•°é‡) {
            alert('è¯·å¡«å†™å¿…å¡«é¡¹ï¼ˆæ—¥æœŸã€æ—¶é—´ã€ä¾›åº”å•†åç§°ã€å®ç‰©æ•°é‡ï¼‰');
            return;
          }

          // ä¿å­˜ä¾›åº”å•†åç§°åˆ°å†å²è®°å½•
          const supplierName = this.newArrival.ä¾›åº”å•†åç§°.trim();
          if (supplierName && !this.savedSupplierNames.includes(supplierName)) {
            this.savedSupplierNames.push(supplierName);
            try {
              localStorage.setItem('savedSupplierNames', JSON.stringify(this.savedSupplierNames));
            } catch (e) {
              console.error('ä¿å­˜ä¾›åº”å•†åç§°åˆ—è¡¨å¤±è´¥:', e);
            }
          }

          const arrival = {
            ...this.newArrival,
            finish_time: ''
          };

          this.arrivalLog.push(arrival);

          try {
            localStorage.setItem('arrivalLogData', JSON.stringify(this.arrivalLog));
          } catch (e) {
            console.error('ä¿å­˜åˆ°è´§ç™»è®°æ•°æ®å¤±è´¥:', e);
          }

          alert('ç™»è®°æˆåŠŸ');
          this.closeArrivalModal();
        },

        // æ‰“å¼€æ”¶è´§åé¦ˆå¼¹çª—
        openArrivalFeedbackModal(index) {
          this.currentArrivalFeedbackIndex = index;
          const item = this.arrivalLog[index];
          this.arrivalFeedback = {
            actual_qty: item.actual_qty !== null && item.actual_qty !== undefined ? item.actual_qty : '',
            feedback_remark: item.feedback_remark || ''
          };
          this.showArrivalFeedbackModal = true;
        },

        // å…³é—­æ”¶è´§åé¦ˆå¼¹çª—
        closeArrivalFeedbackModal() {
          this.showArrivalFeedbackModal = false;
          this.currentArrivalFeedbackIndex = -1;
          this.arrivalFeedback = { actual_qty: '', feedback_remark: '' };
        },

        // ä¿å­˜æ”¶è´§åé¦ˆ
        saveArrivalFeedback() {
          if (this.currentArrivalFeedbackIndex < 0) return;
          if (this.arrivalFeedback.actual_qty === '' || this.arrivalFeedback.actual_qty === null) {
            alert('è¯·è¾“å…¥å®é™…æ”¶è´§æ•°é‡');
            return;
          }

          const item = this.arrivalLog[this.currentArrivalFeedbackIndex];
          item.actual_qty = Number(this.arrivalFeedback.actual_qty);
          item.feedback_remark = this.arrivalFeedback.feedback_remark || '';
          item.status = 'å·²å®Œæˆ';
          item.finish_time = new Date().toLocaleString('zh-CN');

          try {
            localStorage.setItem('arrivalLogData', JSON.stringify(this.arrivalLog));
          } catch (e) {
            console.error('ä¿å­˜åˆ°è´§ç™»è®°æ•°æ®å¤±è´¥:', e);
          }

          alert('åé¦ˆä¿å­˜æˆåŠŸ');
          this.closeArrivalFeedbackModal();
        },

        // åˆ é™¤åˆ°è´§è®°å½•
        deleteArrivalRecord(index) {
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
            this.arrivalLog.splice(index, 1);
            try {
              localStorage.setItem('arrivalLogData', JSON.stringify(this.arrivalLog));
            } catch (e) {
              console.error('ä¿å­˜åˆ°è´§ç™»è®°æ•°æ®å¤±è´¥:', e);
            }
            alert('åˆ é™¤æˆåŠŸ');
          }
        },

        // å¯¼å‡ºåˆ°è´§ç™»è®°æ•°æ®
        exportArrivalToExcel() {
          const dataToExport = this.filteredArrivalLog.map(item => {
            // è®¡ç®—çŠ¶æ€ï¼šå¦‚æœ actual_qty æœ‰å€¼ä¸”ä¸ physical_qty ä¸åŒï¼Œæ˜¾ç¤º"æœ‰å·®å¼‚"
            let status = item.status || 'å¾…æ”¶è´§';
            if (item.actual_qty !== null && item.actual_qty !== undefined) {
              const physicalQty = Number(item.å®ç‰©æ•°é‡);
              const actualQty = Number(item.actual_qty);
              if (!isNaN(physicalQty) && !isNaN(actualQty) && physicalQty !== actualQty) {
                status = 'æœ‰å·®å¼‚';
              }
            }
            
            return {
              'æ—¥æœŸ': item.æ—¥æœŸ || '',
              'æ—¶é—´': item.æ—¶é—´ || '',
              'ä¾›åº”å•†åç§°': item.ä¾›åº”å•†åç§° || '',
              'å®ç‰©æ•°é‡': item.å®ç‰©æ•°é‡ || '',
              'å®é™…æ”¶è´§': item.actual_qty !== null && item.actual_qty !== undefined ? item.actual_qty : '',
              'çŠ¶æ€': status,
              'å®Œæˆæ—¶é—´': item.finish_time || '',
              'å•ä½': item.å•ä½ || '',
              'é€è´§å•å·': item.é€è´§å•å· || '',
              'å¤‡æ³¨': item.å¤‡æ³¨ || ''
            };
          });

          const ws = XLSX.utils.json_to_sheet(dataToExport);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'åˆ°è´§ç™»è®°');
          XLSX.writeFile(wb, `åˆ°è´§ç™»è®°_${new Date().toISOString().split('T')[0]}.xlsx`);
        },

        // åˆ·æ–°åˆ°è´§ç™»è®°æ•°æ®
        refreshArrivalData() {
          try {
            const saved = localStorage.getItem('arrivalLogData');
            if (saved) {
              this.arrivalLog = JSON.parse(saved);
              alert('æ•°æ®å·²åˆ·æ–°');
            }
          } catch (e) {
            console.error('è¯»å–åˆ°è´§ç™»è®°æ•°æ®å¤±è´¥:', e);
          }
        },

        // ========== å®¢æˆ·è´¹ç”¨ç»“ç®—ç›¸å…³æ–¹æ³• ==========
        // æ‰“å¼€ç™»è®°è´¹ç”¨å¼¹çª—
        openBillingModal() {
          this.newBilling = {
            å®¢æˆ·åç§°: '',
            è´¹ç”¨ç±»å‹: '',
            é¢ç§¯: '',
            ç»“ç®—å‘¨æœŸ: '',
            è´¹ç”¨è¯´æ˜: '',
            å‘ç”Ÿæ—¥æœŸ: '',
            é‡‘é¢: '',
            ç»“ç®—çŠ¶æ€: 'å¾…ç»“ç®—',
            ä¸‹æ¬¡æé†’æ—¥æœŸ: ''
          };
          this.showBillingModal = true;
        },

        // å…³é—­ç™»è®°è´¹ç”¨å¼¹çª—
        closeBillingModal() {
          this.showBillingModal = false;
        },

        // è®¡ç®—æé†’æ—¥æœŸ - é€šç”¨å‡½æ•°
        calculateReminder(date, cycle) {
          // å¦‚æœå‚æ•°ä¸ºç©ºï¼Œä½¿ç”¨ newBilling çš„å€¼ï¼ˆå…¼å®¹æ—§è°ƒç”¨æ–¹å¼ï¼Œç”¨äºæ‰‹åŠ¨å½•å…¥ï¼‰
          let isManualEntry = false;
          if (!date && !cycle) {
            if (!this.newBilling.å‘ç”Ÿæ—¥æœŸ || !this.newBilling.ç»“ç®—å‘¨æœŸ) {
              if (this.newBilling) {
                this.newBilling.ä¸‹æ¬¡æé†’æ—¥æœŸ = '';
              }
              return;
            }
            date = this.newBilling.å‘ç”Ÿæ—¥æœŸ;
            cycle = this.newBilling.ç»“ç®—å‘¨æœŸ;
            isManualEntry = true;
          }

          if (!date || !cycle) {
            if (isManualEntry && this.newBilling) {
              this.newBilling.ä¸‹æ¬¡æé†’æ—¥æœŸ = '';
            }
            return '--';
          }

          // å°†æ—¥æœŸå­—ç¬¦ä¸²è½¬ä¸º Date å¯¹è±¡
          const dateObj = new Date(date);
          if (isNaN(dateObj.getTime())) {
            if (isManualEntry && this.newBilling) {
              this.newBilling.ä¸‹æ¬¡æé†’æ—¥æœŸ = '';
            }
            return '--';
          }

          // æ ¹æ®ç»“ç®—å‘¨æœŸè®¡ç®—
          if (cycle === 'å•æ¬¡') {
            // å•æ¬¡ï¼šç›´æ¥è¿”å›å‘ç”Ÿæ—¥æœŸï¼ˆå³å½“å¤©æé†’ï¼Œä¸æå‰ï¼‰
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const result = `${year}-${month}-${day}`;
            if (isManualEntry && this.newBilling) {
              this.newBilling.ä¸‹æ¬¡æé†’æ—¥æœŸ = result;
            }
            return result;
          } else if (cycle === 'æœˆç»“') {
            // æœˆç»“ï¼šå‘ç”Ÿæ—¥æœŸ + 1ä¸ªæœˆ - 15å¤©
            dateObj.setMonth(dateObj.getMonth() + 1);
            dateObj.setDate(dateObj.getDate() - 15);
          } else if (cycle === 'å­£ç»“') {
            // å­£ç»“ï¼šå‘ç”Ÿæ—¥æœŸ + 3ä¸ªæœˆ - 15å¤©
            dateObj.setMonth(dateObj.getMonth() + 3);
            dateObj.setDate(dateObj.getDate() - 15);
          } else if (cycle === 'åŠå¹´ç»“') {
            // åŠå¹´ç»“ï¼šå‘ç”Ÿæ—¥æœŸ + 6ä¸ªæœˆ - 15å¤©
            dateObj.setMonth(dateObj.getMonth() + 6);
            dateObj.setDate(dateObj.getDate() - 15);
          } else if (cycle === 'å¹´ç»“') {
            // å¹´ç»“ï¼šå‘ç”Ÿæ—¥æœŸ + 1å¹´ - 15å¤©
            dateObj.setFullYear(dateObj.getFullYear() + 1);
            dateObj.setDate(dateObj.getDate() - 15);
          } else {
            // æœªçŸ¥å‘¨æœŸï¼Œè¿”å› --
            if (isManualEntry && this.newBilling) {
            this.newBilling.ä¸‹æ¬¡æé†’æ—¥æœŸ = '';
            }
            return '--';
          }

          // æ ¼å¼åŒ–è¾“å‡º YYYY-MM-DD
          const year = dateObj.getFullYear();
          const month = String(dateObj.getMonth() + 1).padStart(2, '0');
          const day = String(dateObj.getDate()).padStart(2, '0');
          const result = `${year}-${month}-${day}`;
          
          // å¦‚æœæ˜¯æ‰‹åŠ¨å½•å…¥ï¼Œæ›´æ–° newBilling.ä¸‹æ¬¡æé†’æ—¥æœŸ
          if (isManualEntry && this.newBilling) {
            this.newBilling.ä¸‹æ¬¡æé†’æ—¥æœŸ = result;
          }
          
          return result;
        },

        // ä¿å­˜è´¹ç”¨
        saveBilling() {
          if (!this.newBilling.å®¢æˆ·åç§° || !this.newBilling.è´¹ç”¨ç±»å‹ || !this.newBilling.å‘ç”Ÿæ—¥æœŸ || !this.newBilling.é‡‘é¢) {
            alert('è¯·å¡«å†™å¿…å¡«é¡¹');
            return;
          }

          // è‡ªåŠ¨è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸ
          const newItem = { ...this.newBilling };
          newItem.ä¸‹æ¬¡æé†’æ—¥æœŸ = this.calculateReminder(newItem.å‘ç”Ÿæ—¥æœŸ, newItem.ç»“ç®—å‘¨æœŸ);

          this.billingRecord.push(newItem);

          try {
            localStorage.setItem('billingRecord', JSON.stringify(this.billingRecord));
          } catch (e) {
            console.error('ä¿å­˜è´¹ç”¨æ•°æ®å¤±è´¥:', e);
          }

          alert('è´¹ç”¨ç™»è®°æˆåŠŸ');
          this.closeBillingModal();
        },

        // ç¡®è®¤å›æ¬¾
        confirmBillingPayment(item, index) {
          if (confirm('ç¡®å®šè¦ç¡®è®¤å›æ¬¾å—ï¼Ÿ')) {
            this.billingRecord[index].ç»“ç®—çŠ¶æ€ = 'å·²å›æ¬¾';
            this.billingRecord[index].ä¸‹æ¬¡æé†’æ—¥æœŸ = '';
            
            try {
              localStorage.setItem('billingRecord', JSON.stringify(this.billingRecord));
            } catch (e) {
              console.error('ä¿å­˜è´¹ç”¨æ•°æ®å¤±è´¥:', e);
            }
            
            alert('å›æ¬¾ç¡®è®¤æˆåŠŸ');
          }
        },

        // æ˜¾ç¤ºé‡‘é¢ï¼ˆæƒé™æ§åˆ¶ï¼‰
        displayBillingAmount(amount) {
          if (this.currentUser.role === 'admin' || this.currentUser.role === 'boss') {
            return Number(amount).toLocaleString('zh-CN', { style: 'currency', currency: 'CNY' });
          }
          return '****';
        },

        // æ£€æŸ¥æé†’æ—¥æœŸæ˜¯å¦è¿‡æœŸ
        isReminderDateOverdue(dateStr) {
          if (!dateStr) return false;
          const reminderDate = new Date(dateStr);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          return reminderDate < today;
        },

        // æ£€æŸ¥æ˜¯å¦åˆ°æœŸï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰
        checkIsDue(dateString) {
          if (!dateString || dateString === '--') return false;
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const dueDate = new Date(dateString);
          if (isNaN(dueDate.getTime())) return false;
          dueDate.setHours(0, 0, 0, 0);
          // å¦‚æœå½“å‰æ—¥æœŸ >= æé†’æ—¥æœŸï¼Œè¿”å› trueï¼ˆå·²åˆ°æœŸï¼‰
          return today >= dueDate;
        },

        // è§¦å‘è´¹ç”¨å¯¼å…¥
        triggerBillingImport() {
          if (this.$refs.billingFileInput) {
            this.$refs.billingFileInput.click();
          }
        },

        // å¤„ç†è´¹ç”¨å¯¼å…¥
        handleBillingImport(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              // ä½¿ç”¨ raw: true ä»¥è·å–åŸå§‹æ•°å­—å€¼ï¼ˆç”¨äºæ—¥æœŸè½¬æ¢ï¼‰
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '', raw: true });

              const importedBilling = jsonData.map(row => {
                // å¤„ç†å‘ç”Ÿæ—¥æœŸï¼šå¦‚æœæ˜¯Excelåºåˆ—å·ï¼Œè½¬æ¢ä¸ºæ—¥æœŸæ ¼å¼
                let å‘ç”Ÿæ—¥æœŸ = '';
                const dateValue = row['å‘ç”Ÿæ—¥æœŸ'];
                if (dateValue) {
                  if (typeof dateValue === 'number') {
                    // Excelåºåˆ—å·è½¬æ—¥æœŸ
                    å‘ç”Ÿæ—¥æœŸ = this.formatExcelDate(dateValue);
                  } else if (typeof dateValue === 'string') {
                    // å¦‚æœå·²ç»æ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
                    å‘ç”Ÿæ—¥æœŸ = dateValue.trim();
                  }
                }

                // è¯»å–ç»“ç®—å‘¨æœŸ
                const ç»“ç®—å‘¨æœŸ = String(row['ç»“ç®—å‘¨æœŸ'] || '').trim();

                // è‡ªåŠ¨è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸï¼šæ ¹æ®å‘ç”Ÿæ—¥æœŸå’Œç»“ç®—å‘¨æœŸè®¡ç®—
                let ä¸‹æ¬¡æé†’æ—¥æœŸ = '';
                if (å‘ç”Ÿæ—¥æœŸ && ç»“ç®—å‘¨æœŸ) {
                  ä¸‹æ¬¡æé†’æ—¥æœŸ = this.calculateReminder(å‘ç”Ÿæ—¥æœŸ, ç»“ç®—å‘¨æœŸ);
                }

                return {
                å®¢æˆ·åç§°: String(row['å®¢æˆ·åç§°'] || '').trim(),
                è´¹ç”¨ç±»å‹: String(row['è´¹ç”¨ç±»å‹'] || '').trim(),
                é¢ç§¯: Number(row['é¢ç§¯'] || 0) || 0,
                  ç»“ç®—å‘¨æœŸ: ç»“ç®—å‘¨æœŸ,
                è´¹ç”¨è¯´æ˜: String(row['è´¹ç”¨è¯´æ˜'] || '').trim(),
                  å‘ç”Ÿæ—¥æœŸ: å‘ç”Ÿæ—¥æœŸ,
                é‡‘é¢: Number(row['é‡‘é¢'] || 0) || 0,
                ç»“ç®—çŠ¶æ€: String(row['ç»“ç®—çŠ¶æ€'] || 'å¾…ç»“ç®—').trim(),
                  ä¸‹æ¬¡æé†’æ—¥æœŸ: ä¸‹æ¬¡æé†’æ—¥æœŸ
                };
              }).filter(item => item.å®¢æˆ·åç§° && item.è´¹ç”¨ç±»å‹);

              this.billingRecord.push(...importedBilling);
              
              try {
                localStorage.setItem('billingRecord', JSON.stringify(this.billingRecord));
              } catch (e) {
                console.error('ä¿å­˜è´¹ç”¨æ•°æ®å¤±è´¥:', e);
              }

              alert(`æˆåŠŸå¯¼å…¥ ${importedBilling.length} æ¡è´¹ç”¨æ•°æ®`);
              event.target.value = '';
            } catch (error) {
              console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
              alert('æ–‡ä»¶è§£æå¤±è´¥');
              event.target.value = '';
            }
          };

          reader.readAsArrayBuffer(file);
        },

        // åˆ·æ–°è´¹ç”¨æ•°æ®
        refreshBillingData() {
          try {
            const saved = localStorage.getItem('billingRecord');
            if (saved) {
              this.billingRecord = JSON.parse(saved);
              alert('æ•°æ®å·²åˆ·æ–°');
            }
          } catch (e) {
            console.error('è¯»å–è´¹ç”¨æ•°æ®å¤±è´¥:', e);
          }
        },

        // å¯¼å‡ºè´¹ç”¨ç»“ç®—æ•°æ®åˆ° Excel
        exportBilling() {
          if (!this.filteredBillingRecord || this.filteredBillingRecord.length === 0) {
            alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
            return;
          }

          try {
            // å‡†å¤‡å¯¼å‡ºæ•°æ® - ä½¿ç”¨å½“å‰ç­›é€‰åçš„æ•°æ®
            const exportData = this.filteredBillingRecord.map(item => ({
              'å®¢æˆ·åç§°': item.å®¢æˆ·åç§° || '',
              'è´¹ç”¨ç±»å‹': item.è´¹ç”¨ç±»å‹ || '',
              'é¢ç§¯': item.é¢ç§¯ || 0,
              'ç»“ç®—å‘¨æœŸ': item.ç»“ç®—å‘¨æœŸ || '',
              'å‘ç”Ÿæ—¥æœŸ': item.å‘ç”Ÿæ—¥æœŸ || '',
              'é‡‘é¢': item.é‡‘é¢ || 0,
              'ç»“ç®—çŠ¶æ€': item.ç»“ç®—çŠ¶æ€ || '',
              'ä¸‹æ¬¡æé†’æ—¥æœŸ': item.ä¸‹æ¬¡æé†’æ—¥æœŸ || ''
            }));

            // åˆ›å»ºå·¥ä½œç°¿
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'å®¢æˆ·è´¹ç”¨ç»“ç®—');

            // å¯¼å‡ºæ–‡ä»¶ - æ–‡ä»¶åæ ¼å¼ï¼šå®¢æˆ·è´¹ç”¨ç»“ç®—è¡¨_YYYYMMDD.xlsx
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const fileName = `å®¢æˆ·è´¹ç”¨ç»“ç®—è¡¨_${year}${month}${day}.xlsx`;
            
            XLSX.writeFile(workbook, fileName);
            
            alert(`æˆåŠŸå¯¼å‡º ${exportData.length} æ¡æ•°æ®ï¼`);
          } catch (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
            alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        },

        // ========== ç¼ºé™·ç®¡ç†ç›¸å…³æ–¹æ³• ==========
        // æ‰“å¼€ç™»è®°ç¼ºé™·å¼¹çª—
        openDefectModal() {
          this.newDefect = {
            å‘ç°æ—¥æœŸ: '',
            ç±»å‹: '',
            ç§ç±»: '',
            æ˜¯å¦æŒ‰ç¯: false,
            äº§å“: '',
            é—®é¢˜æè¿°: '',
            å‘ç°äºº: '',
            è´£ä»»äºº: '',
            åŸå› : '',
            è§£å†³æ–¹æ¡ˆ: '',
            '5WHYæ–‡ä»¶': '',
            å¤‡æ³¨: ''
          };
          this.showDefectModal = true;
        },

        // å…³é—­ç™»è®°ç¼ºé™·å¼¹çª—
        closeDefectModal() {
          this.showDefectModal = false;
        },

        // ä¿å­˜ç¼ºé™·
        saveDefect() {
          // ç¡®ä¿å¿…å¡«é¡¹æœ‰é»˜è®¤å€¼
          const defectItem = {
            å‘ç°æ—¥æœŸ: this.newDefect.å‘ç°æ—¥æœŸ || new Date().toISOString().split('T')[0],
            ç±»å‹: this.newDefect.ç±»å‹ || '',
            ç§ç±»: this.newDefect.ç§ç±» || '',
            æ˜¯å¦æŒ‰ç¯: this.newDefect.æ˜¯å¦æŒ‰ç¯ || false,
            äº§å“: this.newDefect.äº§å“ || '',
            é—®é¢˜æè¿°: this.newDefect.é—®é¢˜æè¿° || '',
            å‘ç°äºº: this.newDefect.å‘ç°äºº || '',
            è´£ä»»äºº: this.newDefect.è´£ä»»äºº || '',
            åŸå› : this.newDefect.åŸå›  || '',
            è§£å†³æ–¹æ¡ˆ: this.newDefect.è§£å†³æ–¹æ¡ˆ || '',
            '5WHYæ–‡ä»¶': this.newDefect['5WHYæ–‡ä»¶'] || '',
            å¤‡æ³¨: this.newDefect.å¤‡æ³¨ || ''
          };

          // æ ¡éªŒå¿…å¡«é¡¹
          if (!defectItem.å‘ç°æ—¥æœŸ || !defectItem.ç±»å‹ || !defectItem.ç§ç±» || !defectItem.äº§å“ || !defectItem.é—®é¢˜æè¿°) {
            alert('è¯·å¡«å†™å¿…å¡«é¡¹ï¼ˆå‘ç°æ—¥æœŸã€ç±»å‹ã€ç§ç±»ã€äº§å“ã€é—®é¢˜æè¿°ï¼‰');
            return;
          }

          this.defectList.push(defectItem);

          try {
            localStorage.setItem('defectList', JSON.stringify(this.defectList));
          } catch (e) {
            console.error('ä¿å­˜ç¼ºé™·æ•°æ®å¤±è´¥:', e);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            return;
          }

          alert('ç™»è®°æˆåŠŸ');
          this.closeDefectModal();
        },

        // å¤„ç†5WHYæ–‡ä»¶ä¸Šä¼ 
        handle5WhyFileUpload(event) {
          const file = event.target.files[0];
          if (file) {
            // æ¨¡æ‹Ÿä¸Šä¼ ï¼šå°†æ–‡ä»¶åä¿å­˜åˆ° five_why_file å­—æ®µ
            if (this._editingDefectItem) {
              // å¦‚æœæ˜¯ä»åˆ—è¡¨ä¸­ç‚¹å‡»"å¾…ä¸Šä¼ "è§¦å‘çš„ï¼Œæ›´æ–°åˆ—è¡¨ä¸­çš„é¡¹
              const index = this.defectList.findIndex(d => d === this._editingDefectItem);
              if (index !== -1) {
                this.defectList[index]['5WHYæ–‡ä»¶'] = file.name;
          try {
            localStorage.setItem('defectList', JSON.stringify(this.defectList));
          } catch (e) {
            console.error('ä¿å­˜ç¼ºé™·æ•°æ®å¤±è´¥:', e);
          }
                alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
              }
              this._editingDefectItem = null;
            } else {
              // å¦‚æœæ˜¯æ–°å¢/ç¼–è¾‘å¼¹çª—ä¸­çš„ä¸Šä¼ ï¼Œæ›´æ–° newDefect
              this.newDefect['5WHYæ–‡ä»¶'] = file.name;
            }
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼Œå…è®¸é‡å¤é€‰æ‹©
            event.target.value = '';
          }
        },

        // ä¸Šä¼ 5WHYæ–‡ä»¶ï¼ˆç”¨äºåˆ—è¡¨ä¸­çš„"å¾…ä¸Šä¼ "ç‚¹å‡»ï¼‰
        upload5WhyFile(item) {
          // åˆ›å»ºä¸´æ—¶æ–‡ä»¶è¾“å…¥æ¡†ç”¨äºåˆ—è¡¨ä¸­çš„ä¸Šä¼ 
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.pdf';
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              // æ›´æ–°åˆ—è¡¨ä¸­çš„é¡¹
              const index = this.defectList.findIndex(d => d === item);
              if (index !== -1) {
                this.defectList[index]['5WHYæ–‡ä»¶'] = file.name;
                try {
                  localStorage.setItem('defectList', JSON.stringify(this.defectList));
                } catch (e) {
                  console.error('ä¿å­˜ç¼ºé™·æ•°æ®å¤±è´¥:', e);
                }
                alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
              }
            }
          };
          input.click();
        },

        // è·å–ç¼ºé™·æŒç»­æ—¶é—´æ ·å¼ç±»
        getDefectDurationClass(item) {
          const foundDate = new Date(item.å‘ç°æ—¥æœŸ);
          const today = new Date();
          const diffDays = Math.floor((today - foundDate) / (1000 * 60 * 60 * 24));
          
          if (diffDays > 3) {
            return 'text-red-600 font-bold';
          }
          return 'text-gray-800';
        },

        // æŸ¥çœ‹ 5WHY æŠ¥å‘Š
        view5WhyReport(fileName) {
          alert(`5WHY æŠ¥å‘Šï¼š${fileName}\n\nï¼ˆå®é™…åº”ç”¨ä¸­åº”æ‰“å¼€æ–‡ä»¶æŸ¥çœ‹ï¼‰`);
        },

        // è§¦å‘ç¼ºé™·å¯¼å…¥
        triggerDefectImport() {
          if (this.$refs.defectFileInput) {
            this.$refs.defectFileInput.click();
          }
        },

        // å¤„ç†ç¼ºé™·å¯¼å…¥
        handleDefectImport(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

              // è°ƒè¯•ï¼šè¾“å‡ºç¬¬ä¸€è¡Œæ•°æ®ï¼ŒæŸ¥çœ‹çœŸå®çš„è¡¨å¤´
              if (jsonData.length > 0) {
                console.log('ç¬¬ä¸€è¡ŒåŸå§‹æ•°æ®:', jsonData[0]);
                console.log('æ‰€æœ‰è¡¨å¤´:', Object.keys(jsonData[0]));
              }

              const importedDefects = jsonData.map((row, index) => {
                // æŒ‰ç¯çŠ¶æ€è¯†åˆ«ï¼šè¯»å–"æŒ‰ç¯"æˆ–"æ˜¯å¦æŒ‰ç¯"è¡¨å¤´
                let æ˜¯å¦æŒ‰ç¯ = false;
                // å°è¯•å¤šç§å¯èƒ½çš„è¡¨å¤´åç§°ï¼ˆåŒ…æ‹¬å¯èƒ½çš„ç©ºæ ¼å˜ä½“ï¼‰
                const andonValue = row['æŒ‰ç¯'] || row['æ˜¯å¦æŒ‰ç¯'] || row['æŒ‰ç¯çŠ¶æ€'] || 
                                   row['æŒ‰ç¯ '] || row[' æŒ‰ç¯'] || row['æ˜¯å¦æŒ‰ç¯ '] || row[' æ˜¯å¦æŒ‰ç¯'] || '';
                
                if (andonValue !== '' && andonValue !== null && andonValue !== undefined) {
                  const andonStr = String(andonValue).trim();
                  // å¦‚æœå•å…ƒæ ¼å†…å®¹åŒ…å«"æ˜¯"ã€"Yes"æˆ–"TRUE"ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼Œè®¾ä¸ºtrue
                  const andonLower = andonStr.toLowerCase();
                  // æ›´ä¸¥æ ¼çš„åˆ¤æ–­ï¼šå®Œå…¨åŒ¹é…"æ˜¯"æˆ–åŒ…å«"æ˜¯"
                  if (andonLower === 'æ˜¯' || andonLower.includes('æ˜¯') || 
                      andonLower === 'yes' || andonLower === 'true' || 
                      andonLower === '1' || andonStr === 'æ˜¯') {
                    æ˜¯å¦æŒ‰ç¯ = true;
                  }
                }
                
                // è°ƒè¯•ï¼šè¾“å‡ºæŒ‰ç¯çŠ¶æ€è¯†åˆ«ç»“æœ
                if (index < 3) {
                  console.log(`ç¬¬${index + 1}è¡Œ - æŒ‰ç¯åŸå§‹å€¼:`, andonValue, 'ç±»å‹:', typeof andonValue, 'è¯†åˆ«ç»“æœ:', æ˜¯å¦æŒ‰ç¯);
                }

                // 5WHYæŠ¥å‘Šï¼šè¯»å–"5WHYåˆ†æ"æˆ–"5WHY"è¡¨å¤´
                const fiveWhyValue = row['5WHYåˆ†æ'] || row['5WHY'] || row['5WHYæ–‡ä»¶'] || '';
                const fiveWhyFile = String(fiveWhyValue).trim();

                return {
                  å‘ç°æ—¥æœŸ: String(row['å‘ç°æ—¥æœŸ'] || '').trim() || new Date().toISOString().split('T')[0],
                ç±»å‹: String(row['ç±»å‹'] || '').trim(),
                ç§ç±»: String(row['ç§ç±»'] || '').trim(),
                  æ˜¯å¦æŒ‰ç¯: æ˜¯å¦æŒ‰ç¯,
                äº§å“: String(row['äº§å“'] || '').trim(),
                é—®é¢˜æè¿°: String(row['é—®é¢˜æè¿°'] || '').trim(),
                å‘ç°äºº: String(row['å‘ç°äºº'] || '').trim(),
                è´£ä»»äºº: String(row['è´£ä»»äºº'] || '').trim(),
                åŸå› : String(row['åŸå› '] || '').trim(),
                è§£å†³æ–¹æ¡ˆ: String(row['è§£å†³æ–¹æ¡ˆ'] || '').trim(),
                  '5WHYæ–‡ä»¶': fiveWhyFile,
                å¤‡æ³¨: String(row['å¤‡æ³¨'] || '').trim()
                };
              }).filter(item => item.å‘ç°æ—¥æœŸ && item.ç±»å‹);

              this.defectList.push(...importedDefects);
              
              try {
                localStorage.setItem('defectList', JSON.stringify(this.defectList));
              } catch (e) {
                console.error('ä¿å­˜ç¼ºé™·æ•°æ®å¤±è´¥:', e);
              }

              alert(`æˆåŠŸå¯¼å…¥ ${importedDefects.length} æ¡ç¼ºé™·æ•°æ®`);
              event.target.value = '';
            } catch (error) {
              console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
              alert('æ–‡ä»¶è§£æå¤±è´¥');
              event.target.value = '';
            }
          };

          reader.readAsArrayBuffer(file);
        },

        // åˆ·æ–°ç¼ºé™·æ•°æ®
        refreshDefectData() {
          try {
            const saved = localStorage.getItem('defectList');
            if (saved) {
              this.defectList = JSON.parse(saved);
              alert('æ•°æ®å·²åˆ·æ–°');
            }
          } catch (e) {
            console.error('è¯»å–ç¼ºé™·æ•°æ®å¤±è´¥:', e);
          }
        },

        // ========== è½¦æ¬¡ç®¡ç†ç›¸å…³æ–¹æ³• ==========
        // æ‰“å¼€ç™»è®°è½¦æ¬¡å¼¹çª—
        openVehicleModal() {
          this.newVehicleLog = {
            æ—¥æœŸ: '',
            æ—¶é—´: '',
            è½¦å‹: '',
            å¸æœºå§“å: '',
            å®¢æˆ·åç§°: '',
            å®¢æˆ·ç­¾æ”¶äºº: '',
            å†…å®¹: '',
            å¤‡æ³¨: ''
          };
          this.showVehicleModal = true;
        },

        // å…³é—­ç™»è®°è½¦æ¬¡å¼¹çª—
        closeVehicleModal() {
          this.showVehicleModal = false;
        },

        // ä¿å­˜è½¦æ¬¡
        saveVehicleLog() {
          if (!this.newVehicleLog.æ—¥æœŸ || !this.newVehicleLog.æ—¶é—´ || !this.newVehicleLog.è½¦å‹ || !this.newVehicleLog.å¸æœºå§“å || !this.newVehicleLog.å®¢æˆ·åç§° || !this.newVehicleLog.å†…å®¹) {
            alert('è¯·å¡«å†™å¿…å¡«é¡¹');
            return;
          }

          this.vehicleLog.push({ ...this.newVehicleLog });

          try {
            localStorage.setItem('vehicleLogData', JSON.stringify(this.vehicleLog));
          } catch (e) {
            console.error('ä¿å­˜è½¦æ¬¡æ•°æ®å¤±è´¥:', e);
          }

          alert('è½¦æ¬¡ç™»è®°æˆåŠŸ');
          this.closeVehicleModal();
        },

        // åˆ é™¤è½¦æ¬¡è®°å½•
        deleteVehicleRecord(index) {
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
            this.vehicleLog.splice(index, 1);
            try {
              localStorage.setItem('vehicleLogData', JSON.stringify(this.vehicleLog));
            } catch (e) {
              console.error('ä¿å­˜è½¦æ¬¡æ•°æ®å¤±è´¥:', e);
            }
            alert('åˆ é™¤æˆåŠŸ');
          }
        },

        // è§¦å‘è½¦æ¬¡å¯¼å…¥
        triggerVehicleImport() {
          if (this.$refs.vehicleLogFileInput) {
            this.$refs.vehicleLogFileInput.click();
          }
        },

        // å¤„ç†è½¦æ¬¡å¯¼å…¥
        handleVehicleImport(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: '' });

              const importedVehicles = jsonData.map(row => ({
                æ—¥æœŸ: this.formatExcelDate(row['æ—¥æœŸ'] || ''),
                æ—¶é—´: this.formatExcelTime(row['æ—¶é—´'] || ''),
                è½¦å‹: String(row['è½¦å‹'] || '').trim(),
                å¸æœºå§“å: String(row['å¸æœºå§“å'] || '').trim(),
                å®¢æˆ·åç§°: String(row['å®¢æˆ·åç§°'] || '').trim(),
                å®¢æˆ·ç­¾æ”¶äºº: String(row['å®¢æˆ·ç­¾æ”¶äºº'] || '').trim(),
                å†…å®¹: String(row['å†…å®¹'] || '').trim(),
                å¤‡æ³¨: String(row['å¤‡æ³¨'] || '').trim()
              })).filter(item => item.æ—¥æœŸ && item.æ—¥æœŸ !== '--' && item.æ—¶é—´ && item.æ—¶é—´ !== '--');

              this.vehicleLog.push(...importedVehicles);
              
              try {
                localStorage.setItem('vehicleLogData', JSON.stringify(this.vehicleLog));
              } catch (e) {
                console.error('ä¿å­˜è½¦æ¬¡æ•°æ®å¤±è´¥:', e);
              }

              alert(`æˆåŠŸå¯¼å…¥ ${importedVehicles.length} æ¡è½¦æ¬¡æ•°æ®`);
              event.target.value = '';
            } catch (error) {
              console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
              alert('æ–‡ä»¶è§£æå¤±è´¥');
              event.target.value = '';
            }
          };

          reader.readAsArrayBuffer(file);
        },

        // å¯¼å‡ºè½¦æ¬¡æ•°æ®
        exportVehicleLogToExcel() {
          const dataToExport = this.filteredVehicleLog.map(item => ({
            'æ—¥æœŸ': item.æ—¥æœŸ || '',
            'æ—¶é—´': item.æ—¶é—´ || '',
            'è½¦å‹': item.è½¦å‹ || '',
            'å¸æœºå§“å': item.å¸æœºå§“å || '',
            'å®¢æˆ·åç§°': item.å®¢æˆ·åç§° || '',
            'å®¢æˆ·ç­¾æ”¶äºº': item.å®¢æˆ·ç­¾æ”¶äºº || '',
            'å†…å®¹': item.å†…å®¹ || '',
            'å¤‡æ³¨': item.å¤‡æ³¨ || ''
          }));

          const ws = XLSX.utils.json_to_sheet(dataToExport);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'è½¦æ¬¡ç®¡ç†');
          XLSX.writeFile(wb, `è½¦æ¬¡ç®¡ç†_${new Date().toISOString().split('T')[0]}.xlsx`);
        },

        // åˆ·æ–°è½¦æ¬¡æ•°æ®
        refreshVehicleData() {
          try {
            const saved = localStorage.getItem('vehicleLogData');
            if (saved) {
              this.vehicleLog = JSON.parse(saved);
              alert('æ•°æ®å·²åˆ·æ–°');
            }
          } catch (e) {
            console.error('è¯»å–è½¦æ¬¡æ•°æ®å¤±è´¥:', e);
          }
        },

        // ========== åˆ°è´§å¼‚å¸¸ç®¡ç†ç›¸å…³æ–¹æ³• ==========
        // æ‰“å¼€ç™»è®°å¼‚å¸¸å¼¹çª—
        openDiscrepancyModal() {
          this.newDiscrepancy = {
            supplier: '',
            date: '',
            po: '',
            material: '',
            line_no: '',
            qty: '',
            is_bonded: false,
            category: 'ç³»ç»Ÿé—®é¢˜',
            description: '',
            photos: [],
            status: 'å¾…å¤„ç†',
            result: ''
          };
          this.showDiscrepancyModal = true;
        },

        // å…³é—­ç™»è®°å¼‚å¸¸å¼¹çª—
        closeDiscrepancyModal() {
          this.showDiscrepancyModal = false;
        },

        // ä¿å­˜å¼‚å¸¸
        saveDiscrepancy() {
          if (!this.newDiscrepancy.supplier || !this.newDiscrepancy.date || !this.newDiscrepancy.po || !this.newDiscrepancy.material || !this.newDiscrepancy.description) {
            alert('è¯·å¡«å†™å¿…å¡«é¡¹');
            return;
          }

          const discrepancy = {
            report_id: `W-${new Date().getFullYear()}-${String(this.discrepancyList.length + 1).padStart(4, '0')}`,
            ...this.newDiscrepancy,
            duration: 0
          };

          this.discrepancyList.push(discrepancy);

          try {
            localStorage.setItem('discrepancyList', JSON.stringify(this.discrepancyList));
          } catch (e) {
            console.error('ä¿å­˜å¼‚å¸¸æ•°æ®å¤±è´¥:', e);
          }

          alert('å¼‚å¸¸ç™»è®°æˆåŠŸ');
          this.closeDiscrepancyModal();
        },

        // å¤„ç†å¼‚å¸¸
        handleDiscrepancy(item, index) {
          this.currentDiscrepancyItem = { ...item, index };
          this.discrepancyHandleResult = item.result || '';
          this.discrepancyHandleStatus = item.status || 'å¤„ç†ä¸­';
          this.showDiscrepancyDetailModal = true;
        },

        // ä¿å­˜å¼‚å¸¸å¤„ç†ç»“æœ
        saveDiscrepancyHandle() {
          if (!this.discrepancyHandleResult) {
            alert('è¯·è¾“å…¥å¤„ç†ç»“æœ');
            return;
          }

          const item = this.currentDiscrepancyItem;
          const index = item.index;
          
          this.discrepancyList[index].result = this.discrepancyHandleResult;
          this.discrepancyList[index].status = this.discrepancyHandleStatus;
          
          if (this.discrepancyHandleStatus === 'å·²é—­ç¯') {
            const startDate = new Date(item.date);
            const endDate = new Date();
            this.discrepancyList[index].duration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
          }

          try {
            localStorage.setItem('discrepancyList', JSON.stringify(this.discrepancyList));
          } catch (e) {
            console.error('ä¿å­˜å¼‚å¸¸æ•°æ®å¤±è´¥:', e);
          }

          alert('å¤„ç†ç»“æœå·²ä¿å­˜');
          this.closeDiscrepancyDetailModal();
        },

        // æŸ¥çœ‹å¼‚å¸¸è¯¦æƒ…
        viewDiscrepancyDetail(item) {
          alert(`å¼‚å¸¸ç¼–å·ï¼š${item.report_id}\n\nä¾›åº”å•†ï¼š${item.supplier}\næ—¥æœŸï¼š${item.date}\nPOå·ï¼š${item.po}\nç‰©æ–™ï¼š${item.material}\næ•°é‡ï¼š${item.qty}\nåˆ†ç±»ï¼š${item.category}\næè¿°ï¼š${item.description}\nçŠ¶æ€ï¼š${item.status}\nå¤„ç†ç»“æœï¼š${item.result || 'æ— '}`);
        },

        // å…³é—­å¼‚å¸¸è¯¦æƒ…å¼¹çª—
        closeDiscrepancyDetailModal() {
          this.showDiscrepancyDetailModal = false;
          this.currentDiscrepancyItem = null;
          this.discrepancyHandleResult = '';
          this.discrepancyHandleStatus = 'å¤„ç†ä¸­';
        },

        // è·å–å¼‚å¸¸å¤„ç†æ—¶é•¿
        getDiscrepancyDuration(item) {
          if (item.duration !== undefined) {
            return item.duration;
          }
          if (item.status === 'å·²é—­ç¯' && item.date) {
            const startDate = new Date(item.date);
            const endDate = new Date();
            return Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
          }
          if (item.date) {
            const startDate = new Date(item.date);
            const today = new Date();
            return Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
          }
          return 0;
        },

        // è§¦å‘å¼‚å¸¸å¯¼å…¥
        triggerDiscrepancyImport() {
          if (this.$refs.discrepancyFileInput) {
            this.$refs.discrepancyFileInput.click();
          }
        },

        // å¤„ç†å¼‚å¸¸å¯¼å…¥
        handleDiscrepancyImport(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: '' });

              console.log('è¯»å–åˆ°çš„åŸå§‹åˆ°è´§å¼‚å¸¸æ•°æ®:', jsonData);
              if (jsonData.length > 0) {
                console.log('ç¬¬ä¸€è¡ŒåŸå§‹æ•°æ®:', jsonData[0]);
                console.log('æ‰€æœ‰è¡¨å¤´:', Object.keys(jsonData[0]));
              }

              const importedDiscrepancies = jsonData.map((row, idx) => {
                // å¤„ç†æ—¥æœŸï¼šæ”¯æŒ"åˆ°è´§æ—¥æœŸ"æˆ–"æ—¥æœŸ"ï¼Œå¹¶è½¬æ¢Excelåºåˆ—å·
                const dateRaw = row['åˆ°è´§æ—¥æœŸ'] || row['æ—¥æœŸ'] || '';
                const dateValue = this.formatExcelDate(dateRaw);

                // å¤„ç†æ˜¯å¦ä¿ç¨ï¼šæ”¯æŒ"æ˜¯å¦ä¿ç¨"æˆ–"ä¿ç¨"
                const bondedRaw = row['æ˜¯å¦ä¿ç¨'] || row['ä¿ç¨'] || '';
                let isBonded = false;
                if (bondedRaw !== '' && bondedRaw !== null && bondedRaw !== undefined) {
                  const bondedStr = String(bondedRaw).trim();
                  if (bondedStr === 'æ˜¯' || bondedStr.toLowerCase() === 'yes' || bondedRaw === true) {
                    isBonded = true;
                  }
                }

                return {
                  report_id: String(row['æŠ¥å‘Šç¼–å·'] || row['ç¼–å·'] || row['report_id'] || `W-${new Date().getFullYear()}-${String(idx + 1).padStart(4, '0')}`).trim(),
                supplier: String(row['ä¾›åº”å•†'] || '').trim(),
                  date: dateValue,
                po: String(row['POå·'] || row['PO'] || '').trim(),
                  material: String(row['ç‰©æ–™å·'] || row['ç‰©æ–™'] || '').trim(),
                line_no: String(row['è¡Œå·'] || '').trim(),
                qty: Number(row['æ•°é‡'] || 0) || 0,
                  is_bonded: isBonded,
                  category: String(row['é—®é¢˜åˆ†ç±»'] || row['å¼‚å¸¸åˆ†ç±»'] || row['åˆ†ç±»'] || 'ç³»ç»Ÿé—®é¢˜').trim(),
                description: String(row['æè¿°'] || '').trim(),
                photos: [],
                status: String(row['çŠ¶æ€'] || 'å¾…å¤„ç†').trim(),
                result: String(row['å¤„ç†ç»“æœ'] || '').trim(),
                duration: 0
                };
              }).filter(item => item.supplier && item.date && item.date !== '--');

              this.discrepancyList = importedDiscrepancies;
              
              try {
                localStorage.setItem('discrepancyList', JSON.stringify(this.discrepancyList));
              } catch (e) {
                console.error('ä¿å­˜å¼‚å¸¸æ•°æ®å¤±è´¥:', e);
              }

              alert(`æˆåŠŸå¯¼å…¥ ${this.discrepancyList.length} æ¡å¼‚å¸¸æ•°æ®`);
              event.target.value = '';
            } catch (error) {
              console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
              alert('æ–‡ä»¶è§£æå¤±è´¥');
              event.target.value = '';
            }
          };

          reader.readAsArrayBuffer(file);
        },

        // å¯¼å‡ºå¼‚å¸¸æ•°æ®
        exportDiscrepancyToExcel() {
          const dataToExport = this.filteredDiscrepancyList.map(item => ({
            'ç¼–å·': item.report_id || '',
            'æ—¥æœŸ': item.date || '',
            'ä¾›åº”å•†': item.supplier || '',
            'è¡Œå·': item.line_no || '',
            'ç‰©æ–™': item.material || '',
            'æ•°é‡': item.qty || 0,
            'å¼‚å¸¸åˆ†ç±»': item.category || '',
            'æè¿°': item.description || '',
            'ä¿ç¨': item.is_bonded ? 'æ˜¯' : 'å¦',
            'çŠ¶æ€': item.status || '',
            'å¤„ç†ç»“æœ': item.result || '',
            'å¤„ç†æ—¶é•¿': `${item.duration || 0} å¤©`
          }));

          const ws = XLSX.utils.json_to_sheet(dataToExport);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'åˆ°è´§å¼‚å¸¸ç®¡ç†');
          XLSX.writeFile(wb, `åˆ°è´§å¼‚å¸¸ç®¡ç†_${new Date().toISOString().split('T')[0]}.xlsx`);
        },

        // åˆ·æ–°å¼‚å¸¸æ•°æ®
        refreshDiscrepancyData() {
          try {
            const saved = localStorage.getItem('discrepancyList');
            if (saved) {
              this.discrepancyList = JSON.parse(saved);
              alert('æ•°æ®å·²åˆ·æ–°');
            }
          } catch (e) {
            console.error('è¯»å–å¼‚å¸¸æ•°æ®å¤±è´¥:', e);
          }
        }
      },

      watch: {
        currentMenu(newVal) {
          // åˆ‡æ¢åˆ°ç»è¥æŠ¥è¡¨æ—¶åˆå§‹åŒ–å›¾è¡¨ï¼ˆéœ€è¦æ£€æŸ¥ ECharts æ˜¯å¦å·²åŠ è½½ï¼‰
          if (newVal === 'dashboard' && typeof echarts !== 'undefined') {
            this.$nextTick(() => {
              this.initCharts();
            });
          }
        }
      },

      mounted() {
        console.log('Dashboard V2 å·²åŠ è½½');
        console.log('å½“å‰ç”¨æˆ·:', this.currentUser);
        console.log('å¯è§èœå•:', this.filteredMenuItems);
        
        // æ£€æŸ¥ localStorage æ˜¯å¦å¯ç”¨
        if (!localStorageAvailable) {
          console.warn('localStorage ä¸å¯ç”¨ï¼Œæ•°æ®å°†æ— æ³•ä¿å­˜å’ŒåŠ è½½');
          return;
        }
        
        // åŠ è½½å‡æœŸæ•°æ®
        this.loadHolidays();
        
        // ä» localStorage åŠ è½½ç”Ÿäº§è®¡åˆ’æ•°æ®
        try {
          const saved = safeLocalStorage.getItem('productionPlanData');
          if (saved) {
            this.productionPlanData = JSON.parse(saved);
            console.log('å·²åŠ è½½ç”Ÿäº§è®¡åˆ’æ•°æ®:', this.productionPlanData.length, 'æ¡');
          }
        } catch (e) {
          console.error('è¯»å–ç”Ÿäº§è®¡åˆ’æ•°æ®å¤±è´¥:', e);
          this.productionPlanData = [];
        }
        
        // å¦‚æœå½“å‰æ˜¯ç»è¥æŠ¥è¡¨ï¼Œåˆå§‹åŒ–å›¾è¡¨ï¼ˆéœ€è¦æ£€æŸ¥ ECharts æ˜¯å¦å·²åŠ è½½ï¼‰
        if (this.currentMenu === 'dashboard' && typeof echarts !== 'undefined') {
          this.$nextTick(() => {
            this.initCharts();
          });
        }
        
        // ä» localStorage åŠ è½½ ECO æ•°æ®
        try {
          const savedEco = safeLocalStorage.getItem('ecoList');
          if (savedEco) {
            this.ecoList = JSON.parse(savedEco);
            console.log('å·²åŠ è½½ ECO æ•°æ®:', this.ecoList.length, 'æ¡');
          }
        } catch (e) {
          console.error('è¯»å– ECO æ•°æ®å¤±è´¥:', e);
          this.ecoList = [];
        }
        
        // ä» localStorage åŠ è½½ä¾›åº”å•†æ”¶è´§ç›‘æ§æ•°æ®
        try {
          const savedReceiving = safeLocalStorage.getItem('receivingTasks');
          if (savedReceiving) {
            this.receivingTasks = JSON.parse(savedReceiving);
            // å…¼å®¹æ€§å¤„ç†ï¼šå°†æ—§æ•°æ®æ ¼å¼è½¬æ¢ä¸ºæ–°æ ¼å¼
            this.receivingTasks.forEach(task => {
              // å¦‚æœå­˜åœ¨æ—§çš„ system_linesï¼Œè½¬æ¢ä¸ºæ–°çš„ system_data æ ¼å¼
              if (task.system_lines !== undefined && !task.system_data) {
                task.system_data = {
                  total: task.system_lines || 0,
                  logs: []
                };
                // ä¿ç•™æ—§å­—æ®µä»¥å…¼å®¹ï¼ˆå¯é€‰ï¼‰
                // delete task.system_lines;
              }
              // å¦‚æœ system_data ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–
              if (!task.system_data) {
                task.system_data = {
                  total: 0,
                  logs: []
                };
              }
              // å¦‚æœ is_closed ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ä¸º false
              if (task.is_closed === undefined) {
                task.is_closed = false;
              }
            });
          }
        } catch (e) {
          console.error('è¯»å–æ”¶è´§ä»»åŠ¡æ•°æ®å¤±è´¥:', e);
          this.receivingTasks = [];
        }
        
        // ä» localStorage åŠ è½½ä¾›åº”å•†æ˜ å°„
        try {
          const savedSupplierMap = safeLocalStorage.getItem('supplierMap');
          if (savedSupplierMap) {
            this.supplierMap = JSON.parse(savedSupplierMap);
          }
        } catch (e) {
          console.error('è¯»å–ä¾›åº”å•†æ˜ å°„å¤±è´¥:', e);
          this.supplierMap = {};
        }
        
        // ä» localStorage åŠ è½½åˆ°è´§ç™»è®°æ•°æ®
        try {
          const savedArrival = safeLocalStorage.getItem('arrivalLogData');
          if (savedArrival) {
            this.arrivalLog = JSON.parse(savedArrival);
            // å…¼å®¹æ€§å¤„ç†ï¼šç¡®ä¿æ¯ä¸ªè®°å½•éƒ½æœ‰ system_data å’Œ is_closed å­—æ®µ
            this.arrivalLog.forEach(arrival => {
              if (!arrival.system_data) {
                arrival.system_data = {
                  total: arrival.system_lines || 0,
                  logs: []
                };
              }
              if (arrival.is_closed === undefined) {
                arrival.is_closed = false;
              }
            });
          }
        } catch (e) {
          console.error('è¯»å–åˆ°è´§ç™»è®°æ•°æ®å¤±è´¥:', e);
          this.arrivalLog = [];
        }
        
        // ä» localStorage åŠ è½½ä¾›åº”å•†åç§°å†å²
        try {
          const savedSupplierNames = safeLocalStorage.getItem('savedSupplierNames');
          if (savedSupplierNames) {
            this.savedSupplierNames = JSON.parse(savedSupplierNames);
          }
        } catch (e) {
          console.error('è¯»å–ä¾›åº”å•†åç§°åˆ—è¡¨å¤±è´¥:', e);
          this.savedSupplierNames = [];
        }
        
        // ä» localStorage åŠ è½½å®¢æˆ·è´¹ç”¨ç»“ç®—æ•°æ®
        try {
          const savedBilling = safeLocalStorage.getItem('billingRecord');
          if (savedBilling) {
            this.billingRecord = JSON.parse(savedBilling);
          }
        } catch (e) {
          console.error('è¯»å–è´¹ç”¨æ•°æ®å¤±è´¥:', e);
          this.billingRecord = [];
        }
        
        // ä» localStorage åŠ è½½ç¼ºé™·ç®¡ç†æ•°æ®
        try {
          const savedDefect = safeLocalStorage.getItem('defectList');
          if (savedDefect) {
            this.defectList = JSON.parse(savedDefect);
          }
        } catch (e) {
          console.error('è¯»å–ç¼ºé™·æ•°æ®å¤±è´¥:', e);
          this.defectList = [];
        }
        
        // ä» localStorage åŠ è½½è½¦æ¬¡ç®¡ç†æ•°æ®
        try {
          const savedVehicle = safeLocalStorage.getItem('vehicleLogData');
          if (savedVehicle) {
            this.vehicleLog = JSON.parse(savedVehicle);
          }
        } catch (e) {
          console.error('è¯»å–è½¦æ¬¡æ•°æ®å¤±è´¥:', e);
          this.vehicleLog = [];
        }
        
        // ä» localStorage åŠ è½½åˆ°è´§å¼‚å¸¸ç®¡ç†æ•°æ®
        try {
          const savedDiscrepancy = safeLocalStorage.getItem('discrepancyList');
          if (savedDiscrepancy) {
            this.discrepancyList = JSON.parse(savedDiscrepancy);
          }
        } catch (e) {
          console.error('è¯»å–å¼‚å¸¸æ•°æ®å¤±è´¥:', e);
          this.discrepancyList = [];
        }
      }
    });

    // æŒ‚è½½ Vue å®ä¾‹
    app.mount('#app');
  </script>
</body>
</html>

